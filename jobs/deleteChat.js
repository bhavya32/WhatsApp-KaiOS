"use strict";(self.webpackJsonp=self.webpackJsonp||[]).push([[84],{729:function(e,r,t){t.r(r),t.d(r,"deleteChatJob",(function(){return O})),t.d(r,"clearChatJob",(function(){return k})),t.d(r,"deleteChatContentsJob",(function(){return T}));var n=t(8),l=t.n(n),u=t(36),a=t(58),i=t(5),d=t(15),o=t(32),v=t(7),c=t(20),s=t(10),f=t(49),h=t(70),_=t(12),g=t(91),p=t(250),C=t(46),I=t(79),m=t(187),b=t(184),w=t(237);function y(e,r){return`__temporary${"message"===e?1:"beginning"===e?0:2}__${r||""}`}var $=t(88),G=t(39),L=t(16),O=(0,$.c)().finalStep("deleteChatInfo",e=>{var r=e.chatId,t=e.retainMediaInPhoneStorage;return(function(e){return(0,s.c)("deleteChatInfo",r=>(function(e,r){return e.table.transact("rw",["groups","groupParticipantsInfo","chats","contacts","privacyTokens"],()=>e.table.stores.chats.get(r).then(t=>{if(t){var n=(0,v.x)(t.jid,{user:r=>{var n=(0,p.a)(e,r),l=e.table.stores.contacts.get(r).then(r=>{var n;if(r)return delete r.chatId,r.lastMutedUntil=null!=t.mutedUntil?t.mutedUntil:void 0,null!=(null==(n=r.ephemeral)?void 0:n.initiator)&&delete r.ephemeral.initiator,e.table.stores.contacts.put(r)});return(0,i.c)([n,l])},group:r=>e.table.stores.groups.delete(r)}),l=e.table.stores.chats.delete(t.id);return(0,i.c)([n,l]).then(()=>t)}__LOG__(3)`Tried to delete chat, but was not found ${r}`}))})(r,e),r=>{r&&((0,h.getProfilePicTable)().deleteRecord(r.jid),(0,_.c)("event","chatDeleted",{chatId:e}))})})(r).then(()=>(0,G.b)().waitUntilPersisted(L.e.deleteChatContents(r,t)))}).end(),k=(0,$.c)().finalStep("clearChatInfo",e=>{var r=e.chatId,t=e.retainMediaInPhoneStorage,n=e.keepStarredMessages;return(function(e,r){var t=["chats","msgs","contacts","groups","groupParticipantsInfo"];return(0,s.c)("clearChatInfo",n=>(0,C.a)(n.table,"rw",t,t=>(function(e,r,t){var n=(0,u.b)(r),d=(0,u.e)(r),o=t?(0,u.x)(e,n,d):(0,i.e)((0,c.e)());return(0,i.c)([o,e.chats.get(r)]).then(n=>{var a=l()(n,2),d=a[0],o=a[1];if(o){var c=o.newest;if(null!=c){var s=d.length;return __LOG__(2)`Clearing chat ${r} with ${s} msgs`,(function(e,r,t){var n=(0,u.b)(r),a=(0,u.e)(r);return(0,i.f)([()=>e.msgs.where("id").anyOf(t).modify(e=>{e.id=y("message",e.id)}),()=>e.msgs.where("id").between(n,a,!1,!1).delete(),()=>e.msgs.where("id").between(y("beginning"),y("ending"),!1,!1).modify(e=>{e.id=e.id.replace("__temporary1__","")})]).then(e=>{var r=l()(e,2);return r[0],r[1]})})(e,o.id,d).then(r=>(s>0?(0,u.r)(e,d[0]).then(e=>null==e?void 0:e.ts):(0,i.e)()).then(r=>(0,v.x)(o.jid,{user:r=>(0,u.l)(e,r).then(e=>{var t,n,l,u=e||{jid:r},a=null==(t=u.ephemeral)?void 0:t.expiration;return{type:"one-to-one",dbContact:u,initialExpiration:null==a||0===a?"persisted":{initiator:null!=(n=null==(l=u.ephemeral)?void 0:l.initiator)?n:g.a.CHANGED_IN_CHAT,expiration:a}}}),group:r=>(0,u.p)(e,r).then(e=>{var r=null==e?void 0:e.expiration;return{type:"group",initialExpiration:null==r||0===r?"persisted":r}})}).then(t=>(function(e,r){return delete r.oldest,delete r.newest,(0,u.D)(e,r).then(()=>r)})(e,o).then(n=>(0,I.a)(e,t,n,{oldestStarredTs:r})))).then(n=>{var u=l()(n,1)[0];return u.lastClearCut=c,u.msgCount-=r,delete u.previewMsg,delete u.oldestUnread,-1!==u.unreadMsgCount&&(u.unreadMsgCount=0),delete u.importantMsgCount,t&&0!==s?(function(e,r){if(0===r.length)return(0,i.e)(0);var t=0;return e.msgs.where("id").anyOf(r).modify(e=>{var r;null!=(null==(r=e.keptInfo)?void 0:r.kept)&&t++}).then(()=>t)})(e,d).then(r=>{var t=d[0],n=d[d.length-1];return r>0?u.keptMsgCount=r:delete u.keptMsgCount,(null==u.newest||n>u.newest)&&(u.newest=n),(null==u.oldest||t<u.oldest)&&(u.oldest=t),void 0===u.newest?u:(0,w.a)(e,u.id).then(e=>(null==e?delete u.previewMsg:u.previewMsg=e,u))}):(delete u.starredMsgCount,delete u.keptMsgCount,u)}).then(r=>(0,u.D)(e,r).then(()=>r)))}__LOG__(2)`Clearing an empty chat, leaving`}else __LOG__(3)`Tried to clear chat, but was not found ${r}`}).then(r=>{if(null!=r)return(0,v.x)(r.jid,{user:e=>(0,a.a)(r),group:t=>(0,u.o)(e,t).then(e=>e&&(0,a.a)(r,e))})})})(t,e,r)),r=>{(0,_.c)("event","chatDeleted",{chatId:e}),r&&(0,_.c)("event","chatAdded",{chat:r})})})(r,!!n).then(()=>(0,G.b)().waitUntilPersisted(L.e.deleteChatContents(r,t)))}).end(),T=(0,$.c)().finalStep("deleteChatContents",(e,r)=>{var t=r.chatId,n=r.retainMediaInPhoneStorage;return(function(e,r){return(0,s.e)("deleteChatContents",t=>(0,i.i)((function(e,r,t){var n=(0,u.b)(r);return e.table.stores.chats.get(r).then(r=>{if(null==r)return{result:"chat-deleted"};var t=r.lastClearCut;return null==t?(__LOG__(4)`_deleteChatContents: chat not deleted or marked for clearing`,{result:"break"}):e.table.stores.msgs.where("id").between(n,t,!1,!0).toArray().then(e=>({result:"chat-cleared",preservedMsgIds:e.map(e=>e.id),lastClearCut:t}))}).then(l=>{if("break"!==l.result){var a,v;"chat-deleted"===l.result?v=(0,u.e)(r):(a=new Set(l.preservedMsgIds),v=l.lastClearCut);var c,s=(function e(r,t,n,l,u,a){var v=(0,i.l)(r.table.stores.media,"msgIds").between(n,l,!1,!0);return null!=u&&(v=v.filter(e=>!e.msgIds.some(e=>{var r=(0,d.r)(e);return null!=r&&u.has(r)}))),v.limit(f.a).toArray().then(n=>{if(n.length)return(0,f.P)(r.table.stores,n,e=>(0,o.A)(e)===t,a).then(()=>{if(n.length>=f.a){var i=(0,d.r)(n[n.length-1].msgIds.filter(e=>(0,o.A)(e)===t)[0]);if(null==i)return;return e(r,t,i,l,u,a)}})})})(e,r,n,v,a,t);"chat-deleted"===l.result?c=e.table.stores.msgs.where("id").between(n,v,!1,!0).delete():l.result;var h=e.table.stores.previews.where("previewId").between(n,v,!1,!0);null!=a&&(h=h.filter(e=>{var r=(0,o.e)(e.previewId);return null!=r&&!a.has(r)}));var _=h.delete(),g=e.table.stores.receipts.where("msgId").between(n,v,!1,!0);null!=a&&(g=g.filter(e=>{var r=(0,d.r)(e.msgId);return null!=r&&!a.has(r)}));var p,C=g.delete(),I=e.table.stores.receipts.where("msgId").between((0,o.j)(n),(0,o.w)(v),!1,!0);null!=a&&I.filter(e=>{var r=(0,o.d)(e.msgId);if(null==r)return!1;var t=(0,o.D)(r);return null!=t&&!a.has(t)}),p=I.delete();var w=(0,m.b)(e.table.stores,n,v,a),y=(0,b.a)(e.table.stores,n,v,a);return(0,i.c)([s,c,_,C,w,y,p])}}).then(()=>{})})(t,e,r)))})(t,!!n).then(()=>(0,G.b)().waitUntilPersisted(L.e.removeDeadMediaContent("delete-chat-"+t)))}).end()}}]);