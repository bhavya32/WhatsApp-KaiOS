"use strict";(self.webpackJsonp=self.webpackJsonp||[]).push([[147],{649:function(e,t,n){n.r(t),n.d(t,"setOneToOneEphemeralSetting",(function(){return T}));var r=n(4),a=n(88),l=n(51),i=n(3),s=n(56),o=n(296),u=n(7),O=n(30),p=n(22),_=n(2),g=n(40),S=n(513),m=n(229),E=n(546),c=n(67),d=n(73),f=n(124),h=new l.a("ackParser",e=>(e.assertTag("ack"),{ts:e.attrTime("t")})),T=(0,a.c)().finalStep("encryptAndSendEphemeralSetting",e=>{var t=e.userJid;return(0,c.b)(t).then(n=>{var a;if(null==n)return __LOG__(4)`setOneToOneEphemeralSetting contact does not exist`,"error";if((0,d.d)(n))return __LOG__(4)`setOneToOneEphemeralSetting contact is a business API`,"error";var l=e.expiration,c=e.ephemeralSettingTimestamp,T=e.id;return(function(e,t,n,a,l){var c,d=(0,g.e)(l),T={type:_.f.EPHEMERAL,subtype:"setting",ts:(0,i.k)(1,a),externalId:d,author:_.b,ack:_.a.CLOCK,altIndex:"",ephemeralExpiration:n};return(0,f.b)(t,n)&&(T.updated=!0),(0,p.V)(e).then(t=>(0,p.Tc)(e,{msg:T},null,{to:t,identityIds:new Map})).then(t=>{if(!t)return __LOG__(2)`setOneToOneEphemeralSetting writeOutgoingMsg failed`,SEND_LOGS("setOneToOneEphemeralSetting-write-msg-failed"),null;c=t.msg;var a=(0,m.b)({protocolMessage:{type:s.d.EPHEMERAL_SETTING,ephemeralExpiration:n}}),l=t.outgoingTo;return null==l||0===l.to.length?(__LOG__(2)`setOneToOneEphemeralSetting has no outgoingTo`,SEND_LOGS("setOneToOneEphemeralSetting-no-outgoingTo"),null):1===l.to.length?(0,o.g)((0,u.e)(e),a).then(e=>e.encNode):(0,E.b)(l.to,a).then(e=>(0,r.w)("participants",null,e.nodes))}).then(t=>{if(null==t)return null;var n=(0,r.w)("message",{id:(0,r.b)(d),to:(0,r.g)(e),type:(0,r.b)("text")},t);return(0,O.f)(n,{id:d,class:"message",from:(0,u.e)(e),participant:null}).catch(()=>(__LOG__(2)`setOneToOneEphemeralSetting sending stanza failed`,SEND_LOGS("setOneToOneEphemeralSetting-send-stanza-failed"),null))}).then(t=>{if(null==t)return"error";var r=h.parse(t);if(r.error)return __LOG__(2)`setOneToOneEphemeralSetting failed to parse an ack`,SEND_LOGS("setOneToOneEphemeralSetting-ack-parse-failed"),"error";var a=r.success.ts;return(0,p.Dc)(e,n,a).then(()=>c&&(0,S.a)(c.id,null,a,new Map)).then(()=>"success").catch(()=>(__LOG__(2)`setOneToOneEphemeralSetting updateContactEphemeralSettings failed`,SEND_LOGS("setOneToOneEphemeralSetting-updateContactEphemeralSettings-failed"),"error"))})})(t,null==(a=n.ephemeral)?void 0:a.expiration,l,c,T)})}).end()}}]);