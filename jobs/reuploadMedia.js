"use strict";(self.webpackJsonp=self.webpackJsonp||[]).push([[120],{686:function(e,r,t){t.r(r),t.d(r,"reuploadMedia",(function(){return x}));var o=t(26),i=t.n(o),n=t(88),a=t(4),u=t(9),d=t(22),l=t(35),p=t(93),s=t(2),c=t(90),_=t(33),f=t(529),v=t(3),y=t(6),m=t(30),h=t(7),O=t(117),g=t(89),M=t(412),G=t(616),L=t(542),q=v.b,x=(0,n.c)().finalStep("reupload",(e,r,t)=>{t.jobStartTime;var o=e.uploadToken;(0,g.c)("reupload media");var i=w(e);return(0,L.b)(i,"reupload").then(r=>{if(!r.error){var t=r.msgId,i=(0,v.t)();return(0,p.j)(t,()=>{var r=(0,v.u)(i);return(0,d.Q)(t).then(e=>e?(function(e,r,t,o){return I.apply(this,arguments)})(e,i,o,r):(__LOG__(3)`reuploadMedia:enqueueUpload msg ${t} is no longer a valid media message`,{type:"error",error:"not-found"})).then(r=>(function(e,r){var t=w(e);if("uploaded"===r.type){var o=r.directPath,i=r.cryptoKey;return y.I.get().mms4MediaRetryNotificationEncryptionEnabled?o?(function(e,r,t){return T.apply(this,arguments)})(t,i,o):void __LOG__(4)`Unexpected encrypted media reupload request without directPath`:(function(e){return S.apply(this,arguments)})(t)}})(e,r))},"silent")}__LOG__(3)`Reupload request for non-existing message`})}).end();function w(e){if(void 0!==e.externalId){var r=e.externalId,t=e.chat,o=e.requester,i=(0,h.e)(o);return(0,h.z)(t,{user:e=>({type:"user",jid:e,requesterJid:i,externalId:r}),group:e=>({type:"group",jid:e,requesterJid:i,externalId:r}),status:()=>({type:"status",requesterJid:i,externalId:r})})}return e.msgRef}function T(){return(T=i()((function*(e,r,t){var o=K(e),i=o.externalId,n=o.participant,u=o.to,d=yield(0,f.c)(r,i,t),l=d.ciphertext,p=d.iv;yield(0,m.g)((0,a.w)("notification",{to:(0,a.g)(u),from:(0,a.g)(y.t.get()),participant:n?(0,a.g)(n):a.c,id:(0,a.b)(i),type:"mediaretry"},(0,a.w)("encrypt",null,(0,a.w)("enc_p",null,l),(0,a.w)("enc_iv",null,p))),{id:i,class:"notification",from:u,participant:n,type:"mediaretry"})}))).apply(this,arguments)}function S(){return(S=i()((function*(e){var r=K(e),t=r.externalId,o=r.participant,i=r.to;yield(0,m.g)((0,a.w)("notification",{to:(0,a.g)(i),from:(0,a.g)(y.t.get()),participant:o?(0,a.g)(o):a.c,id:(0,a.b)(t),type:"mediaretry"}),{id:t,class:"notification",from:i,participant:o,type:"mediaretry"})}))).apply(this,arguments)}function I(){return(I=i()((function*(e,r,t,o){var i=e.dbMsg,n=e.dbMedia,a=i.id,u=n.mediaEntries[a],l=null==u?void 0:u.validatedTs;if(!u||"mms4"!==u.version||void 0===l)return __LOG__(4)`reuploadMedia: no valid entry found for recently uploaded media`,SEND_LOGS("media-reupload-missing-entry"),R(e,2,o),{type:"error",error:"invalid"};if(null!=n.lastUploadAttempt&&(0,v.m)(n.lastUploadAttempt,q)&&l>=n.lastUploadAttempt)return __LOG__(2)`Too soon since last upload. reusing existing entry path`,R(e,3,o),{type:"uploaded",directPath:u.directPath,url:u.url,cryptoKey:u.cryptoKey};var s=n.mediaId;if(null==(yield(0,d.Ic)(s)))return __LOG__(3)`reuploadMedia media ${s} was not found`,R(e,2,o),{type:"error",error:"not-found"};var f=n.plaintext;if(!f)return __LOG__(4)`reuploadMedia does not have plaintext`,R(e,2,o),{type:"error",error:"not-found"};__LOG__(2)`reuploadMedia uploading`;var y=(0,c.i)(i.type),m=yield(0,p.b)(y);if("no-hosts"===m)return __LOG__(3)`reuploadMedia failed to create retrier, no host for reuploading`,R(e,17,o),{type:"error",error:"error"};if("disconnected"===m)return __LOG__(3)`reuploadMedia disconnected`,{type:"error",error:"disconnected"};var h=new v.e,O=U(e,void 0,o);if(u.uploadToken){var g=yield(0,G.checkCiphertextInServer)(u.ciphertextHash,u.uploadToken,y,m,h,5,O);if("success"===g.result){(0,M.a)(g.metric);var L=(0,v.D)();return(0,d.Gb)(s,a,L).then(()=>({type:"uploaded",directPath:u.directPath,url:u.url,cryptoKey:u.cryptoKey}))}if("error"===g.result)return(0,M.a)(g.metric),{type:"error",error:"error"};if("disconnected"===g.result)return(0,M.a)(g.metric),{type:"error",error:"disconnected"};g.result,__LOG__(2)`reuploadMedia: content not in server, reuploading`}var x=(0,_.k)(t);return(0,G.cipherAndUploadPlaintext)(y,u.cryptoKey,x,()=>(0,c.d)(f),m,h,5,O).then(e=>{if((0,M.a)(e.metric),"error"===e.result)return __LOG__(3)`reuploadMedia uploading error`,{type:"error",error:"error"};var r=Object.assign({},u,{uploadToken:x,validatedTs:(0,v.D)()});return e.directPath!==u.directPath&&(r.directPath=e.directPath),e.url!==u.url&&(r.url=e.url),(0,d.ic)(s,a,r).then(()=>({type:"uploaded",directPath:e.directPath,url:e.url,cryptoKey:u.cryptoKey}))})}))).apply(this,arguments)}function R(e,r,t){(0,M.a)(U(e,r,t))}function U(e,r,t){var o,i=e.dbMsg,n=O.a[i.type],a=(function(e){var r;if(e.type===s.f.RICH_HSM){var t=e.richContent;if(null==t)return void __LOG__(3)`Received reupload request for a rich HSM without media content`;if(t.type===s.f.LOCATION)return void __LOG__(3)`Received reupload request for a rich HSM with location content`;r=t.size}else r=e.size;return r})(i);switch(e.type){case"user":o=2;break;case"group":o=3;break;default:e.type,o=4}var u=t;return{overallT:0,overallCumT:0,overallUploadOrigin:o,overallMediaType:n,overallMediaSize:a,overallUploadMode:5,overallMmsVersion:4,isViewOnce:(0,l.q)(i),uploadSource:i.uploadSource&&i.uploadSource,overallMediaKeyReuse:3,overallUploadResult:r,overallIsFinal:!0,overallQueueT:u}}function K(e){return{participant:"group"===e.type||"status"===e.type?e.requesterJid:void 0,to:"status"===e.type?u.h:e.jid,externalId:e.externalId}}}}]);