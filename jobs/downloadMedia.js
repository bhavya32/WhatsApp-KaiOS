"use strict";(self.webpackJsonp=self.webpackJsonp||[]).push([[92],{730:function(e,r,o){o.r(r);var a=o(8),n=o.n(a),i=o(26),t=o.n(i),l=o(2),d=o(88),s=o(22),u=o(93),_=o(12),c=o(7),f=o(398),v=o(35),m=o(39),w=o(16),O=o(3),g=o(151),p=o(90),G=o(119),L=o(89),h=o(228),y=o(255),$=o(40),D=o(11),M=o(117),F=o(15),S=o(67),b=o(54),k=o(44),x=o(6),I=100*D.a;function R(){return(R=t()((function*(e){var r=(0,b.i)(e.author);if(!r)return"@psa"===e.author?z():(__LOG__(3)`shouldAutodownloadMediaMsg tried to download message from invalid author ${e.author}`,!1);if(e.type===l.f.DOCUMENT&&e.isVCard){var o=x.I.get().mmsVcardAutodownloadSizeKb;if(e.size<=o*D.a)return V(r,e)}if(e.type===l.f.STICKER){if(e.size<I)return __LOG__(2)`Auto-downloading sticker`,!0;__LOG__(2)`Sticker is above the limit, we will check autodownloading settings`}return(yield j(e.type))?!e.chat||V(r,e):(__LOG__(2)`shouldAutodownloadMediaMsg: Should not autodownload type ${e.type}`,!1)}))).apply(this,arguments)}function V(e,r){var o=(0,F.v)(r.id);return(0,s.A)(o).then(r=>{if(!r)return __LOG__(3)`shouldAutodownloadMediaMsg: chat ${o} no longer exists`,!1;var a=[e],n=r.dbGroup;if(n){var i=n.groupInfo.creatorJid;i&&a.push(i);var t=(0,b.n)(n.participantsInfo.admins);a.push(...t)}return(0,S.c)(a).then(e=>e.some(e=>(0,k.k)(e)))})}function j(e){return T.apply(this,arguments)}function T(){return(T=t()((function*(e){var r,o=x.k.get(),a=yield(0,_.e)("page","getNetworkInfo",{}),n=a.isWifiConnected,i=a.isRoaming;switch(r=n?o.autodownloadWifi:i?o.autodownloadRoaming:o.autodownloadMobile,e){case l.f.STICKER:case l.f.IMAGE:case l.f.GIF:return r.includes("photos");case l.f.AUDIO:return r.includes("audio");case l.f.VIDEO:return r.includes("videos");case l.f.DOCUMENT:return r.includes("documents");case l.f.PTT:return!0;default:return!1}}))).apply(this,arguments)}function z(){return N.apply(this,arguments)}function N(){return(N=t()((function*(){var e=yield(0,_.e)("page","getNetworkInfo",{}),r=e.isWifiConnected,o=e.isRoaming;return r||!o}))).apply(this,arguments)}function E(){return(E=t()((function*(e,r,o,a,n){var i=r.id,t=o.mediaEntries[i];if(!t)return __LOG__(4)`downloadMedia no entry for media message ${i}`,SEND_LOGS("no-entry-for-media-msg"),(0,u.k)(Object.assign({},n,{overallDownloadResult:2,overallIsFinal:!0,isViewOnce:(0,v.q)(r)})),{result:"error",error:"failed"};__LOG__(2)`downloadMedia for message ${r.id}, type = ${r.type}, entry.size = ${t.size}`;var l=yield(0,g.d)("user"===e?"manual":"auto",t,o.plaintextHash,a,n),d=l.result,c=l.metric;if("success"!==d.status)return"gone"===d.status&&(yield(0,m.b)().waitUntilPersisted(w.e.requestReupload(i))),"daemon-disconnected"===d.status?{result:"error",error:"disconnected"}:(__LOG__(2)`downloadMedia failed to download media ${d.status}`,(0,u.k)(Object.assign({},c,{overallDownloadResult:g.a[d.status],overallIsFinal:!0,isViewOnce:(0,v.q)(r)})),{result:"error",error:"failed"});var G=d.path,L=(yield(0,_.e)("page","getBlobFromPhoneStorage",{path:G})).blob;if(!L)return __LOG__(4)`downloadMedia blob gone right after downloading`,SEND_LOGS("downloaded-blob-gone"),(0,u.k)(Object.assign({},c,{overallDownloadResult:2,overallIsFinal:!0,isViewOnce:(0,v.q)(r)})),{result:"error",error:"failed"};var h=void 0,y=void 0;if("video"===(0,p.a)(t.type)){__LOG__(2)`downloadMedia parsing video`;var $=(0,O.t)(),D=yield(0,f.a)(L);if(y=(0,O.u)($),__LOG__(2)`downloadMedia parsed video`,"error"===D.type)__LOG__(3)`downloadMedia media rejected for ${i}`,SEND_LOGS("invalid-video");else{var M=D.info.video;M?h=M.rotation:(__LOG__(3)`downloadMedia media not video for ${i}`,SEND_LOGS("no-video-track"))}if(null==h)return(0,u.k)({overallFileValidationT:y,overallDownloadResult:2,overallIsFinal:!0,isViewOnce:(0,v.q)(r)}),{result:"error",error:"invalid"}}(0,u.k)(Object.assign({},c,{overallIsFinal:!0,overallFileValidationT:y,overallDownloadResult:1,isViewOnce:(0,v.q)(r)})),__LOG__(2)`downloadMedia successfully stored full content to temporary file`,null!=h&&(yield(0,s.sc)(o.mediaId,{rotation:h}));var F=yield(0,u.h)(i,o.mediaId,L,"save");return a.parts.processing.finished(),"ok"===F.type?(__LOG__(2)`downloadMedia successfully finalized media ${o.mediaId}`,yield A(r,o.mediaId,L),yield U(d.progressiveDownload,o),{result:"success"}):(__LOG__(2)`downloadMedia failed to finalize media ${o.mediaId}`,{result:"error",error:"failed"})}))).apply(this,arguments)}function P(e){return q.apply(this,arguments)}function q(){return(q=t()((function*(e){var r=yield(0,s.Q)(e);if(r){var o=r.dbMsg,a=r.dbMedia;if(o.type===l.f.VIDEO||o.type===l.f.GIF){var n=o.plaintext;if(n)if(a.frame)__LOG__(2)`extractFrame frame is already extracted for msg ${e}`;else{var i=o.rotation;if(void 0!==i){(0,L.c)("extractFrame");var t=yield(0,_.e)("page","extractFrame",{msgId:e,videoRef:n,rotation:i});if(t.error)__LOG__(3)`extractFrame found some error. Skipping`;else{var d=t.result;if(null!=d){var u=a.mediaId,c=yield(0,G.getChunkTable)().storeFrame(u,d);yield(0,s.sc)(u,{frame:c})}}}else __LOG__(3)`extractFrame no rotation for msg ${e}`}else __LOG__(3)`extractFrame no media plaintext for msg ${e}`}else __LOG__(2)`extractFrame msg ${e} is not video or gif - skipping it`}else __LOG__(2)`extractFrame message ${e} is not a valid media message`}))).apply(this,arguments)}function A(e,r,o){return(0,v.d)(e)?(0,h.j)(o).then(e=>(0,s.ac)(r,e)):Promise.resolve()}function B(e){switch(e){case"retry":case"status":case"autodownload":return 2;default:return 1}}function C(e,r,o,a){var n=Q(e.dbMsg);if(null!=n){var i,t,l=n.size,d=n.mediaType,s="status"===e.type?3:(0,c.x)(e.jid,{user:()=>1,group:()=>2});if(a)if(t="mms4"===a.version?4:"mms3"===a.version?3:void 0,"mms4"!==a.version||null==a.directPath)i=1;else{var u=a.directPath;u.startsWith("/o")?i=3:u.startsWith("/v")&&(i=2)}return{overallMmsVersion:t,overallDownloadOrigin:s,overallDownloadMode:B(r),overallMediaType:d,overallIsFinal:!0,overallMediaSize:l,overallQueueT:o,overallBackendStore:i}}}function H(e,r,o){return"error"===o.result?"no-space"===o.error?e.msgMediaStatusUpdated(r,e.STATUS_ERROR_NOT_ENOUGH_SPACE):"disconnected"===o.error?e.msgMediaStatusUpdated(r,e.STATUS_ERROR_DISCONNECTED):"too-big"===o.error?e.msgMediaStatusUpdated(r,e.STATUS_ERROR_TOO_BIG):(o.error,e.msgMediaStatusUpdated(r,e.STATUS_IDLE)):o.result,o}function Q(e){if(e.type!==l.f.RICH_HSM)return{size:e.size,mediaType:M.a[e.type]};e.type;var r=e.richContent;return null==r?(__LOG__(4)`Tried to enqueue download for a rich HSM without media`,null):r.type===l.f.LOCATION?(__LOG__(4)`Tried to enqueue download for a location message`,null):{size:r.size,mediaType:M.a[r.type]}}function U(e,r){e?(0,s.oc)(r.mediaId,e):(function(e){return!!(e.partialPlaintextHash||e.partialSize||e.progressiveJpegScanNumber)})(r)&&(0,s.oc)(r.mediaId,null)}r.default=(0,d.c)().step("download",{requirements:[d.d],code:e=>{var r=e.msgId,o=e.source,a=(0,O.t)();return(0,u.e)(r,e=>(function(e,r,o){return(0,s.Q)(r).then((function(){var a=t()((function*(a){if(e.isDownloading(r))return __LOG__(3)`_shouldDownload twice for same msgId ${r}`,{result:"skip"};if(!a)return __LOG__(2)`_shouldDownload message ${r} is not a valid media message`,{result:"error",error:"gone"};var n=a.dbMsg,i=a.dbMedia,t=i.mediaId,l=i.mediaEntries[n.id];l||__LOG__(3)`Media ${t} has no media entry for message.`;var d=Q(n);if(null==d)return{result:"error",error:"invalid"};if(d.size>$.c)return __LOG__(2)`media is too big, skipping download`,{result:"error",error:"too-big"};var _=C(a,o,0,l);if(!_)return{result:"error",error:"invalid"};var c=i.plaintext;if(c)return __LOG__(2)`_shouldDownload msg ${r} already downloaded`,(0,u.k)(Object.assign({},_,{overallDownloadResult:12,isViewOnce:(0,v.q)(n)})),yield(0,u.g)(n,t,c),{result:"skip"};if("autodownload"===o&&!(yield(function(e){return R.apply(this,arguments)})(n)))return __LOG__(2)`_shouldDownload msg ${r} should not autodownload`,{result:"skip"};if(!(0,p.h)(n))return __LOG__(2)`_shouldDownload msg ${r} does not have a valid mimetype`,(0,u.k)(Object.assign({},_,{overallDownloadResult:2,isViewOnce:(0,v.q)(n)})),{result:"error",error:"no-mimetype"};e.updateDownload(r,e.STATUS_PENDING);var f=[(0,s.Hc)(t)];return"retry"===o&&f.push((0,s.Vb)(r,t)),Promise.all(f).then(e=>({result:"download"}))}));return function(e){return a.apply(this,arguments)}})())})(e,r,o),(e,i)=>"download"!==i.result?H(e,r,i):(function(e,r,o,a){var i=(0,O.u)(a);return Promise.all([(0,s.Q)(r),(0,_.e)("page","getFreeSpace",{area:"sdcard"})]).then(a=>{var t=n()(a,2),l=t[0],d=t[1].freeSpace;if(!l)return __LOG__(2)`_doDownload message ${r} is not a valid media message`,{result:"error",error:"gone"};var s=l.dbMsg,_=l.dbMedia;if(_.plaintext)return __LOG__(2)`_doDownload msg downloaded while in queue`,{result:"skip"};var c=_.mediaEntries[s.id],f=_.mediaId;c||__LOG__(3)`Media ${f} has no media entry for ${r}.`;var m=C(l,o,i,c);if(!m)return{result:"error",error:"invalid"};if(e.isDownloadCancelled(r))return __LOG__(2)`_doDownload msg ${r} cancelled`,(0,u.k)(Object.assign({},m,{overallDownloadResult:11,isViewOnce:(0,v.q)(s)})),{result:"error",error:"cancelled"};var w=Q(s);if(null==w)return{result:"error",error:"invalid"};if(d<2.01*w.size)return __LOG__(2)`_doDownload not enough space to download media`,(0,u.k)(Object.assign({},m,{overallDownloadResult:5,isViewOnce:(0,v.q)(s)})),{result:"error",error:"no-space"};var O=new y.a({parts:g.b,onUpdate(o){__LOG__(2)`download ${100*o}% finished`,e.updateDownload(r,{type:"processing",progress:o})},onSuccess:()=>{__LOG__(2)`download finished`},onError:e=>{__LOG__(2)`download failed ${e}`}});return(function(e,r,o,a,n){return E.apply(this,arguments)})(o,s,_,O,Object.assign({},m,{overallIsFinal:!1}))})})(e,r,o||"autodownload",a).then(o=>H(e,r,o)).catch(o=>{throw e.msgMediaStatusUpdated(r,e.STATUS_IDLE),o}))},stopRetryIf:{timePassedSeconds:O.b,appCrashed:!0,onStopRetry:()=>{}}}).finalStep("extractFrame",(e,r)=>{var o=r.msgId;if(e&&"error"!==e.result)return(0,u.f)(o,P)}).end()}}]);