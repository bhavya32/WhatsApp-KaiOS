"use strict";(self.webpackJsonp=self.webpackJsonp||[]).push([[137],{682:function(i,e,n){n.r(e),n.d(e,"senderBackfill",(function(){return w}));var r=n(26),t=n.n(r),a=n(22),u=n(517),l=n(513),s=n(88),f=n(39),c=n(16),o=n(547),v=n(296),d=n(7),p=n(20),y=n(4),k=n(297),g=n(30),B=n(51),m=n(3),h=n(546),M=n(117),w=(0,s.c)().step("syncDeviceList",i=>{var e=i.originalTo,n=(0,p.m)(e.map(d.h));return(0,f.b)().waitUntilCompleted(c.e.syncDeviceList(n)).then(()=>({originalParticipants:n})).catch(()=>{P(i).then(i=>{i&&(0,M.f)(i,{e2eBackfill:!0})})})}).finalStep("sendMsg",(function(){var i=t()((function*(i,e){if(i){var n=yield P(e);if(n){var r=i.originalParticipants;if((0,m.m)(e.ts,300)){var t=e.originalTo,a=e.primaryIdentityIds;if("status"!==n.type){var u=yield x(r,t);if(u.length>0)return"user"===n.type?(function(i,e,n){return(0,M.j)(i,{e2eBackfill:!0}),(0,o.c)(i,e,n).then(()=>{})})(n,u,a):(n.type,D(n,u,a))}else{n.type;var l=yield x(r,t);if(l.length>=1)return D(n,l,a)}}else(0,M.i)(n,{e2eBackfill:!0},!1)}}}));return function(e,n){return i.apply(this,arguments)}})()).end();function x(i,e){return(0,a.G)(i).then(i=>(0,p.n)(i,e))}var A=new B.a("sendMsgAck",i=>(i.assertTag("ack"),{ts:i.attrTime("t")}));function D(i,e,n){return L.apply(this,arguments)}function L(){return(L=t()((function*(i,e,n){var r=i.dbMsg,t=(0,k.e)(r),a=yield(0,h.a)(e,i,{ids:n,type:"primary"});if(0!==a.nodes.length){var f,c=(0,y.w)("participants",null,a.nodes),o=(0,u.f)(i),d=(0,u.g)(i),p=(0,v.b)(t),B=null!=r.expiration?(0,y.f)(r.expiration):s.a,m=(0,y.w)("message",{id:(0,y.b)(r.externalId),to:(0,y.g)(d),type:(0,k.f)(r),expiration:B,device_fanout:(0,y.b)("false")},c,p),w=yield(0,g.f)(m,{id:r.externalId,class:"message",from:d,participant:null}),x=A.parse(w);if(!x.error)return(0,M.j)(i,{e2eBackfill:!0}),(0,l.b)(o,d,e,null==(f=x.success)?void 0:f.ts)}}))).apply(this,arguments)}function P(i){return void 0!==i.msgId?(0,u.c)(i.msgId):(0,u.d)(i.jid,i.rowId)}}}]);