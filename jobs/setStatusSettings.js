"use strict";(self.webpackJsonp=self.webpackJsonp||[]).push([[3],{530:function(t,e,r){r.r(e),r.d(e,"initLocalSettingsFromServer",(function(){return G})),r.d(e,"updateServerWhitelistJob",(function(){return O})),r.d(e,"ensureStatusSettingsInitialized",(function(){return W}));var s=r(26),i=r.n(s),n=r(30),a=r(4),u=r(88),o=r(51),l=r(22),c=r(67),d=r(37),v=r.n(d),_=r(72),S=r(92),f=r(20),g=r(39),p=r(16),h=r(6),y={404:(0,_.d)("item-not-found"),500:(0,_.d)("unknown")},w=new o.a("setStatusPrivacyParser",t=>({result:t.attrString("type")}));function k(t){var e;switch(t.type){case"contacts":e=[];break;case"whitelist":e=t.whitelist;break;case"blacklist":e=t.blacklist;break;default:return(0,v.a)(t.type)}return(0,n.b)((0,a.w)("iq",{to:a.l,type:"set",xmlns:"status",id:(0,a.u)()},(0,a.w)("privacy",null,(0,a.w)("list",{type:(0,a.b)(t.type)},e.map(t=>(0,a.w)("user",{jid:(0,a.g)(t)}))))),w).then(t=>t.success?{result:"success"}:(0,_.f)(t,y))}e.default=(0,u.c)().step("setLocalStatusSettings",t=>(0,l.rc)(t)).finalStep("setServerStatusSettings",i()((function*(){var t=yield(0,l.db)();return t?k((0,S.l)(t)):{error:{reason:"not-initialized"}}}))).end();var b={contacts:"contacts",blacklist:"blacklist",whitelist:"whitelist"},L=new o.a("getStatusPrivacyParser",t=>{var e;function r(t,r){r.hasAttr("default")&&(e&&r.throw(`to only have one default child. Found two ${e} & ${t}`),e=t)}var s=new Set,i=new Set;return t.child("privacy").forEachChildWithTag("list",t=>{var e=t.attrEnum("type",b);switch(e){case"contacts":return void r("contacts",t);case"whitelist":t.forEachChildWithTag("user",t=>{s.add(t.attrPhoneUserJid("jid"))}),r("whitelist",t);break;case"blacklist":t.forEachChildWithTag("user",t=>{i.add(t.attrPhoneUserJid("jid"))}),r("blacklist",t);break;default:return(0,v.a)(e)}}),e?{type:e,whitelist:(0,f.c)(s),blacklist:(0,f.c)(i)}:t.throw("to have one node with default attribute")}),m={404:(0,_.d)("item-not-found"),500:(0,_.d)("unknown")},G=(0,u.c)().step("initLocalSettingsFromServer",()=>h.l.get()?(0,l.db)().then(t=>t?(__LOG__(3)`initLocalSettingsFromServer settings already found locally`,{result:"ok",settings:t}):(0,n.b)((0,a.w)("iq",{to:a.l,type:"get",xmlns:"status",id:(0,a.u)()},(0,a.w)("privacy",null)),L).then(t=>{if(!t.success){var e=(0,_.f)(t,m);return"item-not-found"!==e.error.reason?void __LOG__(4)`fetchInitialServerStatusSettings error server response ${e.error.reason}`:(0,c.f)().then(t=>({result:"no-server-value",settings:{type:"contacts",participants:(0,f.m)(t),whitelist:(0,f.f)(),blacklist:(0,f.f)()}}))}var r=t.result;return(0,c.f)().then(t=>{var e=(0,S.d)(t,(0,S.l)(r),r);return{result:r.whitelist.length!==e.whitelist.length?"whitelist-updated":"ok",settings:e}})}).then(t=>{if(t)return(0,l.hc)(t.settings).then(()=>t);__LOG__(3)`Server did not return anything`})):(__LOG__(2)`Tried to get initial status settings before syncing contacts db. Waiting for sync to happen first`,Promise.resolve())).finalStep("updateServerWhitelist",t=>{if(!t)return{error:{reason:"error"}};var e=t.settings,r=t.result;return"ok"===r?{result:e}:"no-server-value"===r?k({type:"contacts"}).then(t=>null!=t.error?(__LOG__(4)`initLocalSettingsFromServer error trying to set default settings reason ${t.error.reason}`,{error:{reason:"error"}}):{result:e}):P(e).then(t=>"error"===t?{error:{reason:"error"}}:{result:e})}).end(),O=(0,u.c)().finalStep("updateServerWhitelist",()=>(0,l.db)().then(t=>{if(t)return P(t).then(()=>{})})).end();function P(t){return"whitelist"===t.type?(__LOG__(2)`updateServerWhitelist updating server`,k({type:"whitelist",whitelist:t.whitelist}).then(t=>null!=t.error?(__LOG__(4)`updateServerSettings error trying to set default settings reason ${t.error.reason}`,"error"):"success")):(__LOG__(2)`updateServerWhitelist no need to update server`,Promise.resolve("success"))}function W(){return(0,l.db)().then(t=>t?(__LOG__(2)`ensureStatusSettingsInitialized settings found locally`,"success"):(0,g.b)().waitUntilCompleted(p.e.initLocalSettingsFromServer()).then(t=>t.error?"error":(__LOG__(2)`ensureStatusSettingsInitialized settings initialized properly`,"success")))}}}]);