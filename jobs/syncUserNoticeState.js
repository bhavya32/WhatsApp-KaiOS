"use strict";(self.webpackJsonp=self.webpackJsonp||[]).push([[150],{704:function(e,t,s){s.r(t);var c=s(88),r=s(4),n=s(81),i=s(30),o=s(51),a=s(72),_=s(22),u=s(3),d=s(304),v=s(212),f=s(12),l=s(89),y=s(15),S=s(6),g=s(14),w=new n.a,N={400:(0,a.d)("bad-request"),500:(0,a.d)("unknown")},G=new o.a("syncUserNoticeState",e=>{if(e.hasChild("error")){var t=e.child("error");return{success:!1,stale:!1,code:t.attrInt("code"),text:t.attrString("text")}}if(!e.hasChild("notice"))return{success:!0,stale:!1};var s=e.child("notice"),c=s.attrInt("stage"),r=(0,d.a)(c);return null==r?(__LOG__(3)`syncUserNoticeState: Received user notice containing notice with invalid state: "${c}"`,{success:!1,code:500}):{success:!0,stale:!0,state:r,ts:s.attrTime("t")}});function U(e){return e===g.Y?S.N.set({status:"accepted",forcedFetchIteration:S.N.get().forcedFetchIteration}).then(()=>((0,f.c)("event","tosGatingStatusChanged",{tosAccepted:"accepted"}),"success")):"success"}t.default=(0,c.c)().finalStep("sendStateToServer",e=>(function(e,t,s){if(!(0,v.b)())return __LOG__(2)`syncUserNoticeState: User Notice Framework is disabled`,Promise.resolve("success");var c=(0,r.u)(),n=(0,r.w)("iq",{to:r.l,type:"set",xmlns:"tos",id:c},(0,r.w)("notice",{id:(0,r.f)(e),stage:(0,r.f)(t)}));return __LOG__(2)`syncUserNoticeState: Queuing iq for notice ${e} state ${t} for version ${s}`,w.enqueue(()=>(__LOG__(2)`syncUserNoticeState: Sending iq ${e} state ${t} for version ${s}`,(0,i.b)(n,G).then(c=>{if(__LOG__(2)`syncUserNoticeState: received server ack`,!c.success){var r=(0,a.f)(c,N);if(400===c.errorCode)return __LOG__(4)`syncUserNoticeState: Received bad request when sending iq to sync user notice state`,SEND_LOGS("sync-user-notice-state-bad-request"),WAM.log("regular",2474,void 0,[3,0,1,1,0,e,2,0,s]),_.Pb(e).then(()=>r);if(c.errorCode>=500)throw __LOG__(4)`syncUserNoticeState: Received internal server error when sending iq to sync user notice state`,new l.b({algo:{type:"fibonacci",first:1e3*u.d,second:1e3*u.d},max:1e3*u.b});return __LOG__(4)`syncUserNoticeState: ${c.errorCode} Received unknown server error when sending iq to sync user notice state`,r}var n=c.result;return n.stale?t===y.q.EXPIRED?(__LOG__(3)`syncUserNoticeState: Received stale user notice state when sending acceptance iq`,U(e)):_.Nc(e,n.state,(0,u.i)(n.ts)).then(()=>"success"):t>=y.q.EXPIRED?(__LOG__(2)`syncUserNoticeState: Received server ack for expired notice, will delete notice`,_.Pb(e).then(()=>U(e))):"success"})))})(e.id,e.state,e.version)).end()}}]);