"use strict";(self.webpackJsonp=self.webpackJsonp||[]).push([[29],{616:function(e,r,l){l.r(r),l.d(r,"uploadMedia",(function(){return T})),l.d(r,"checkCiphertextInServer",(function(){return W})),l.d(r,"cipherAndUploadPlaintext",(function(){return Y}));var t=l(26),i=l.n(t),a=l(15),u=l(39),o=l(88),n=l(22),d=l(513),s=l(93),c=l(2),v=l(11),_=l(90),p=l(33),f=l(130),h=l(35),y=l(95),m=l(3),M=l(117),O=l(412),b=l(12),k=m.b,L=2*m.b;function G(e){var r=Math.floor(Math.random()*k);return null!=e&&(0,m.m)(e,L+r)}var g=l(369),x=l(16),U=l(42),R=l(6),T=(0,o.c)().finalStep("encrypt",{requirements:[o.d],code:e=>{var r=$(e),l=(0,m.t)();return(0,s.j)(r,t=>{var i=(function(e){return e.outgoingTo?e.outgoingTo:e.result.outgoingTo})(e);return(function(e,r,l,t,i){return w.apply(this,arguments)})(t,r,i,e,l)})},stopRetryIf:{timePassedSeconds:m.b,appCrashed:!0,onStopRetry:e=>{var r=$(e);return(0,d.e)(r,c.a.FAILED).then(()=>{})}}}).end();function w(){return(w=i()((function*(e,r,l,t,i){var a=(0,m.u)(i),o=yield(0,n.Q)(r);if(o){var s=o.dbMsg,v=o.dbMedia;if(s.type!==c.f.RICH_HSM){var _=v.mediaId;if((0,U.l)(s.ack))__LOG__(2)`uploadMedia already uploaded`;else{var p;switch(o.type){case"user":p=2;break;case"group":p=3;break;default:o.type,p=4}var f=null!=s.forwardOriginalTs,y={overallUploadOrigin:p,overallMediaType:M.a[s.type],overallIsForward:f,overallMediaSize:s.size,overallQueueT:a,isViewOnce:(0,h.q)(s),uploadSource:s.uploadSource&&s.uploadSource},b=yield(0,n.Ic)(_);if(!b)return __LOG__(3)`uploadMedia: media was not found`,yield(0,d.e)(s.id,c.a.CONTENT_GONE),(0,O.a)(Object.assign({},y,{overallUploadResult:12})),void(0,M.k)(o,{});var k={result:"error",ack:c.a.FAILED};try{k=yield I(e,{dbMsg:s,dbMedia:b,leavesSystem:z(o,l),args:t,uploadMetric:y})}finally{var L=s.id;if(k.metric&&(0,O.a)(k.metric),k.thumbMetric&&(0,O.a)(k.thumbMetric),"error"===k.result)yield(0,d.e)(L,k.ack),e.updateUploadStatus(L,{type:"error",error:"unknown"}),(0,M.k)(o,{});else if("disconnected"===k.result)yield(0,d.e)(L,c.a.FAILED),e.updateUploadStatus(L,{type:"error",error:"disconnected"}),(0,M.k)(o,{});else{k.result,yield(0,n.d)(L);var G=k.uploaded;yield(0,u.b)().waitUntilPersisted(x.e.sendWrittenMsg(L,l,t.origin,G))}}}}else __LOG__(4)`Tried to upload media of a rich HSM`}else __LOG__(2)`uploadMedia msg is gone`}))).apply(this,arguments)}function j(e,r){if(!r.validatedTs)return __LOG__(2)`Entry without a validatedTs.`,!1;var l=!!(0,y.f)(e)&&(null==r.mmsThumb||null==r.mmsThumb.directPath);return!(null==r.directPath&&null==r.url||l)}function I(e,r){return S.apply(this,arguments)}function S(){return(S=i()((function*(e,r){var l=r.dbMsg,t=r.dbMedia,i=r.leavesSystem,a=r.args,u=r.uploadMetric,o=t.mediaId,d=t.plaintext;if(!d)return __LOG__(4)`uploadMedia does not have plaintext`,{result:"error",ack:c.a.CONTENT_GONE};var f=(0,_.i)(l.type),h=A(t,l.id,f);if("error"===h)return{result:"error",ack:c.a.CONTENT_UNUPLOADABLE};var y=h.maybeValidEntry,M=h.mediaKeyReuse,O=h.isMsgEntry;if(y&&j(l,y))return __LOG__(2)`uploadMedia content probably exists on server, so we will optimistically skip upload`,yield(0,n.ic)(o,l.id,(0,v.v)(y)),{result:"success",uploaded:!1,metric:void 0};var b=yield(0,s.b)(f);if("no-hosts"===b){__LOG__(3)`uploadMedia no available hosts`;var k=Object.assign({},u,{overallUploadMode:1,overallUploadResult:17});return{result:"error",ack:c.a.FAILED,metric:k}}if("disconnected"===b)return{result:"disconnected"};var L=new m.e,G=Object.assign({},u,{overallMediaKeyReuse:M,overallConnBlockFetchT:b.routesInfo.timeElapsed,overallMmsVersion:4});return y&&y.uploadToken?(O||__LOG__(2)`uploadMedia repurposing existing media entry`,yield(0,n.ic)(o,l.id,y),i?B(o,d,l,f,y,b,L,G):{result:"success",uploaded:!1}):C(o,l,d,(0,p.k)(a.backupKey),(0,p.k)(a.backupToken),i,L,b,G)}))).apply(this,arguments)}function C(e,r,l,t,i,a,u,o,n){return F.apply(this,arguments)}function F(){return(F=i()((function*(e,r,l,t,i,a,u,o,d){var s=(0,_.i)(r.type),v=yield(0,_.d)(l);if(!v)return __LOG__(3)`uploadMedia plaintext is gone`,{result:"error",ack:c.a.CONTENT_GONE,metric:Object.assign({},d,{overallUploadResult:11,overallCumT:u.cumulative(),overallT:u.elapsed(),overallIsFinal:!0})};var p,M,b=yield H(v,s,t),k=b.ciphertext,L=b.ciphertextHash,G=b.sidecar,g=(0,m.D)(),x={version:"mms4",type:s,ciphertextHash:L,sidecar:G,size:v.size,cryptoKey:t,uploadToken:i,mediaKeyTs:g,creationTs:g,validatedTs:m.c,isViewOnce:(0,h.q)(r)};if((0,y.f)(r)){__LOG__(2)`Media for msg type ${r.type} requires MMS Thumb upload`;var U=yield(0,n.J)(r.id);if(U){yield q(r,U);var R=(0,_.j)(r.type),T=yield(0,f.c)(t,R),w=T.iv,j=T.cipherKey,I=T.hmacKey,S=yield(0,f.d)(j,w,I,R,U),C=S.ciphertext,F=S.ciphertextHash;p=C,M=F,x.mmsThumb={ciphertextHash:F}}}if(yield(0,n.ic)(e,r.id,x),!a)return{result:"success",uploaded:!1};var K=(0,O.c)(s,k,i,L,u);__LOG__(2)`uploadMedia uploading`;var E=yield ee(K,o,1,d);if("error"===E.result)return{result:"error",ack:E.ack,metric:E.metric};if(__LOG__(2)`uploadMedia ciphertext successfully uploaded`,!p||!M){var V=(0,m.D)();return yield(0,n.jc)(e,r.id,E.directPath,E.url,V),{result:"success",uploaded:!0,metric:E.metric}}yield(0,n.jc)(e,r.id,E.directPath,E.url);var $=E.metric,z=yield P(e,r,p,M,{cryptoKey:t,uploadToken:i},u,d);if("success"===z.result){var A=(0,m.D)();yield(0,n.Gb)(e,r.id,A)}return z.metric=$,z}))).apply(this,arguments)}function P(e,r,l,t,i,a,u){return K.apply(this,arguments)}function K(){return(K=i()((function*(e,r,l,t,i,a,u){var o=(0,_.j)(r.type),d=yield(0,s.b)(o);if("no-hosts"===d){__LOG__(3)`uploadMedia no available hosts for thumb`;var v=Object.assign({},u,{overallUploadMode:7,overallUploadResult:17});return{result:"error",ack:c.a.FAILED,thumbMetric:v}}if("disconnected"===d)return{result:"disconnected"};var p=(0,O.c)(o,l,i.uploadToken,t,a);__LOG__(2)`uploadMedia: mms thumb uploading`;var f=yield ee(p,d,7,u);if("error"===f.result)return{result:"error",ack:f.ack,thumbMetric:f.metric};var h=f.directPath;return void 0===h?{result:"error",ack:c.a.FAILED,thumbMetric:f.metric}:(yield(0,n.lc)(e,r.id,h),{result:"success",uploaded:!0,thumbMetric:f.metric})}))).apply(this,arguments)}function q(e,r){return E.apply(this,arguments)}function E(){return(E=i()((function*(e,r){if("mms"!==e.hasPreview){var l,t,i,u=e.id;if(null!=(0,a.s)(u))l="skip";else{var o=yield(0,b.e)("page","computeMicroThumb",{fullThumb:r});l=o.microThumb,i=o.fullThumbWidth,t=o.fullThumbHeight}var d=yield(0,_.e)(r);yield(0,n.cc)(u,d,l,{blob:r,height:t,width:i})}}))).apply(this,arguments)}function H(e,r,l){return V.apply(this,arguments)}function V(){return(V=i()((function*(e,r,l){__LOG__(2)`_computeCiphertext ciphering`;var t=yield(0,f.c)(l,r),i=t.iv,a=t.cipherKey,u=t.hmacKey,o=yield(0,f.d)(a,i,u,r,e);return{ciphertext:o.ciphertext,ciphertextHash:o.ciphertextHash,sidecar:o.sidecar}}))).apply(this,arguments)}function $(e){return void 0!==e.msgId?e.msgId:e.result.dbMsg.id}function z(e,r){var l=r.to;return"user"===e.type?e.jid!==R.t.get():(e.type,l.length>0)}function A(e,r,l){var t,i,a=e.mediaEntries[r];if(a){if("mms4"!==a.version||void 0===a.validatedTs)return __LOG__(4)`uploadMedia can not upload non-mms4 message`,"error";G(a.mediaKeyTs)&&(t=a),i=1}else{var u=(function(e,r){for(var l=(0,g.b)((0,_.f)(r)),t=(0,v.y)(e),i=null,a=!1,u=0;u<t.length;++u){var o=t[u];if(o&&"mms4"===o.version){var n=o.validatedTs;if(void 0!==n&&(0,_.a)(o.type)===(0,_.a)(r)&&(!l||o.sidecar)&&(null==i||l&&!i.sidecar||o.uploadToken&&!i.uploadToken||o.mmsThumb&&!i.mmsThumb||null==i.validatedTs||n>i.validatedTs)){if(!G(o.mediaKeyTs)){a=!0;continue}i=o}}}return i?{type:"ok",entry:i}:{type:"no-suitable-entry",keyExpired:a}})(e.mediaEntries,l);"ok"===u.type?(t=u.entry,i=3):(u.type,i=u.keyExpired?2:1)}return{maybeValidEntry:t,mediaKeyReuse:i,isMsgEntry:null!=a}}function B(e,r,l,t,i,a,u,o){return Q.apply(this,arguments)}function Q(){return(Q=i()((function*(e,r,l,t,i,a,u,o){var d,s,v,p,h,M,O={result:"success",uploaded:!1},b={result:"success",uploaded:!1};if(null==i.directPath&&null==i.url){var k=i.ciphertextHash;O=yield D(e,r,l,k,i,a,u,o)}if((0,y.f)(l)&&(!i.mmsThumb||null==i.mmsThumb.directPath)){var L;__LOG__(2)`MMS Thumbnail upload required`;var G=null==(L=i.mmsThumb)?void 0:L.ciphertextHash;if(G)b=yield J(e,l,G,i,u,o);else{__LOG__(2)`entry for ${l.id} missing mms thumb info when expected.`;var g=yield(0,n.J)(l.id);if(g){yield q(l,g);var x=(0,_.j)(l.type),U=yield(0,f.c)(i.cryptoKey,x),R=U.iv,T=U.cipherKey,w=U.hmacKey,j=yield(0,f.d)(T,R,w,x,g),I=j.ciphertext,S=j.ciphertextHash;yield(0,n.kc)(e,l.id,S),b=yield P(e,l,I,S,i,u,o)}}}if("success"===O.result&&"success"===b.result){var C=O.uploaded||b.uploaded;__LOG__(2)`uploadMedia all content has been uploaded`;var F=(0,m.D)();return(0,n.Gb)(e,l.id,F).then(()=>{var e,r;return{result:"success",uploaded:C,metric:null==(e=O)?void 0:e.metric,thumbMetric:null==(r=b)?void 0:r.metric}})}return"error"===O.result||"error"===b.result?(__LOG__(2)`uploadMedia found error when checking with server. aborting upload`,{result:"error",ack:(null==(d=O)?void 0:d.ack)||(null==(s=b)?void 0:s.ack)||c.a.FAILED,metric:null==(v=O)?void 0:v.metric,thumbMetric:null==(p=b)?void 0:p.metric}):(O.result,b.result,__LOG__(2)`uploadMedia disconnected from server. aborting upload`,{result:"disconnected",metric:null==(h=O)?void 0:h.metric,thumbMetric:null==(M=b)?void 0:M.metric})}))).apply(this,arguments)}function D(e,r,l,t,i,a,u,o){var d=(0,_.i)(l.type);return __LOG__(2)`Checking if media already exists on server`,W(t,i.uploadToken,d,a,u,1,o).then(t=>"needs-upload"===t.result?(__LOG__(2)`uploadMedia uploading media`,Y(d,i.cryptoKey,i.uploadToken,()=>(0,_.d)(r),a,u,1,t.metric).then(r=>"uploaded"===r.result?(0,n.jc)(e,l.id,r.directPath,r.url).then(()=>({result:"success",uploaded:!0,metric:t.metric})):r)):"success"===t.result?(0,n.jc)(e,l.id,t.directPath,t.url).then(()=>({result:"success",uploaded:!1,metric:t.metric})):t)}function J(e,r,l,t,i,a){return N.apply(this,arguments)}function N(){return(N=i()((function*(e,r,l,t,i,a){var u=(0,_.j)(r.type),o=yield(0,s.b)(u);if("no-hosts"===o){__LOG__(3)`uploadMedia no available hosts`;var d=Object.assign({},a,{overallUploadMode:7,overallUploadResult:17});return{result:"error",ack:c.a.FAILED,metric:d}}return"disconnected"===o?{result:"disconnected"}:(__LOG__(2)`Checking if mms thumb already exists on server`,W(l,t.uploadToken,u,o,i,7,a).then(l=>"needs-upload"===l.result?(__LOG__(2)`uploadMedia uploading media thumb`,Y(u,t.cryptoKey,t.uploadToken,()=>(0,n.J)(r.id),o,i,7,l.metric).then(l=>{if("uploaded"===l.result){var t=l.directPath;return void 0===t?{result:"error",ack:c.a.FAILED,metric:l.metric}:(0,n.lc)(e,r.id,t).then(()=>({result:"success",uploaded:!0,metric:l.metric}))}return l})):"success"===l.result&&l.directPath?(0,n.lc)(e,r.id,l.directPath).then(()=>({result:"success",uploaded:!1,metric:l.metric})):l))}))).apply(this,arguments)}function W(e,r,l,t,i,a,u){return X.apply(this,arguments)}function X(){return(X=i()((function*(e,r,l,t,i,a,u){var o=(0,O.b)(e,r,l,i),n=yield t.run(o,Object.assign({},u,{overallUploadMode:a,overallLastUploadRetryPhase:1}));if(null==n)return __LOG__(3)`uploadMedia resume check exhausted available retries`,{result:"error",ack:c.a.FAILED};var d=n.result,v=n.metric;return"found"===d.status?{result:"success",directPath:d.directPath,url:d.url,uploaded:!1,metric:Object.assign({},v,{overallIsFinal:!0,overallUploadResult:3,overallMediaKeyReuse:3})}:"auth-expired"===d.status?((0,s.l)(),{result:"error",ack:c.a.FAILED,metric:Object.assign({},v,{overallUploadResult:17,overallIsFinal:!0})}):"throttled"===d.status||"request-error"===d.status?{result:"error",ack:c.a.FAILED,metric:Object.assign({},v,{overallUploadResult:"throttled"===d.status?19:2,overallIsFinal:!0})}:(d.status,__LOG__(2)`checkCiphertextInServer content is gone from server. Proceed with reupload`,{result:"needs-upload",metric:v})}))).apply(this,arguments)}function Y(e,r,l,t,i,a,u,o){return Z.apply(this,arguments)}function Z(){return(Z=i()((function*(e,r,l,t,i,a,u,o){var n=yield t();if(!n)return __LOG__(3)`uploadMedia plaintext is gone`,{result:"error",ack:c.a.CONTENT_GONE,metric:Object.assign({},o,{overallUploadMode:u,overallUploadResult:11,overallCumT:a.cumulative(),overallT:a.elapsed(),overallIsFinal:!0})};var d=yield H(n,e,r),s=d.ciphertext,v=d.ciphertextHash;return ee((0,O.c)(e,s,l,v,a),i,u,o)}))).apply(this,arguments)}function ee(e,r,l,t){return r.run(e,Object.assign({},t,{overallLastUploadRetryPhase:2,overallUploadMode:l})).then(e=>{if(!e)return __LOG__(3)`uploadMedia retries exhausted`,{result:"error",ack:c.a.FAILED};var r=e.result,l=e.metric;if("ok"===r.type)return{result:"uploaded",directPath:r.directPath,url:r.url,metric:Object.assign({},l,{overallUploadResult:1,overallIsFinal:!0})};r.type;var t=Object.assign({},l,{overallUploadResult:"throttled"===r.error?19:9,overallIsFinal:!0});return __LOG__(3)`uploadMedia upload failed ${r.error}`,"payload-too-large"===r.error?{result:"error",ack:c.a.CONTENT_TOO_BIG,metric:t}:{result:"error",ack:c.a.FAILED,metric:t}})}}}]);