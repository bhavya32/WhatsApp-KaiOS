"use strict";(self.webpackJsonp=self.webpackJsonp||[]).push([[151],{706:function(t,e,a){a.r(e),a.d(e,"fetchTOSGatingAcceptanceStatus",(function(){return v})),a.d(e,"updateTOSGatingAcceptanceStatus",(function(){return g})),a.d(e,"maybeUpdateTOSStatusFromNotification",(function(){return y}));var n=a(30),c=a(4),r=a(51),u=a(249),i=a(12),s=a(72),o=a(14),d=a(6),p=a(17),_=a(88),S=new r.a("queryTOSGatingAcceptanceStatus",t=>{var e="unknown";return t.child("tos").forEachChildWithTag("notice",t=>{if(t.attrInt("id")===o.Y){var a="false"!==t.maybeAttrString("state");e=a?"accepted":"not-yet"}}),e}),f={400:(0,s.d)("bad-request"),500:(0,s.d)("server-error")};function O(t){(0,i.c)("event","tosGatingStatusChanged",{tosAccepted:t})}function G(){return(0,p.a)("tos_client_state_fetch_iteration")}function v(){var t=(0,c.w)("iq",{to:c.l,id:(0,c.u)(),xmlns:"tos",type:"get"},(0,c.w)("request",null,(0,c.w)("notice",{id:(0,c.f)(o.Y)}))),e=new u.a({name:"fetchTOSGatingAcceptanceStatus",timer:{algo:{type:"exponential",first:250}},code:e=>(0,n.b)(t,S).then(t=>{if(!t.success)switch((0,s.f)(t,f).error.reason){case"server-error":return"retry";case"bad-request":return void __LOG__(4)`fetchTOSGatingAcceptanceStatus: bad request`;default:return void __LOG__(3)`fetchTOSGatingAcceptanceStatus: unknown error`}switch(t.result){case"accepted":return d.N.set({status:"accepted",forcedFetchIteration:G()}).then(()=>{O("accepted")});case"not-yet":var e=d.N.get(),a=e.status,n=e.forcedFetchIteration;return"accepted"===a&&n>=G()?void __LOG__(3)`fetchTOSGatingAcceptanceStatus: already accepted, server says otherwise, skipping save`:d.N.set({status:"not-yet",forcedFetchIteration:G()}).then(()=>{O("not-yet")});default:return void __LOG__(3)`fetchTOSGatingAcceptanceStatus: fetched status is "unknown"`}}).then(t=>{null==t&&e()})});return e.start(),e.promise()}var l=new r.a("updateTOSGatingAcceptanceStatus",t=>{t.assertAttr("type","result")}),g=(0,_.c)().finalStep("updateStatus",(t,e)=>{if(e.notices.includes(o.Y)){if("accepted"===d.N.get().status){var a=(0,c.w)("iq",{to:c.l,id:(0,c.u)(),xmlns:"tos",type:"set"},(0,c.w)("request",{type:"session_update"},(0,c.w)("notice",{id:(0,c.f)(o.Y)}))),r=new u.a({name:"updateTOSGatingAcceptanceStatus",timer:{algo:{type:"exponential",first:250}},code:t=>(0,n.b)(a,l).then(t=>{if(!t.success)switch((0,s.f)(t,f).error.reason){case"server-error":return"retry";case"bad-request":return void __LOG__(4)`updateTOSGatingAcceptanceStatus: bad request`;default:return void __LOG__(3)`updateTOSGatingAcceptanceStatus: unknown error`}t.success,__LOG__(2)`updateTOSGatingAcceptanceStatus: updated server with the TOS status`}).then(e=>{"retry"!==e&&t()})});return r.start(),r.promise()}__LOG__(2)`updateTOSGatingAcceptanceStatus: received IB to update user notice state, but TOS are not accepted`}else __LOG__(2)`updateTOSGatingAcceptanceStatus: received IB to update user notice state, but it did not include valid notices`}).end();function y(t,e){if(t!==o.Y)return __LOG__(3)`maybeUpdateTOSStatusFromNotification: received unexpected notice id "${t}"`,Promise.resolve();var a=Object.assign({},d.N.get()),n=e?"accepted":"not-yet";return a.status=n,d.N.set(a).then(()=>O(n))}}}]);