"use strict";(self.webpackJsonp=self.webpackJsonp||[]).push([[15],{547:function(e,r,n){n.d(r,"a",(function(){return I})),n.d(r,"c",(function(){return x})),n.d(r,"b",(function(){return K}));var i=n(26),t=n.n(i),a=n(2),s=n(81),u=n(513),l=n(308),d=n(517),o=n(30),f=n(41),c=n(20),p=n(7),y=n(9),v=n(39),h=n(16),g=n(6),M=n(3),_=n(51),k=n(250),w=n(4),m=n(272),A=n(546),S=(n(201),n(297)),b=n(296);function G(e,r,n,i){return L.apply(this,arguments)}function L(){return(L=t()((function*(e,r,n,i){var t,a,s=(0,p.e)(g.t.get()),u=new Map,l=null!=i,d=n.dbMsg;if(r.length>1||l){var o=yield(0,A.a)(r,n,i?{ids:i,type:"primary"}:void 0);if(l&&0===o.nodes.length)return"skip-sender-backfill";t=(0,w.w)("participants",null,o.nodes),a=(0,m.a)(r.concat(s)),u=o.identityIds}else{var f=(0,p.e)(e),c=yield(0,b.e)(f,n),y=c.encNode,v=c.identityId;t=y,a=(0,m.a)([f,s]),v&&(u=new Map).set(f,v)}return{stanza:(0,w.w)("message",{id:(0,w.b)(d.externalId),to:(0,w.g)(e),type:(0,S.f)(d),edit:(0,S.a)(d),device_fanout:l?(0,w.b)("false"):w.c},(0,S.b)(d),(0,S.c)(d),(0,S.d)(d),t),phashPromise:a,identityIds:u}}))).apply(this,arguments)}function O(e,r,n){return W.apply(this,arguments)}function W(){return(W=t()((function*(e,r,n){var i,t,a=r.dbMsg,s="group"===r.type?r.jid:y.h,u=(0,S.e)(a),l=(0,m.a)(e.concat((0,p.e)(g.t.get()))),d=n?n.knowsSenderKey:new Map,o=!c.b(e,c.m(Array.from(d.keys()))),v=null,h=new Map;if(o)t=(v=yield(0,A.a)(e,r)).nodes,i=(0,b.b)(u),h=v.identityIds;else{var M=yield(0,b.d)(r),_=M.encNode,k=M.senderKeyBytes;i=_;var G=[],L=[],O=new Set;if(d.forEach((e,r)=>{if(e)L.push(r);else if(G.push(r),(0,p.r)(r)){var n=(0,p.h)(r);O.add(n)}}),G.length>0){var W={senderKeyDistributionMessage:{groupId:s,axolotlSenderKeyDistributionMessage:k}},I=c.m(G);t=(v=yield(0,A.b)(I,W)).nodes}if(h=yield(0,f.s)(e),s===y.h&&L.length>0){var D=t||[];L.forEach(e=>{var r=(0,p.h)(e);if(!O.has(r)){O.add(r);var n=(0,p.e)(r);D.push((0,w.w)("to",{jid:(0,w.g)(n)}))}}),t=D}}var x=null;t&&t.length&&(x=(0,w.w)("participants",null,[...t]));var z=a.expiration,E=yield l;return{stanza:(0,w.w)("message",{id:(0,w.b)(a.externalId),to:(0,w.g)(s),phash:(0,w.b)(E),type:(0,S.f)(a),edit:(0,S.a)(a),expiration:null!=z?(0,w.f)(z):w.c},(0,S.b)(a),(0,S.c)(a),(0,S.d)(a),x,i),phash:E,identityIds:h,isFanout:o}}))).apply(this,arguments)}function I(e,r){return"user"===e.type?x(e,r):(e.type,(function(e,r){return j(r,e)})(e,r))}var D=new _.a("sendMsgAck",e=>(e.assertTag("ack"),{phash:e.maybeAttrString("phash"),ts:e.attrTime("t"),errorCode:e.maybeAttrInt("error")}));function x(e,r,n){return z.apply(this,arguments)}function z(){return(z=t()((function*(e,r,n){var i=e.dbMsg,t=e.jid,s=(0,d.f)(e);if(t===g.t.get()){__LOG__(2)`encryptAndSendUserMsg self-send`;var l=(0,M.D)();return yield(0,u.a)(s,i.expiration,l,new Map),yield(0,u.d)([i.externalId],t,[{participant:(0,p.e)(t),ts:l}],"none"===g.k.get().readReceipts?a.a.RECEIVED:a.a.READ),"skip-self"}var f=yield G(t,r,e,n);if("skip-sender-backfill"===f)return f;var y=f.stanza,_=f.phashPromise,w=f.identityIds,m=yield E(w,[(0,p.e)(t)]),A=yield(0,o.f)(y,{id:i.externalId,class:"message",from:t,participant:null}),S=D.parse(A);if(S.error&&(__LOG__(4)`sendWrittenMsg failed to parse ack`,SEND_LOGS("sendWrittenMsg-one-to-one-ack-failed")),S.success&&403===S.success.errorCode)return g.I.get().mdBlocklistV2?(0,v.b)().fireAndForget(h.e.getBlocklistV2()):(0,v.b)().fireAndForget(h.e.getBlocklist()),yield(0,u.e)(s,a.a.FAILED),"error";var b,L=null!=n;if(S.success&&S.success.phash&&!L){var O=yield _;if(O!==S.success.phash){var W=i.type===a.f.REVOKED;if(WAM.log("regular",2180,void 0,[2,1,W,1,0,1]),W){var I=c.i(r)?c.l((0,p.e)(t)):r;return(0,v.b)().waitUntilPersisted(h.e.resendWrittenRevokeMsg(s,I,O)).then(()=>"skip-revoke")}yield(0,v.b)().waitUntilPersisted(h.e.senderBackfill(s,r,S.success.ts,m))}}return L?S.success&&(yield(0,u.b)(s,t,r,S.success.ts)):(yield(0,u.a)(s,i.expiration,null==(b=S.success)?void 0:b.ts,w||new Map),yield(0,k.d)(t,i.ts)),"sent"}))).apply(this,arguments)}function E(e,r){return F.apply(this,arguments)}function F(){return(F=t()((function*(e,r){var n=new Map;if(e.size>0)e.forEach((e,r)=>{(0,p.r)(r)&&n.set(r,e)});else{var i=r.filter(p.r);n=yield(0,f.s)(i)}return n}))).apply(this,arguments)}function K(e,r){return j(r,e)}function j(e,r){return C.apply(this,arguments)}function C(){return(C=t()((function*(e,r){var n=r.dbMsg,i=(0,d.f)(r);if(0===e.length)return __LOG__(2)`encryptAndSendMultiReceipientMsg empty group`,yield(0,u.e)(i,a.a.READ),"skip-self";var t,s="group"===r.type?r.jid:y.h,l=yield P(s),f=yield O(e,r,l),c=f.stanza,g=f.identityIds,M=f.phash,_=f.isFanout,k=yield E(g,e),w=yield(0,o.f)(c,{id:n.externalId,class:"message",from:s,participant:null}),m=D.parse(w);if(m.success&&m.success.phash&&m.success.phash!==M){var A=n.type===a.f.REVOKED,S=s===y.h?3:2;if(WAM.log("regular",2180,void 0,[2,1,A,1,0,S]),A)return(0,v.b)().waitUntilPersisted(h.e.resendWrittenRevokeMsg(i,e,M)).then(()=>"skip-revoke");yield(0,v.b)().waitUntilPersisted(h.e.senderBackfill(i,e,m.success.ts,k)).then(()=>{var e=(0,p.p)(s);e&&(0,v.b)().fireAndForget(h.e.queryGroup(e,"phash",M))})}if(m.error)__LOG__(4)`sendWrittenMsg: Error ack received ${m.error}`;else{if(null!=m.success.errorCode)return yield(0,u.e)(i,a.a.FAILED),"error";t=m.success.ts}return yield(0,u.a)(i,n.expiration,t,g,{isFanout:_,participantsInfo:l,to:e}),"sent"}))).apply(this,arguments)}var N=new s.a;function P(e){return N.enqueue(t()((function*(){var r=yield(0,l.a)(e);return r?(0,l.c)(r)?(yield(0,f.c)(e),(0,l.e)(e)):r:null})))}}}]);