"use strict";(self.webpackJsonp=self.webpackJsonp||[]).push([[62],{630:function(e,i,t){t.r(i),t.d(i,"handleDevicesNotification",(function(){return p}));var d=t(114),n=t(4),o=t(22),a=t(41),s=t(7),c=t(71),r=t(134),v=t(322),f=t(523),u=t(39),_=t(16),h=t(20),l=new d.b("devicesNotification",e=>{var i,t;if(e.assertTag("notification"),e.assertAttr("type","devices"),e.hasChild("remove"))t="remove",i=e.child("remove");else{if(!e.hasChild("add")){if(e.hasChild("update"))return i=e.child("update"),{type:"sidelist",from:e.attrPhoneUserJid("from"),stanzaId:e.attrString("id"),hash:i.attrString("hash")};throw __LOG__(4)`Devices notification without 'remove' and 'add' nodes`,SEND_LOGS("unknown-devices-notification"),new Error("Failed to parse devices notification")}t="add",i=e.child("add")}var d=i.mapChildrenWithTag("device",e=>({id:(0,s.f)(e.attrPhoneDeviceJid("jid")),index:(0,c.g)(e,"key-index")||c.b})),n=i.child("key-index-list"),o="add"===t?{type:"device_added_notification",devicesToAdd:d,adv:(0,r.c)(n.contentBytes()),stanzaTs:n.attrTime("ts")}:{type:"device_removed_notification",devicesToRemove:d,advTs:n.attrInt("ts")};return{type:"contact",stanzaId:e.attrString("id"),hash:i.attrString("device_hash"),from:e.attrPhoneUserJid("from"),unverifiedUSyncResponse:o}}),p=(0,d.c)("handleDevicesNotification",l,e=>{var i,t=e.from;return"sidelist"===e.type?(i=e.hash,(0,f.a)(i).then(e=>(__LOG__(2)`handleDevicesNotification side list update for ${e}`,(0,u.b)().waitUntilPersisted(_.e.syncDeviceList((0,h.m)(e)))))).then(()=>m(e)):(0,v.a)([t]).then(()=>(0,r.h)(t,e.unverifiedUSyncResponse).then(i=>{if(i){var d=(0,a.w)(t,i),n=(0,o.jb)(t,{usyncResponse:i},e.hash);return Promise.all([d,n])}}).then(()=>m(e)))});function m(e){var i=e.from,t=e.stanzaId;return(0,n.w)("ack",{to:(0,n.g)(i),id:(0,n.b)(t),type:(0,n.b)("devices"),class:"notification"})}}}]);