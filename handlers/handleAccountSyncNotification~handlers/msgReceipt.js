"use strict";(self.webpackJsonp=self.webpackJsonp||[]).push([[22],{576:function(n,t,e){e.d(t,"a",(function(){return si}));var r=e(580),i=e(101),o=e(4),a="setting_pushName",c=e(349),s=e(3),u=e(6),l=e(443),_=e(26),d=e.n(_),f=e(377),y=e(209),v=128,h=new ArrayBuffer(v),p=new class{constructor(n){this.salt=n}add(n,t){var e=this;return t.reduce((function(){var n=d()((function*(n,t){return e.cB(yield n,t)}));return function(t,e){return n.apply(this,arguments)}})(),Promise.resolve(n))}subtract(n,t){var e=this;return t.reduce((function(){var n=d()((function*(n,t){return e.cC(yield n,t)}));return function(t,e){return n.apply(this,arguments)}})(),Promise.resolve(n))}subtractThenAdd(n,t,e){var r=this;return d()((function*(){return r.add(yield r.subtract(n,e),t)}))()}cB(n,t){var e=this;return d()((function*(){var r=yield(0,y.a)(t,e.salt,v);return e.performPointwiseWithOverflow(n,r,(n,t)=>n+t)}))()}cC(n,t){var e=this;return d()((function*(){var r=yield(0,y.a)(t,e.salt,v);return e.performPointwiseWithOverflow(n,r,(n,t)=>n-t)}))()}performPointwiseWithOverflow(n,t,e){for(var r=new DataView(n),i=new DataView(t),o=new ArrayBuffer(r.byteLength),a=new DataView(o),c=0;c<r.byteLength;c+=2)a.setUint16(c,e(r.getUint16(c,!0),i.getUint16(c,!0)),!0);return o}}("WhatsApp Patch Integrity");function S(n){return(0,f.d)(["CollectionVersionStore"],t=>t.CollectionVersionStore.get(n))}function O(n){return(0,f.d)(["CollectionVersionStore"],t=>(function(n,t){return n.CollectionVersionStore.get(t).then(n=>{var t;return null!=(t=null==n?void 0:n.ltHash)?t:new ArrayBuffer(v)})})({CollectionVersionStore:t.CollectionVersionStore},n))}function I(n){return(0,f.d)(["CollectionVersionStore"],t=>t.CollectionVersionStore.bulkGet(n))}function A(n,t,e){return(0,f.d)(["CollectionVersionStore"],r=>r.CollectionVersionStore.update(n,{version:t,ltHash:e}))}function E(n){return(0,f.d)(["CollectionVersionStore"],t=>t.CollectionVersionStore.get(n).then(n=>null==n?void 0:n.isCollectionInMacMismatchFatal))}function T(n){return(0,f.d)(["CollectionVersionStore"],t=>t.CollectionVersionStore.update(n,{isCollectionInMacMismatchFatal:!0}))}function m(){return(0,f.d)(["MissingKeyStore"],n=>n.MissingKeyStore.getAll())}function M(n){return(0,f.d)(["MissingKeyStore"],t=>t.MissingKeyStore.bulkGet(n))}function N(n){return(0,f.d)(["MissingKeyStore"],t=>t.MissingKeyStore.bulkUpdate(n))}function L(n){return(0,f.d)(["PendingMutationStore"],t=>t.PendingMutationStore.getByCollection(n))}function w(n){return(0,f.d)(["SyncActionStore"],t=>t.SyncActionStore.get(n))}function C(n){return(0,f.d)(["SyncActionStore"],t=>t.SyncActionStore.getByCollections(n))}function G(n){return(0,f.d)(["SyncActionStore"],t=>t.SyncActionStore.getByIndexMacs(n))}function P(n){return(0,f.d)(["SyncKeyStore"],t=>t.SyncKeyStore.get(n))}function R(){return(0,f.d)(["SyncKeyStore"],n=>n.SyncKeyStore.getAll())}function $(n){return(0,f.d)(["SyncKeyStore"],t=>t.SyncKeyStore.set(n))}var g,D,b=e(60),k=(D=g=class{static loadStatesFromDb(){var n=this;return d()((function*(){(yield(0,f.d)(["CollectionVersionStore"],n=>n.CollectionVersionStore.getAll())).forEach(t=>n.collectionStates.set(t.collection,{collection:t.collection,state:t.state,finiteFailureStartTime:t.finiteFailureStartTime}))}))()}static persistToDb(){var n,t=[];return this.collectionStates.forEach(n=>t.push(n)),__LOG__(2)`syncd: state machine persistToDb. states:`,t.forEach(n=>{var t=null==n.finiteFailureStartTime?"":`(failure start: ${n.finiteFailureStartTime})`;__LOG__(2)`syncd: ${n.collection}: ${n.state} ${t}`}),n=t,(0,f.d)(["CollectionVersionStore"],t=>t.CollectionVersionStore.bulkUpdate(n))}static clean(){this.collectionStates=new Map}static getCollectionState(n){var t=this.collectionStates.get(n);return t?t.state:(this.moveCollectionsToUpToDate([n]),b.d.UpToDate)}static getCollectionsInStateDirty(){var n=[];return this.collectionStates.forEach(t=>{t.state===b.d.Dirty&&n.push(t.collection)}),n}static getCollectionsInStateRetry(){var n=[];return this.collectionStates.forEach(t=>{t.state===b.d.FailingFiniteRetry&&n.push(t.collection)}),n}static getCollectionsInStateFatal(){var n=[];return this.collectionStates.forEach(t=>{t.state===b.d.Fatal&&n.push(t.collection)}),n}static getCollectionsInStateBlocked(){var n=[];return this.collectionStates.forEach(t=>{t.state===b.d.Blocked&&n.push(t.collection)}),n}static moveCollectionsToUpToDate(n){n.forEach(n=>this.collectionStates.set(n,{collection:n,state:b.d.UpToDate,finiteFailureStartTime:void 0}))}static moveCollectionsToDirty(n){n.forEach(n=>{var t;return this.collectionStates.set(n,{collection:n,state:b.d.Dirty,finiteFailureStartTime:null==(t=this.collectionStates.get(n))?void 0:t.finiteFailureStartTime})})}static moveCollectionsToFiniteRetry(n){n.forEach(n=>{var t,e;return this.collectionStates.set(n,{collection:n,state:b.d.FailingFiniteRetry,finiteFailureStartTime:null!=(t=null==(e=this.collectionStates.get(n))?void 0:e.finiteFailureStartTime)?t:(0,s.E)()})})}static moveCollectionsToFatal(n){n.forEach(n=>this.collectionStates.set(n,{collection:n,state:b.d.Fatal}))}static moveCollectionsToBlocked(n){n.forEach(n=>{var t;return this.collectionStates.set(n,{collection:n,state:b.d.Blocked,finiteFailureStartTime:null==(t=this.collectionStates.get(n))?void 0:t.finiteFailureStartTime})})}static getExpiredCollections(){var n=[];return this.collectionStates.forEach(t=>{var e;t.state===b.d.FailingFiniteRetry&&(null==t.finiteFailureStartTime?(e=1/0,__LOG__(3)`Collection ${t.collection} is in finite retry state with no failure start time`):e=t.finiteFailureStartTime,e+b.g<(0,s.E)()&&n.push(t.collection))}),n}static getCollectionMinFailureTime(){var n=Array.from(this.collectionStates.values()).filter(n=>n.state===b.d.FailingFiniteRetry).map(n=>n.finiteFailureStartTime).filter(Boolean);return 0===n.length?null:Math.min(...n)}},g.collectionStates=new Map,D),U=e(348);function x(){return(0,f.a)().syncdDisabled()}var H=e(43),B=e(126),F=new Map;function V(n){return K.apply(this,arguments)}function K(){return(K=d()((function*(n){var t,e=(0,H.d)((0,B.b)(n)),r=F.get(e);return r?r.keyData:((r=yield P(n))&&F.set(e,r),null==(t=r)?void 0:t.keyData)}))).apply(this,arguments)}var Y=e(69),X=e(302),W=e(75),j=e(175)({ABOUT_TO_APPLY_MUTATIONS:"ABOUT_TO_APPLY_MUTATIONS",APPLIED_MUTATIONS:"APPLIED_MUTATIONS",MUTATIONS_DECRYPTED:"MUTATIONS_DECRYPTED",REQUEST_BUILT:"REQUEST_BUILT",RESPONSE_RECEIVED:"RESPONSE_RECEIVED",RESPONSE_PARSED_VALID:"RESPONSE_PARSED_VALID",ENTERED_RETRY_MODE:"ENTERED_RETRY_MODE",MISSING_KEYS_RECEIVED:"MISSING_KEYS_RECEIVED"}),Z=e(175)({PATCH_MUTATIONS:"PATCH_MUTATIONS",SNAPSHOT_MUTATIONS:"SNAPSHOT_MUTATIONS"});function z(n){(0,X.a)(Y.a.SYNCD_CRITICAL_BOOTSTRAP_STAGE).endSuccess({string:{criticalBootstrapStage:{type:n}.type}})}function J(n,t){z(j.MUTATIONS_DECRYPTED),(0,X.a)(Y.a.SYNCD_DECRYPT_MUTATIONS).endSuccess((function(n){var t,e=n.type,r=n.mutations,i=0,o=[];return r.forEach(n=>{var e=n.binarySyncData,r=(0,W.a)(c.a,e).value;null!=r&&(r.archiveChatAction?t=r.archiveChatAction.messageRange:r.markChatAsReadAction?t=r.markChatAsReadAction.messageRange:r.clearChatAction?t=r.clearChatAction.messageRange:r.deleteChatAction&&(t=r.deleteChatAction.messageRange),null!=t&&(i+=t.messages.length,o.push(t.messages.length)))}),{string:{mutationType:e},int:{count:r.length,totalAdditionalMessagesCount:i},int_array:{messageRangeLengths:o}}})({type:n,mutations:t}))}var q=e(175)({PATCH_PROTOBUF_SERIALIZATION_FAILED:"PATCH_PROTOBUF_SERIALIZATION_FAILED",MUTATIONS_PROTOBUF_SERIALIZATION_FAILED:"MUTATIONS_PROTOBUF_SERIALIZATION_FAILED",ACTION_DATA_PROTOBUF_SERIALIZATION_FAILED:"ACTION_DATA_PROTOBUF_SERIALIZATION_FAILED",ENCRYPTION_FAILED:"ENCRYPTION_FAILED",MISSING_SNAPSHOT_VERSION:"MISSING_SNAPSHOT_VERSION",MISSING_SNAPSHOT_MAC:"MISSING_SNAPSHOT_MAC",MISSING_SNAPSHOT_KEY_ID:"MISSING_SNAPSHOT_KEY_ID",MISSING_PATCH_VERSION:"MISSING_PATCH_VERSION",PATCH_WITH_BOTH_INLINE_AND_EXTERNAL_MUTATIONS:"PATCH_WITH_BOTH_INLINE_AND_EXTERNAL_MUTATIONS",MISSING_PATCH_SNAPSHOT_MAC:"MISSING_PATCH_SNAPSHOT_MAC",MISSING_PATCH_MAC:"MISSING_PATCH_MAC",MISSING_PATCH_KEY_ID:"MISSING_PATCH_KEY_ID",MISSING_EXTERNAL_BLOB_REFERENCE_MEDIA_KEY:"MISSING_EXTERNAL_BLOB_REFERENCE_MEDIA_KEY",MISSING_EXTERNAL_BLOB_REFERENCE_DIRECT_PATH:"MISSING_EXTERNAL_BLOB_REFERENCE_DIRECT_PATH",MISSING_EXTERNAL_BLOB_REFERENCE_FILE_SHA256:"MISSING_EXTERNAL_BLOB_REFERENCE_FILE_SHA256",MISSING_EXTERNAL_BLOB_REFERENCE_FILE_ENC_SHA256:"MISSING_EXTERNAL_BLOB_REFERENCE_FILE_ENC_SHA256",MISSING_MUTATION_OPERATION:"MISSING_MUTATION_OPERATION",MISSING_MUTATION_RECORD:"MISSING_MUTATION_RECORD",MISSING_MUTATION_INDEX:"MISSING_MUTATION_INDEX",MISSING_MUTATION_VALUE:"MISSING_MUTATION_VALUE",MISSING_MUTATION_KEY_ID:"MISSING_MUTATION_KEY_ID",EXTERNAL_BLOB_REFERENCE_PROTOBUF_DESERIALIZATION_FAILED:"EXTERNAL_BLOB_REFERENCE_PROTOBUF_DESERIALIZATION_FAILED",SNAPSHOT_PROTOBUF_DESERIALIZATION_FAILED:"SNAPSHOT_PROTOBUF_DESERIALIZATION_FAILED",PATCH_PROTOBUF_DESERIALIZATION_FAILED:"PATCH_PROTOBUF_DESERIALIZATION_FAILED",MUTATIONS_PROTOBUF_DESERIALIZATION_FAILED:"MUTATIONS_PROTOBUF_DESERIALIZATION_FAILED",ACTION_DATA_PROTOBUF_DESERIALIZATION_FAILED:"ACTION_DATA_PROTOBUF_DESERIALIZATION_FAILED",MISSING_ACTION_INDEX:"MISSING_ACTION_INDEX",MISSING_ACTION_VERSION:"MISSING_ACTION_VERSION",SNAPSHOT_MAC_MISMATCH_IN_SNAPSHOT:"SNAPSHOT_MAC_MISMATCH_IN_SNAPSHOT",SNAPSHOT_MAC_MISMATCH_IN_PATCH:"SNAPSHOT_MAC_MISMATCH_IN_PATCH",MAC_MISMATCH_PATCH:"MAC_MISMATCH_PATCH",DECRYPTION_FAILED:"DECRYPTION_FAILED",DUPLICATE_PATCH_VERSION_IN_COLLECTION:"DUPLICATE_PATCH_VERSION_IN_COLLECTION",SAME_INDEX_FOR_MULTIPLE_MUTATIONS_IN_PATCH:"SAME_INDEX_FOR_MULTIPLE_MUTATIONS_IN_PATCH",SAME_INDEX_FOR_MULTIPLE_MUTATIONS_IN_SNAPSHOT:"SAME_INDEX_FOR_MULTIPLE_MUTATIONS_IN_SNAPSHOT",MISSING_ACTION_VALUE:"MISSING_ACTION_VALUE",MISSING_ACTION_TIMESTAMP:"MISSING_ACTION_TIMESTAMP",XMPP_BAD_REQUEST_FOR_COLLECTION:"XMPP_BAD_REQUEST_FOR_COLLECTION",XMPP_NOT_FOUND_FOR_COLLECTION:"XMPP_NOT_FOUND_FOR_COLLECTION",CYCLIC_MUTATION_DEPENDENCY_IN_PATCH:"CYCLIC_MUTATION_DEPENDENCY_IN_PATCH",SERVER_DID_NOT_SEND_ALL_PATCHES:"SERVER_DID_NOT_SEND_ALL_PATCHES",TERMINAL_PATCH_MISSING_DATA:"TERMINAL_PATCH_MISSING_DATA",TERMINAL_PATCH_DESERIALIZATION_ERROR:"TERMINAL_PATCH_DESERIALIZATION_ERROR",TERMINAL_PATCH_UNKNOWN:"TERMINAL_PATCH_UNKNOWN",INVALID_ACTION_INDEX:"INVALID_ACTION_INDEX",XMPP_BAD_REQUEST_GLOBAL_ERROR:"XMPP_BAD_REQUEST_GLOBAL_ERROR",XMPP_NOT_FOUND_GLOBAL_ERROR:"XMPP_NOT_FOUND_GLOBAL_ERROR",XMPP_BAD_METHOD_GLOBAL_ERROR:"XMPP_BAD_METHOD_GLOBAL_ERROR",XMPP_NOT_ACCEPTABLE_GLOBAL_ERROR:"XMPP_NOT_ACCEPTABLE_GLOBAL_ERROR",TOO_MANY_INTERNAL_SERVER_ERRORS_IN_7D:"TOO_MANY_INTERNAL_SERVER_ERRORS_IN_7D",TIMEOUT_WHILE_WAITING_FOR_MISSING_KEY:"TIMEOUT_WHILE_WAITING_FOR_MISSING_KEY",MISSING_KEY_ON_ALL_CLIENTS:"MISSING_KEY_ON_ALL_CLIENTS"});function Q(n,t,e,r,i){(0,X.a)(Y.a.SYNCD_FATAL_ERROR).endFail("syncd fatal error: "+n,(function(n){var t=n.collection;return{string:{errorCode:n.type,collection:null==t?null:t},int:{patchSnapshotMutationCount:n.patchSnapshotMutationCount,patchVersion:n.patchVersion},bool:{isFatal:n.isFatal}}})({type:n,collection:t,patchSnapshotMutationCount:e,patchVersion:r,isFatal:i}))}var nn=e(8),tn=e.n(nn),en=e(120),rn=e(84);function on(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"?";if(null==n)throw new Error("Unexpected null or undefined: "+t);return n}var an=e(0),cn=e(175)({SET:0,REMOVE:1}),sn=Object.assign({},null),un=Object.assign({},null),ln=Object.assign({},null),_n=Object.assign({},null),dn=Object.assign({},null),fn=Object.assign({},null),yn=Object.assign({},null),vn=Object.assign({},null),hn=Object.assign({},null),pn=Object.assign({},null),Sn=Object.assign({},null);sn.internalSpec={version:[1,an.d.UINT64]},un.internalSpec={code:[1,an.d.UINT64],text:[2,an.d.STRING]},ln.internalSpec={blob:[1,an.d.BYTES]},_n.internalSpec={blob:[1,an.d.BYTES]},dn.internalSpec={id:[1,an.d.BYTES]},fn.internalSpec={index:[1,an.d.MESSAGE,ln],value:[2,an.d.MESSAGE,_n],keyId:[3,an.d.MESSAGE,dn]},yn.internalSpec={mediaKey:[1,an.d.BYTES],directPath:[2,an.d.STRING],handle:[3,an.d.STRING],fileSizeBytes:[4,an.d.UINT64],fileSha256:[5,an.d.BYTES],fileEncSha256:[6,an.d.BYTES]},vn.internalSpec={version:[1,an.d.MESSAGE,sn],records:[2,an.b.REPEATED|an.d.MESSAGE,fn],mac:[3,an.d.BYTES],keyId:[4,an.d.MESSAGE,dn]},hn.internalSpec={mutations:[1,an.b.REPEATED|an.d.MESSAGE,pn]},pn.internalSpec={operation:[1,an.d.ENUM,cn],record:[2,an.d.MESSAGE,fn]},Sn.internalSpec={version:[1,an.d.MESSAGE,sn],mutations:[2,an.b.REPEATED|an.d.MESSAGE,pn],externalMutations:[3,an.d.MESSAGE,yn],snapshotMac:[4,an.d.BYTES],patchMac:[5,an.d.BYTES],keyId:[6,an.d.MESSAGE,dn],exitCode:[7,an.d.MESSAGE,un],deviceIndex:[8,an.d.UINT32]};var On=e(416),In=e(279),An=e(144),En=[];function Tn(){var n=new Map;return En.push(n),n}var mn=128,Mn=16;function Nn(){return(Nn=d()((function*(n){var t=yield Ln(n);return{indexKey:t.slice(0,32),valueEncryptionKey:t.slice(32,64),valueMacKey:t.slice(64,96),snapshotMacKey:t.slice(96,mn),patchMacKey:t.slice(mn,160)}}))).apply(this,arguments)}function Ln(n){return(0,y.a)((0,B.a)(n),"WhatsApp Mutation Keys",160)}new ArrayBuffer(32);var wn,Cn,Gn,Pn=(wn=function(n){return Nn.apply(this,arguments)},Cn=n=>(0,H.d)((0,B.a)(n)),function(){Gn||(Gn=Tn());var n=Cn(...arguments),t=Gn.get(n);return null==t&&(t=wn(...arguments),Gn.set(n,t)),t});function Rn(n,t){return(0,An.d)(new Uint8Array(n),new Uint8Array(t))}function $n(n,t){var e,r=(0,B.b)(t);switch(n){case cn.SET:e="0x01";break;case cn.REMOVE:e="0x02"}if(e){var i=new Uint8Array([parseInt(e,16)]).buffer,o=new Uint8Array(i.byteLength+r.byteLength);return o.set(new Uint8Array(i)),o.set(new Uint8Array(r),i.byteLength),o.buffer}throw new Error("invalid mutation operation value")}function gn(n,t){var e=Math.max(0,0-n-t),r=new Uint8Array(e);return self.crypto.getRandomValues(r),r.buffer}function Dn(n,t,e){return(0,In.c)(t,e,n)}function bn(n,t,e){var r=new Uint8Array(8);r.set([n.byteLength],r.byteLength-1);var i=(0,U.b)([n,t,r.buffer]);return(0,An.e)(e,i,32)}function kn(n,t,e){return(0,In.b)(t,n,e)}function Un(n,t,e,r){return(0,An.d)(n,(0,U.b)([t,e,r]))}function xn(n,t,e,r,i){return(0,An.d)(n,(0,U.b)([t,...e,r,i]))}function Hn(n){var t=n.byteLength;return new Uint8Array(n).slice(t-32).buffer}var Bn=e(347),Fn=e(175)({MISSING_MUTATION_TO_REMOVE:"MISSING_MUTATION_TO_REMOVE"}),Vn=e(175)({SNAPSHOT_USED:"SNAPSHOT_USED",SNAPSHOT_NOT_USED:"SNAPSHOT_NOT_USED"}),Kn=e(175)({APP_STATE_SYNC_KEY_EXPIRY:"APP_STATE_SYNC_KEY_EXPIRY",DEVICE_DEREGISTERATION:"DEVICE_DEREGISTERATION",NO_KEYS:"NO_KEYS"});function Yn(n){var t=(0,X.a)(Y.a.SYNCD_BOOTSTRAP_APP_STATE_DOWNLOAD);"success"!==n.isSuccess?t.endFail("syncd error: Error downloading snapshot or patches",Zn(n)):t.endSuccess(Zn(n))}function Xn(n,t,e){var r;(0,X.a)(Y.a.SYNCD_BOOTSTRAP_DATA_APPLIED).endSuccess({string:{collection:(r={collection:n,snapshotUsed:t,durationMs:e}).collection},bool:{snapshot:r.snapshotUsed===Vn.SNAPSHOT_USED},int:{durationMs:r.durationMs}})}function Wn(n,t){var e;(0,X.a)(Y.a.SYNCD_CRITICAL_EVENT).endFail("syncd critical event: "+n,{string:{criticalEventCode:(e={type:n,collection:t}).type,collection:null==e.collection?null:e.collection}})}function jn(n){(0,X.a)(Y.a.SYNCD_KEY_ROTATION).endSuccess({string:{keyRotationEventCode:{type:n}.type}})}function Zn(n){return{string:{collection:n.collection},int:{downloadSize:n.downloadSize,downloadStartTs:n.downloadStartTs},bool:{isSuccess:"success"===n.isSuccess}}}var zn=class{constructor(){this.event=(0,X.a)(Y.a.SYNCD)}end(){arguments.length>0&&void 0!==arguments[0]&&arguments[0]?this.event.endFail("syncd failed"):this.event.endSuccess()}mark(n,t){this.event.addPoint(n,(function(n){var t={};return Object.keys(n).forEach(e=>{"number"==typeof n[e]?(null==t.int&&(t.int={}),t.int[e]=n[e]):"string"==typeof n[e]&&(null==t.string&&(t.string={}),t.string[e]=n[e])}),Object.keys(t).length>0?t:void 0})(t))}};function Jn(n,t){var e=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r="string"==typeof n?n:(0,U.a)(n),i="string"==typeof t?t:(0,U.a)(t),o=e?-16:0;return`${r.slice(o)}:${i.slice(o)}`}var qn=new TextDecoder;function Qn(){return(Qn=d()((function*(n,t){var e=t.mac,r=t.version,i=t.keyId,o=t.records,a=yield V(i.id);if(!a)throw new Bn.b;var c=new Map(o.map(n=>[(0,U.a)(n.index.blob),Hn(n.value.blob)]));__LOG__(2)`syncd:
${n} snapshot macsToAdd:
    ${Array.from(c.entries()).map(n=>{var t=tn()(n,2);return Jn(t[0],t[1])}).join("\n\t")}`;var s=yield p.add(h,Array.from(c.values())),u=(yield Pn(a)).snapshotMacKey,l=(0,U.g)(r.version),_=(0,U.h)(n).buffer;return __LOG__(2)`syncd: validating snapshot mac for ${n} snapshot v${r.version}:
ltHash: ${(0,U.a)(s)}
encoded version: ${(0,U.a)(l)}
encoded collection: ${(0,U.a)(_)}
expected snapshotMAC: ${(0,U.a)(e)}`,yield rt(n,e,u,s,l,_,!0,o.length,t.version.version),s}))).apply(this,arguments)}function nt(){return(nt=d()((function*(n,t,e){var r=t.version,i=t.mutations,o=t.snapshotMac,a=t.patchMac,c=t.keyId.id,s=yield V(c);if(!s)throw new Bn.b;var u=yield Pn(s),l=u.snapshotMacKey,_=u.patchMacKey,f=i.map(n=>({operation:n.operation,indexMac:n.record.index.blob,valueMac:Hn(n.record.value.blob)})),y=yield ut(n,f,e),v=(0,U.g)(r.version),h=(0,U.h)(n).buffer;__LOG__(2)`syncd: validating snapshot and patch mac for ${n} v${r.version}:
expected snapshotMAC: ${(0,U.a)(o)}
expected patchMAC: ${(0,U.a)(a)}
encoded version: ${(0,U.a)(v)}
encoded collection: ${(0,U.a)(h)}
key ID: ${(0,U.a)((0,B.b)(c))}`;try{yield ot(n,a,_,o,f.map(n=>n.valueMac),v,h,i.length,r.version),yield rt(n,o,l,y,v,h,!1,i.length,r.version)}catch(n){throw yield(function(){return p.apply(this,arguments)})(),n}return y;function p(){return(p=d()((function*(){var t=yield ft(n,!1),e=new Map(t.map(n=>{var t=n.indexMac,e=n.valueMac;return[(0,U.a)(t),(0,U.a)(e)]}));__LOG__(2)`syncd: error on incoming records:
\t${f.map(n=>{var t=n.operation,r=n.indexMac,i=n.valueMac;return`${t===cn.SET?"set":"remove"} | ${Jn(r,i,!1)} | ${e.has((0,U.a)(r))?"found":"did not find"} indexMAC in the above logged macs`}).join("\n\t")}`}))).apply(this,arguments)}}))).apply(this,arguments)}function tt(n,t){return et.apply(this,arguments)}function et(){return(et=d()((function*(n,t){var e=yield S(n).then(n=>{var t;return null!=(t=null==n?void 0:n.version)?t:0});if(e!==t-1){var r=e>t-1?"greater-than-expected":"less-than-expected";throw __LOG__(3)`syncd: ${n} received patch v${t} !== latest local version (v${e}) + 1`,SEND_LOGS("syncd-version-check-error-local-version-"+r),new Bn.c("syncd-version-check-error-local-version-"+r)}var i=yield O(n);if((0,en.a)(i,h)&&1!==t)throw __LOG__(3)`syncd: empty local lthash found when processing ${n} patch v${t}`,SEND_LOGS("syncd-empty-lthash-on-mac-mismatch"),new Bn.c("empty lthash")}))).apply(this,arguments)}function rt(n,t,e,r,i,o,a,c,s){return it.apply(this,arguments)}function it(){return(it=d()((function*(n,t,e,r,i,o,a,c,s){var u,l=(0,f.a)().syncdShouldNotFatalOnSnapshotMacMismatchInPatches()&&!a,_=null!=(u=yield E(n))&&u;if(l&&_)__LOG__(2)`syncd: collection ${n} is already in snapshot mac mismatch so not checking again`;else{var d=yield Un(e,r,i,o);if(!(0,en.a)(d,t)){if(__LOG__(3)`syncd: unable to validate snapshot mac.`,SEND_LOGS("syncd: unable to validate snapshot mac."),a||(yield tt(n,s)),Q(a?q.SNAPSHOT_MAC_MISMATCH_IN_SNAPSHOT:q.SNAPSHOT_MAC_MISMATCH_IN_PATCH,n,c,s,!l),l)return yield T(n),void __LOG__(2)`syncd: skip fatal after snapshot mac mismatch for collection ${n}`;throw new Bn.a("unable to validate snapshot mac")}}}))).apply(this,arguments)}function ot(n,t,e,r,i,o,a,c,s){return at.apply(this,arguments)}function at(){return(at=d()((function*(n,t,e,r,i,o,a,c,s){var u=yield xn(e,r,i,o,a);if(!(0,en.a)(u,t))throw yield tt(n,s),Q(q.MAC_MISMATCH_PATCH,n,c,s),__LOG__(3)`syncd: unable to validate patch mac.`,SEND_LOGS("syncd: unable to validate patch mac."),new Bn.a("unable to validate patch mac")}))).apply(this,arguments)}function ct(n,t,e,r){return st.apply(this,arguments)}function st(){return(st=d()((function*(n,t,e,r){var i=(yield S(n).then(n=>{var t;return null!=(t=null==n?void 0:n.version)?t:b.f}))+1,o=yield Pn(r),a=o.patchMacKey,c=o.snapshotMacKey,s=(0,U.g)(i),u=(0,U.h)(n).buffer,l=yield Un(c,t,s,u),_=yield xn(a,l,e.map(n=>n.valueMac),s,u);return __LOG__(2)`syncd: computing snapshot and patch macs for outgoing patch ${n} v${i}:
encoded version: ${(0,U.a)(s)}
encoded collection: ${(0,U.a)(u)}
snapshotMAC: ${(0,U.a)(l)}
patchMAC: ${(0,U.a)(_)}`,{snapshotMac:l,patchMac:_}}))).apply(this,arguments)}function ut(n,t,e){return lt.apply(this,arguments)}function lt(){return(lt=d()((function*(n,t,e){var r=yield O(n),i=yield _t(t.map(n=>n.indexMac)),o=new Map,a=new Map,c=new Map;yield(0,On.a)(t,(function(){var t=d()((function*(t){var r=t.indexMac,s=t.valueMac,u=t.operation,l=qn.decode(r),_=i.get(l);if(_)u===cn.REMOVE?a.set((0,U.a)(r),_):c.set((0,U.a)(r),_);else if(u===cn.REMOVE){var d,y,v=yield(function(n){return null==e?Promise.resolve(null):e(n)})(r);null!=v?(a.set((0,U.a)(r),v),__LOG__(3)`syncd: had to use fallbackQueryForValueMac in collection ${n} for platform ${null!=(d=(0,f.a)().primaryPlatform())?d:"[empty]"}: ${(0,U.a)(r).slice(-16)}
}`,SEND_LOGS("syncd: fallback query")):(Wn(Fn.MISSING_MUTATION_TO_REMOVE,n),__LOG__(3)`syncd: missing indexMAC in sync-actions table for REMOVE mutation in collection ${n} for platform ${null!=(y=(0,f.a)().primaryPlatform())?y:"[empty]"}:
${(0,U.a)(r).slice(-16)}`)}u===cn.SET&&o.set((0,U.a)(r),s)}));return function(n){return t.apply(this,arguments)}})());var s=yield p.subtractThenAdd(r,Array.from(o.values()),Array.from(a.values()).concat(Array.from(c.values())));return __LOG__(2)`syncd: computing ltHash for ${n}:
currentLtHash: ${(0,U.a)(r)}
macsToAdd:
    ${Array.from(o.entries()).map(n=>{var t=tn()(n,2);return Jn(t[0],t[1])}).join("\n\t")}
macsToRemove:
    ${Array.from(a.entries()).map(n=>{var t=tn()(n,2);return Jn(t[0],t[1])}).join("\n\t")}
macsToOverwrite (also remove):
    ${Array.from(c.entries()).map(n=>{var t=tn()(n,2);return Jn(t[0],t[1])}).join("\n\t")}
newLtHash: ${(0,U.a)(s)}`,s}))).apply(this,arguments)}function _t(n){return dt.apply(this,arguments)}function dt(){return(dt=d()((function*(n){var t=yield G(n);return new Map(t.map(n=>[qn.decode(n.indexMac),n.valueMac]))}))).apply(this,arguments)}function ft(n){return yt.apply(this,arguments)}function yt(){return(yt=d()((function*(n){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],e=t?20:1;__LOG__(2)`syncd: logMacs: ${n}: prepare`;var r=yield(0,f.d)(["SyncActionStore","CollectionVersionStore"],t=>{var e=t.SyncActionStore,r=t.CollectionVersionStore;return Promise.all([r.get(n).then(n=>null==n?void 0:n.version),e.getByCollections([n])])}),i=tn()(r,2),o=i[0],a=i[1];if(__LOG__(2)`syncd: current snapshot ${n} v${o} with ${a.length} mutations:`,t&&a.length>100)return a;var c=a.reduce((n,r,i)=>(i%e==0&&n.push(""),n[n.length-1]+=Jn(r.indexMac,r.valueMac,t)+" | ",n),[]);return c.forEach(n=>__LOG__(2)`|${n}`),a}))).apply(this,arguments)}function vt(n,t){return n.map(n=>{var e,r,o=(e=n.binarySyncAction,r=(0,W.a)(c.b,e),(0,i.a)(c.a,{value:r}).readBuffer());return{index:n.index,action:n.action,binarySyncData:o,actionState:t,version:n.version,keyId:n.keyId,indexMac:n.indexMac,valueMac:n.valueMac,collection:n.collection,timestamp:n.timestamp}})}function ht(n,t,e,r,i){return{index:n.index,binarySyncData:n.binarySyncData,version:n.version,keyId:n.keyId,indexMac:n.indexMac,valueMac:n.valueMac,collection:n.collection,timestamp:n.timestamp,action:e,actionState:t,modelId:r,modelType:null!=i?i:void 0}}function pt(n){return null==n}function St(n){switch(n){case b.b.CriticalBlock:case b.b.CriticalUnblockLow:return!0;case b.b.Regular:case b.b.RegularHigh:case b.b.RegularLow:return!1}}function Ot(n,t){try{return(0,W.a)(vn,t)}catch(t){throw Q(q.SNAPSHOT_PROTOBUF_DESERIALIZATION_FAILED,n),new Bn.a("snapshot protobuf deserialization failed")}}function It(n,t){try{return(0,W.a)(hn,t)}catch(t){throw Q(q.MUTATIONS_PROTOBUF_DESERIALIZATION_FAILED,n),new Bn.a("mutations protobuf deserialization failed")}}function At(n,t){try{return(0,W.a)(c.a,t)}catch(t){throw Q(q.ACTION_DATA_PROTOBUF_DESERIALIZATION_FAILED,n),new Bn.a("action data protobuf deserialization failed")}}var Et=class{static validateSyncActionDataProtobuf(n,t){var e=t.index,r=t.value,i=t.padding,o=t.version;if(!e)throw Q(q.MISSING_ACTION_INDEX,n),new Bn.a("missing action index");if(null==o)throw Q(q.MISSING_ACTION_VERSION,n),new Bn.a("missing action version");return{index:e,value:r,padding:i,version:o}}},Tt=new TextDecoder;function mt(){return(mt=d()((function*(n,t){return yield Promise.all(t.records.map(t=>Nt(n,cn.SET,t)))}))).apply(this,arguments)}function Mt(){return(Mt=d()((function*(n,t){return yield Promise.all(t.mutations.map(t=>Nt(n,t.operation,t.record)))}))).apply(this,arguments)}function Nt(n,t,e){return Lt.apply(this,arguments)}function Lt(){return(Lt=d()((function*(n,t,e){var r=e.keyId.id,i=yield V(r);if(!i){if(t===cn.REMOVE)throw new Bn.a("no key data for remove mutations");throw new Bn.b}var o=yield wt(n,r,i,t,e),a=o.syncAction,c=o.indexMac,s=o.valueMac,u=o.indexValueBinary,l=a.index,_=a.version;return{index:Tt.decode(l),action:null,version:_,keyId:r,operation:t,indexMac:c,valueMac:s,collection:n,binarySyncData:u}}))).apply(this,arguments)}function wt(n,t,e,r,i){return Ct.apply(this,arguments)}function Ct(){return(Ct=d()((function*(n,t,e,r,i){var o=i.index.blob,a=i.value.blob,c=Hn(a),s=(0,U.d)(a,Mn,a.byteLength-32-Mn),u=s[0],l=s[1],_=s[2],d=yield Pn(e),f=d.indexKey,y=d.valueEncryptionKey,v=d.valueMacKey,h=(0,U.b)([u,l]),p=$n(r,t),S=yield bn(p,h,v);if(!(0,en.a)(_,S))throw Q(q.DECRYPTION_FAILED,n),new Bn.a("decryption failure: valueMAC mismatch");var O=yield kn(new Uint8Array(u),y,l),I=At(n,O),A=Et.validateSyncActionDataProtobuf(n,I),E=yield Rn(f,A.index);if(!(0,en.a)(o,E))throw Q(q.DECRYPTION_FAILED,n),new Bn.a("decryption failure: indexMAC mismatch");return{syncAction:A,indexMac:o,valueMac:c,indexValueBinary:O}}))).apply(this,arguments)}var Gt,Pt=null,Rt=null;function $t(n){return null==Pt&&(Pt=new Map((0,f.a)().syncdActionHandlers().map(n=>[n.action,n]))),Pt.get(n)}function gt(){return null==Rt&&(Rt=Math.max(...(0,f.a)().syncdActionHandlers().map(n=>n.version))),Rt}function Dt(){return(0,f.d)(["MissingKeyStore"],n=>(function(n){return bt.apply(this,arguments)})({MissingKeyStore:n.MissingKeyStore}))}function bt(){return(bt=d()((function*(n){var t=n.MissingKeyStore;clearTimeout(Gt),Gt=null;var e=yield t.getAll();if(0!==e.length){__LOG__(2)`syncd: _setMissingKeyTimeout: missing keys: ${e.map(n=>(0,U.e)(n.keyId))}`;var r=e.reduce((n,t)=>n.timestamp<t.timestamp?n:t),i=(0,f.a)().syncdWaitForKeyTimeoutDays()*s.a-(-r.timestamp+(0,s.E)());__LOG__(2)`syncd: earliest missing key: ${(0,U.e)(r.keyId)}, timestamp=${r.timestamp}, timeoutMs=${i}`,Gt=setTimeout(kt,i)}}))).apply(this,arguments)}function kt(){return Ut.apply(this,arguments)}function Ut(){return(Ut=d()((function*(){__LOG__(2)`syncd: _timeoutWhileWaitingForMissingKey`,(yield xt())?(Q(q.TIMEOUT_WHILE_WAITING_FOR_MISSING_KEY),__LOG__(4)`syncd: fatal error: timeout while waiting for missing key`,SEND_LOGS("syncd fatal error: timeout while waiting for missing key"),(0,f.b)().handleSyncdFatal()):__LOG__(2)`syncd: _timeoutWhileWaitingForMissingKey: no expired keys`}))).apply(this,arguments)}function xt(){return Ht.apply(this,arguments)}function Ht(){return(Ht=d()((function*(){__LOG__(2)`syncd: check if has expired keys`;var n=(yield R()).map(n=>(0,U.e)(n.keyId));__LOG__(2)`syncd: all keys: ${n}`;var t=yield m();__LOG__(2)`syncd: missing keys: ${t.map(n=>(0,U.e)(n.keyId))}`;var e=t.filter(t=>!n.includes(t.keyHex));__LOG__(2)`syncd: actually missing keys: ${t.map(n=>(0,U.e)(n.keyId))}`;var r=e.filter(n=>(0,f.a)().syncdWaitForKeyTimeoutDays()*s.a<(0,s.E)()-n.timestamp);return __LOG__(2)`syncd: expired keys: ${r.map(n=>(0,U.e)(n.keyId))}`,r.length>0}))).apply(this,arguments)}function Bt(n,t){return Ft.apply(this,arguments)}function Ft(){return(Ft=d()((function*(n,t){var e=n.map(n=>{return{keyHex:(0,U.e)(n),keyId:n,timestamp:(0,s.E)(),deviceResponses:(e=new Map,t.forEach(n=>e.set(n,null)),e)};var e});yield N(e),yield Dt()}))).apply(this,arguments)}var Vt=(0,B.d)(new ArrayBuffer(0));function Kt(n,t){return Yt.apply(this,arguments)}function Yt(){return(Yt=d()((function*(n,t){var e=new Set,r=(yield R()).map(n=>(0,U.e)(n.keyId));t.records.forEach(n=>{var t=n.keyId.id;if((0,U.f)(t,Vt))throw new Bn.a("snapshot has empty key");var i=(0,U.e)(t);r.includes(i)||e.add(i)}),__LOG__(2)`syncd: collection ${n}'s snapshot has missing keys ${Array.from(e)}`,yield jt(e)}))).apply(this,arguments)}function Xt(n,t){return Wt.apply(this,arguments)}function Wt(){return(Wt=d()((function*(n,t){var e=new Set,r=(yield R()).map(n=>(0,U.e)(n.keyId));t.forEach(n=>{var t=n.keyId.id;if((0,U.f)(t,Vt))throw new Bn.a("syncd: patch has empty key. patch device id: ${p.deviceIndex}");var i=(0,U.e)(t);r.includes(i)||(__LOG__(2)`syncd: handleMissingKeysInPatches: missing key: keyId: ${i}, patch version: ${n.version.version}, patch device id: ${n.deviceIndex}`,e.add(i))}),__LOG__(2)`syncd: collection ${n}'s patches has missing keys ${Array.from(e)}`,yield jt(e)}))).apply(this,arguments)}function jt(n){return Zt.apply(this,arguments)}function Zt(){return(Zt=d()((function*(n){if("idle"===(0,f.a)().offlineProcessingState()){var t=Array.from(n);__LOG__(2)`syncd: _handleMissingKeys: missing keys [${t}]`;var e=new Set((yield M(t)).filter(Boolean).map(n=>n.keyHex)),r=t.filter(n=>!e.has(n));if(__LOG__(2)`syncd: _handleMissingKeys: missing keys after filter: [${r}]`,0===r.length)return Promise.resolve();var i=r.map(n=>(0,B.d)((0,U.c)(n).buffer)),o=yield(0,f.b)().sendSyncdKeyRequest(i);yield Bt(i,o)}else __LOG__(2)`syncd: _handleMissingKeys: skipping due to resume from restart in progress`}))).apply(this,arguments)}var zt=class n{static validateSnapshotProtobuf(t,e){var r=e.version,i=e.records,o=e.mac,a=e.keyId,c=null==r?void 0:r.version;if(!r||null==c)throw Q(q.MISSING_SNAPSHOT_VERSION,t),new Bn.a("missing snapshot version");var s=i.map(e=>n.validateRecordProtobuf(t,e));if(!o)throw Q(q.MISSING_SNAPSHOT_MAC,t),new Bn.a("missing snapshot mac");var u=n.validateKeyIdProtobuf(t,a,q.MISSING_SNAPSHOT_KEY_ID);return{version:{version:(0,rn.e)(c)},records:s,mac:o,keyId:u}}static validatePatchProtobuf(t,e){var r=e.version,i=e.mutations,o=e.externalMutations,a=e.snapshotMac,c=e.patchMac,s=e.keyId,u=e.exitCode,l=e.deviceIndex,_=null==r?void 0:r.version;if(!r||null==_)throw Q(q.MISSING_PATCH_VERSION,t),new Bn.a("missing patch version");if(i&&i.length>0&&o)throw Q(q.PATCH_WITH_BOTH_INLINE_AND_EXTERNAL_MUTATIONS,t),new Bn.a("patch with both inline and external mutations");if(!a)throw Q(q.MISSING_PATCH_SNAPSHOT_MAC,t),new Bn.a("missing patch snapshot mac");if(!c)throw Q(q.MISSING_PATCH_MAC,t),new Bn.a("missing patch mac");var d=n.validateKeyIdProtobuf(t,s,q.MISSING_PATCH_KEY_ID);if(o){var f=n.validateExternalBlobReference(t,o);return{version:{version:(0,rn.e)(_)},mutations:void 0,externalMutations:f,snapshotMac:a,patchMac:c,keyId:d,deviceIndex:l}}var y=i.map(e=>n.validateMutationProtobuf(t,e));return{version:{version:(0,rn.e)(_)},mutations:y,externalMutations:void 0,exitCode:u,snapshotMac:a,patchMac:c,keyId:d,deviceIndex:l}}static validateExternalBlobReference(n,t){var e=t.mediaKey,r=t.directPath,i=t.handle,o=t.fileSizeBytes,a=t.fileSha256,c=t.fileEncSha256;if(!e)throw Q(q.MISSING_EXTERNAL_BLOB_REFERENCE_MEDIA_KEY,n),new Bn.a("missing external blob reference media key");if(null==r)throw Q(q.MISSING_EXTERNAL_BLOB_REFERENCE_DIRECT_PATH,n),new Bn.a("missing external blob reference direct path");if(!a)throw Q(q.MISSING_EXTERNAL_BLOB_REFERENCE_FILE_SHA256,n),new Bn.a("missing external blob reference file SHA256");if(!c)throw Q(q.MISSING_EXTERNAL_BLOB_REFERENCE_FILE_ENC_SHA256,n),new Bn.a("missing external blob reference file enc SHA256");return{mediaKey:e,directPath:r,handle:i,fileSizeBytes:o,fileSha256:a,fileEncSha256:c}}static validateMutationProtobuf(t,e){var r=e.operation,i=e.record;if(null==r)throw Q(q.MISSING_MUTATION_OPERATION,t),new Bn.a("missing mutation operation");if(!i)throw Q(q.MISSING_MUTATION_RECORD,t),new Bn.a("missing mutation record");return{operation:r,record:n.validateRecordProtobuf(t,i)}}static validateRecordProtobuf(t,e){var r=e.index,i=e.value,o=e.keyId,a=null==r?void 0:r.blob,c=null==i?void 0:i.blob;if(!r||!a)throw Q(q.MISSING_MUTATION_INDEX,t),new Bn.a("missing mutation index");if(!i||!c)throw Q(q.MISSING_MUTATION_VALUE,t),new Bn.a("missing mutation value");return{index:{blob:a},value:{blob:c},keyId:n.validateKeyIdProtobuf(t,o,q.MISSING_MUTATION_KEY_ID)}}static validateKeyIdProtobuf(n,t,e){var r=null==t?void 0:t.id;if(!t||!r)throw Q(e,n),new Bn.a("missing mutation key id");return{id:(0,B.d)(r)}}};function Jt(n,t){return qt.apply(this,arguments)}function qt(){return(qt=d()((function*(n,t){var e=Ot(n,yield(0,f.b)().downloadSyncBlob(t,"snapshot",n));return zt.validateSnapshotProtobuf(n,e)}))).apply(this,arguments)}function Qt(n,t){return ne.apply(this,arguments)}function ne(){return(ne=d()((function*(n,t){var e=yield(0,f.b)().downloadSyncBlob(t,"patch",n);return It(n,e).mutations.map(t=>zt.validateMutationProtobuf(n,t))}))).apply(this,arguments)}var te=e(594),ee=e.n(te),re=new Map;function ie(n){var t=[],e=[];try{return n.forEach(r=>{t.push(r);var i=re.get(r.actionName);null!=i&&n.forEach(n=>{var t,o,a,c;n!==r&&i.includes(n.actionName)&&(o=r,a=(t=n).actionHandler.getChatJidAndMessageKey(t),c=o.actionHandler.getChatJidAndMessageKey(o),a&&c&&a.chatJid===c.chatJid&&(null==a.messageKey||null==c.messageKey||a.messageKey===c.messageKey))&&(n.timestamp<r.timestamp?e.push([n,r]):e.push([r,n]))})}),ee.a.array(t,e)}catch(n){throw Q(q.CYCLIC_MUTATION_DEPENDENCY_IN_PATCH),new Bn.a("cyclic mutation dependency in patch")}}function oe(n,t){return ae.apply(this,arguments)}function ae(){return(ae=d()((function*(n,t){var e=yield Promise.all(n.map((function(){var n=d()((function*(n){var e=t.get(n.index);if(e){var r=n.actionHandler;return{remoteMutationIndex:n.index,conflictResolutionState:yield r.resolveConflicts(e,n)}}}));return function(t){return n.apply(this,arguments)}})())),r=new Map;return e.forEach(n=>{n&&r.set(n.remoteMutationIndex,n.conflictResolutionState)}),r}))).apply(this,arguments)}function ce(n,t){return se.apply(this,arguments)}function se(){return(se=d()((function*(n,t){var e=[],r=[],i=yield L(n),o=new Map(i.map(n=>[n.index,n])),a=yield oe(t,o);t.forEach(n=>{var t=a.get(n.index);if(t)switch(t){case b.e.SkipRemote:break;case b.e.ApplyRemoteAndDropLocal:e.push(n),r=r.concat(i.filter(t=>t.index===n.index));break;case b.e.SkipRemoteAndDropLocal:r=r.concat(i.filter(t=>t.index===n.index))}else e.push(n)});for(var c=ie(e),s=[],u=0;u<c.length;u++){var l=c[u].actionHandler;(yield l.dropMutationDueToCrossIndexConflict(c[u],o))||s.push(c[u])}return{remoteMutationsToApply:s,pendingMutationsToDrop:r.map(n=>n.id).filter(Boolean)}}))).apply(this,arguments)}function ue(n,t){var e=new Set;t.forEach(t=>{var r=t.version.version;if(e.has(r))throw Q(q.DUPLICATE_PATCH_VERSION_IN_COLLECTION,n),new Bn.a("duplicate patch version in collection");e.add(r)})}function le(n,t,e){var r=new Set,i=new Set;t.forEach(t=>{var o=!1;if(t.operation===cn.SET&&(r.has(t.index)?o=!0:r.add(t.index)),t.operation===cn.REMOVE&&(i.has(t.index)?o=!0:i.add(t.index)),o)switch(e){case b.i.Patch:throw Q(q.SAME_INDEX_FOR_MULTIPLE_MUTATIONS_IN_PATCH,n),new Bn.a("same index for multiple mutations in patch");case b.i.Snapshot:throw Q(q.SAME_INDEX_FOR_MULTIPLE_MUTATIONS_IN_SNAPSHOT,n),new Bn.a("same index for multiple mutations in snapshot");case b.i.Local:__LOG__(3)`validation not required for local mutations`}})}function _e(n,t){return t.map(t=>{var e=(0,W.a)(c.a,t.binarySyncData).value;if(!e)throw Q(q.MISSING_ACTION_VALUE,n),new Bn.a("missing action value");var r=(0,rn.d)(e.timestamp);if(null==r)throw Q(q.MISSING_ACTION_TIMESTAMP,n),new Bn.a("missing action timestamp");return{index:t.index,version:t.version,keyId:t.keyId,indexMac:t.indexMac,valueMac:t.valueMac,collection:t.collection,binarySyncData:t.binarySyncData,timestamp:r}})}var de=e(78),fe={mutationCount:0,invalidActionCount:0,unsupportedActionCount:0,keyRotationRemoveCount:0,storedMutationCount:0,uploadConflictCount:0,unsetActionCount:0,missingKeyCount:0},ye=new de.a((function(){var n,t=(n=fe,{int:Object.assign({},n)});fe={mutationCount:0,invalidActionCount:0,unsupportedActionCount:0,keyRotationRemoveCount:0,storedMutationCount:0,uploadConflictCount:0,unsetActionCount:0,missingKeyCount:0},(0,X.a)(Y.a.APP_STATE_SYNC_DAILY).endSuccess(t)}));function ve(){ye.onOrBefore(3e5)}function he(n){0!==n&&(fe.mutationCount+=n,ve())}function pe(n){0!==n&&(fe.keyRotationRemoveCount+=n,ve())}function Se(){fe.uploadConflictCount++,ve()}var Oe=new ArrayBuffer(128);function Ie(n,t,e){return Ae.apply(this,arguments)}function Ae(){return(Ae=d()((function*(n,t,e){var r=n.name,i=n.version,o=n.patches,a=n.snapshot,c=n.syncedPendingMutationsId,s=n.syncedEncryptedMutations;__LOG__(2)`syncd: start applying collection ${r}`;try{var u,l;null==e||e.mark("external_mutations_download_start",{patchCount:null==(u=n.patches)?void 0:u.length,snapshotSizeBytes:null==(l=n.snapshot)?void 0:l.fileSizeBytes});var _=yield me(r,o,a,t),d=tn()(_,2),y=d[0],v=d[1];null==e||e.mark("external_mutations_download_end",{patchesWithMutationsCount:null==v?void 0:v.length,snapshotRecordsCount:null==y?void 0:y.records.length});var h=performance.now();if(null!=y)yield we(r,y,v,e),__LOG__(2)`syncd: ${r} snapshot and patches applied successfully`;else if(null!=v){var p=Math.min.apply(Math,v.map(n=>n.version.version));if(null!=t&&p>t+1&&v.length>0){var S=yield m();if(__LOG__(2)`syncd: missing keys: [${S.map(n=>n.keyHex+":"+n.timestamp)}]`,__LOG__(2)`syncd: has missing patches. collection: ${r}, localVersion: ${t},
minPatch: ${p}`,__LOG__(4)`syncd: has missing patches`,SEND_LOGS("syncd: has missing patches"),(0,f.a)().syncdShouldFatalOnMissingPatch())throw Q(q.SERVER_DID_NOT_SEND_ALL_PATCHES,r,void 0,null!=t?t:0),new Bn.a("syncd: has missing patches")}yield Re(r,v,e),__LOG__(2)`syncd: ${r} patches applied successfully`}else null!=i?(yield Ee(r,i,c,s),__LOG__(2)`syncd: ${r} v${i} uploaded successfully`):(pt(t)&&(yield A(r,0,Oe)),__LOG__(2)`syncd: sync ${r} but there are no updates`);var O=Math.floor(performance.now()-h);return __LOG__(2)`syncd: applyAppStateSyncResponse: finished applying ${r} in ${O}ms`,(v||y)&&pt(t)&&!St(r)&&Xn(r,null!=y?Vn.SNAPSHOT_USED:Vn.SNAPSHOT_NOT_USED,O),yield ft(n.name),n}catch(n){var I=n.message;return n instanceof Bn.b?(__LOG__(3)`syncd: key error: ${r} missing keys`,{name:r,state:b.c.Blocked}):n instanceof Bn.a?(__LOG__(4)`syncd: fatal error: ${r} throws ${I}`,SEND_LOGS(`syncd: fatal error: ${String(r)} throws ${I}`),{name:r,state:b.c.ErrorFatal}):(__LOG__(3)`syncd: retryable error: ${r} throws ${I}`,SEND_LOGS(`syncd: retryable error: ${String(r)} throws ${I}`),{name:r,state:b.c.ErrorRetry})}}))).apply(this,arguments)}function Ee(n,t,e,r){return Te.apply(this,arguments)}function Te(){return(Te=d()((function*(n,t,e,r){var i;yield ft(n);var o=r.map(n=>({indexMac:n.indexMac,valueMac:n.valueMac,operation:n.operation})),a=yield ut(n,o),c=vt(r.filter(n=>n.operation===cn.SET),b.h.Success),s=null!=(i=yield S(n).then(n=>null==n?void 0:n.version))?i:0;t!==s+1&&(__LOG__(4)`syncd: _uploadSuccessful: unexpected server version (${t}) after patch upload, expected ${s+1}`,SEND_LOGS("syncd: unexpected server version after patch upload")),__LOG__(2)`syncd: _uploadSuccessful: write to db for ${n}`,yield(0,f.d)(["SyncActionStore","PendingMutationStore","CollectionVersionStore"],(function(){var r=d()((function*(r){var i=r.SyncActionStore,o=r.PendingMutationStore,s=r.CollectionVersionStore;yield i.bulkSet(c),yield o.bulkRemove(e),yield s.update(n,{version:t,ltHash:a})}));return function(n){return r.apply(this,arguments)}})()),__LOG__(2)`syncd: end _uploadSuccessful for ${n}`}))).apply(this,arguments)}function me(n,t,e,r){return Me.apply(this,arguments)}function Me(){return(Me=d()((function*(n,t,e,r){var i=Promise.resolve(),o=0,a=(0,s.E)();if(null!=e){var c,u=zt.validateExternalBlobReference(n,e);o+=(0,rn.e)(null!=(c=u.fileSizeBytes)?c:0),__LOG__(2)`syncd: download snapshot for ${n}`,i=Jt(n,u)}var l,_,f=Promise.resolve();if(null!=t&&t.length>0){var y=t.map(t=>zt.validatePatchProtobuf(n,t));f=Promise.all(y.map((function(){var t=d()((function*(t){var e,r=t.mutations||[],i=t.externalMutations;return i&&(__LOG__(2)`syncd: download patch for ${n}`,r=yield Qt(n,i),__LOG__(2)`syncd: ${n}'s external patch downloaded`,o+=(0,rn.e)(null!=(e=i.fileSizeBytes)?e:0)),{mutations:r,version:t.version,snapshotMac:t.snapshotMac,patchMac:t.patchMac,keyId:t.keyId,exitCode:t.exitCode,deviceIndex:t.deviceIndex}}));return function(n){return t.apply(this,arguments)}})()))}try{var v=yield Promise.all([i,f]),h=tn()(v,2);l=h[0],_=h[1],pt(r)&&Yn({collection:n,downloadStartTs:a,downloadSize:o,isSuccess:"success"})}catch(t){throw pt(r)&&Yn({collection:n,downloadStartTs:a,downloadSize:o,isSuccess:"failure"}),t}return[l,_]}))).apply(this,arguments)}function Ne(n){return{measuredComputeLtHashAndValidateSnapshot:(function(){var t=d()((function*(t,e){null==n||n.mark("anti_tampering_start",{source:b.i.Snapshot});var r=yield(function(n,t){return Qn.apply(this,arguments)})(t,e);return null==n||n.mark("anti_tampering_end",{source:b.i.Snapshot}),r}));return function(n,e){return t.apply(this,arguments)}})(),measuredTryDecryptSnapshot:(function(){var t=d()((function*(t,e){null==n||n.mark("decryption_start",{source:b.i.Snapshot});var r=yield(function(n,t){return mt.apply(this,arguments)})(t,e);return null==n||n.mark("decryption_end",{source:b.i.Snapshot}),r}));return function(n,e){return t.apply(this,arguments)}})()}}function Le(n){return{measuredComputeLtHashAndValidatePatch:(function(){var t=d()((function*(t,e,r){null==n||n.mark("anti_tampering_start",{source:b.i.Patch});var i=yield(function(n,t,e){return nt.apply(this,arguments)})(t,e,r);return null==n||n.mark("anti_tampering_end",{source:b.i.Patch}),i}));return function(n,e,r){return t.apply(this,arguments)}})(),measuredTryDecryptPatch:(function(){var t=d()((function*(t,e){null==n||n.mark("decryption_start",{source:b.i.Patch});var r=yield(function(n,t){return Mt.apply(this,arguments)})(t,e);return null==n||n.mark("decryption_end",{source:b.i.Patch}),r}));return function(n,e){return t.apply(this,arguments)}})()}}function we(n,t,e,r){return Ce.apply(this,arguments)}function Ce(){return(Ce=d()((function*(n,t,e,r){yield ft(n);try{var i=Ne(r),o=i.measuredComputeLtHashAndValidateSnapshot,a=i.measuredTryDecryptSnapshot;null==r||r.mark("apply_start",{source:b.i.Snapshot,snapshotRecordsCount:t.records.length}),__LOG__(2)`syncd: start validate ${n}'s snapshot`;var c=yield o(n,t);__LOG__(2)`syncd: collection ${n}'s snapshot validated`;var s=yield a(n,t);__LOG__(2)`syncd: collection ${n}'s snapshot decrypted`,he(t.records.length),J(Z.SNAPSHOT_MUTATIONS,s),le(n,s,b.i.Snapshot);var u=t.version.version,l=yield be(n,s,b.i.Snapshot,r),_=l.setMutationsToPersist,y=l.pendingMutationsToDrop;__LOG__(2)`syncd: processed ${s.length} mutations in snapshot of collection ${n} v${u}`,__LOG__(2)`syncd: collection ${n}'s snapshot v${u} applied`,null==r||r.mark("update_DB_start",{source:b.i.Snapshot,setMutationsToPersistCount:_.length,pendingMutationsToDropCount:y.length}),yield(0,f.d)(["SyncActionStore","PendingMutationStore","CollectionVersionStore"],(function(){var t=d()((function*(t){var e=t.SyncActionStore,r=t.PendingMutationStore,i=t.CollectionVersionStore;yield e.bulkSet(_),yield r.bulkRemove(y),yield i.update(n,{version:u,ltHash:c})}));return function(n){return t.apply(this,arguments)}})()),null==r||r.mark("update_DB_end",{source:b.i.Snapshot}),__LOG__(2)`syncd: completed applying snapshot for ${n}`,null==r||r.mark("apply_end",{source:b.i.Snapshot,decryptedMutationsCount:s.length})}catch(e){throw e instanceof Bn.b&&(yield Kt(n,t)),e}e&&(null==r||r.mark("apply_start",{source:b.i.Patch,patchCount:e.length}),yield Re(n,e,r),null==r||r.mark("apply_end",{source:b.i.Patch,patchCount:e.length}))}))).apply(this,arguments)}function Ge(n){return Pe.apply(this,arguments)}function Pe(){return(Pe=d()((function*(n){if(n>(0,f.a)().syncdMaxMutationsToProcessDuringResume()){var t=Date.now();__LOG__(2)`syncd: patches have ${n} mutations, wait for UI unblock`,yield(0,f.b)().handleSyncDelayApplyingPatchUntilUIUnblocks(),__LOG__(2)`syncd: UI is unblocked, waited for ${Date.now()-t}ms`}}))).apply(this,arguments)}function Re(n,t,e){return $e.apply(this,arguments)}function $e(){return($e=d()((function*(n,t,e){if(0===t.length)return __LOG__(2)`syncd: no patches for collection ${n}`,Promise.resolve();ue(n,t),t.sort((n,t)=>n.version.version>t.version.version?1:-1);try{var r=t.reduce((n,t)=>n+t.mutations.length,0);yield Ge(r);for(var i=0;i<t.length;i++)yield ge(n,t[i],e)}catch(e){throw e instanceof Bn.b&&(yield Xt(n,t)),e}}))).apply(this,arguments)}function ge(n,t,e){return De.apply(this,arguments)}function De(){return(De=d()((function*(n,t,e){if(yield ft(n),t.exitCode){var r,i=t.exitCode.code;switch(i){case 100:Q(q.TERMINAL_PATCH_MISSING_DATA,n);break;case 101:Q(q.TERMINAL_PATCH_DESERIALIZATION_ERROR,n);break;default:Q(q.TERMINAL_PATCH_UNKNOWN,n)}throw new Bn.a(`received terminal patch with exit code:  ${String(i)} text: ${String(null==(r=t.exitCode)?void 0:r.text)}  `)}yield(0,f.b)().handleSyncBeforeApplyPatch(t);var o=t.mutations.filter(n=>n.operation===cn.SET).length,a=t.mutations.length-o;__LOG__(2)`syncd: applying patch ${n} v${t.version.version} from device ${t.deviceIndex}
SET count: ${o}
REMOVE count: ${a}`,0===o&&0===a&&(__LOG__(3)`syncd: ${n}: empty patch found`,SEND_LOGS(`syncd: ${n}: empty patch found`));var c=Le(e),s=c.measuredComputeLtHashAndValidatePatch,u=c.measuredTryDecryptPatch,l=yield s(n,t,(function(n){return A.apply(this,arguments)}));__LOG__(2)`syncd: completed computeLtHashAndValidatePatch for ${n} v${t.version.version}`;var _=yield u(n,t);J(Z.PATCH_MUTATIONS,_),he(_.length),le(n,_,b.i.Patch);var y=Be(_),v=y.filter(n=>n.operation===cn.REMOVE);yield Ue(n,v),__LOG__(2)`syncd: completed _applyRemoveMutations for ${n} v${t.version.version}`;var h=y.filter(n=>n.operation===cn.SET),p=yield be(n,h,b.i.Patch,e),S=p.setMutationsToPersist,O=p.pendingMutationsToDrop;__LOG__(2)`syncd: processed ${_.length} mutations in patch version ${t.version.version} of collection ${n}`,null==e||e.mark("update_DB_start",{source:b.i.Patch,setMutationsToPersistCount:S.length,pendingMutationsToDropCount:O.length});var I=t.version.version;function A(){return(A=d()((function*(t){var e;return null==(e=(yield C([n])).filter(n=>(0,en.a)(t,n.indexMac)).pop())?void 0:e.valueMac}))).apply(this,arguments)}yield(0,f.d)(["SyncActionStore","PendingMutationStore","CollectionVersionStore"],(function(){var t=d()((function*(t){var e=t.SyncActionStore,r=t.PendingMutationStore,i=t.CollectionVersionStore;yield e.bulkRemove(v.map(n=>n.index)),yield e.bulkSet(S),yield r.bulkRemove(O),yield i.update(n,{version:I,ltHash:l})}));return function(n){return t.apply(this,arguments)}})()),null==e||e.mark("update_DB_end",{source:b.i.Patch}),__LOG__(2)`syncd: completed final transaction in _applyPatch for ${n} v${t.version.version}`}))).apply(this,arguments)}function be(n,t,e,r){return ke.apply(this,arguments)}function ke(){return(ke=d()((function*(n,t,e,r){z(j.ABOUT_TO_APPLY_MUTATIONS);var i=e===b.i.Local?" (individual mutations)":"",o=[],a=Fe(n,_e(n,t)),s=a.supportedMutations;a.unsupportedMutations.forEach(n=>o.push(ht(n,b.h.Unsupported))),null==r||r.mark("conflict_resolution_start",{source:e,collectionName:n,count:s.length});var u=yield ce(n,s),l=u.remoteMutationsToApply,_=u.pendingMutationsToDrop,d=s.filter(n=>!l.includes(n));null==r||r.mark("conflict_resolution_end",{source:e,collectionName:n,apply:l.length,drop:d.length}),d.forEach(n=>o.push(ht(n,b.h.Skipped,n.actionName))),null==r||r.mark("apply_set_mutations_start",{source:e,collectionName:n,count:l.length});for(var f=Ve(l),y=0;y<f.length;y++){var v=f[y][0].actionHandler,h=f[y].map(n=>{var t;return t=n.binarySyncData?on((0,W.a)(c.a,n.binarySyncData).value):(0,W.a)(c.b,n.binarySyncAction),{operation:"set",indexParts:n.indexArr,value:t,timestamp:n.timestamp}}),p=[],S=!1;try{__LOG__(2)`syncd: before apply mutation batch for ${n}. mutations count: ${h.length}  ${i}`,p=yield v.applyMutations(h,{setMutationsPendingToPersist:o,allSupportedSetMutations:l})}catch(t){if(t instanceof Bn.a||n===b.b.CriticalBlock)throw t;S=!0,__LOG__(3)`synd: catching error during _applySetMutations: ${t}`}__LOG__(2)`syncd: after apply mutation batch for ${n}  ${i}`;for(var O=0;O<f[y].length;O++){var I,A,E=S?b.h.Failed:p[O].actionState;o.push(ht(f[y][O],E,f[y][O].actionName,S||null==(I=p[O].orphanModel)?void 0:I.modelId,S||null==(A=p[O].orphanModel)?void 0:A.modelType))}}var T=o.reduce((n,t)=>{var e=t.actionState;return null==n[e]&&(n[e]=0),n[e]++,n},{});return null==r||r.mark("apply_set_mutations_end",Object.assign({source:e,collectionName:n,count:l.length},T)),z(j.APPLIED_MUTATIONS),__LOG__(2)`syncd: completed apply set mutations for ${n}  ${i}`,{setMutationsToPersist:o,pendingMutationsToDrop:_}}))).apply(this,arguments)}function Ue(n,t){return xe.apply(this,arguments)}function xe(){return(xe=d()((function*(n,t){var e=Ve(He(t).supportedMutations);__LOG__(2)`syncd: before apply remove mutations for ${n}`;for(var r=0;r<e.length;r++){var i=e[r][0].actionHandler;yield i.applyMutations(e[r].map(t=>({operation:"remove",indexParts:Ke(n,t.index)})),{setMutationsPendingToPersist:[],allSupportedSetMutations:[]})}__LOG__(2)`syncd: after apply remove mutations for ${n}`}))).apply(this,arguments)}function He(n){var t=n.map(n=>{if(n.version>gt())return{unsupported:n};var t=Ke(n.collection,n.index),e=b.a.cast(t[0]);if(!e)return __LOG__(3)`syncd: invalid action ${t[0]}`,{unsupported:n};var r=$t(e);return r?{supported:{collection:n.collection,index:n.index,indexMac:n.indexMac,keyId:n.keyId,binarySyncData:n.binarySyncData,valueMac:n.valueMac,version:n.version,indexArr:t,actionName:e,actionHandler:r}}:(__LOG__(3)`syncd: no handler for action ${e}`,{unsupported:n})}),e=[],r=[];return t.map(n=>{var t=n.supported,i=n.unsupported;null!=t?e.push(t):null!=i&&r.push(i)}),{supportedMutations:e,unsupportedMutations:r}}function Be(n){var t=n.filter(n=>n.operation===cn.SET),e=new Set(t.map(n=>n.index));return n.filter(n=>n.operation===cn.REMOVE).forEach(n=>{e.has(n.index)||t.push(n)}),t}function Fe(n,t){var e=t.map(t=>{if(t.version>gt())return{unsupported:t};var e=Ke(n,t.index),r=b.a.cast(e[0]);if(!r)return __LOG__(3)`syncd: invalid action ${e[0]}`,{unsupported:t};var i=$t(r);return i?{supported:{collection:t.collection,index:t.index,indexMac:t.indexMac,keyId:t.keyId,timestamp:t.timestamp,binarySyncData:t.binarySyncData,valueMac:t.valueMac,version:t.version,indexArr:e,actionName:r,actionHandler:i}}:(__LOG__(3)`syncd: no handler for action ${r}`,{unsupported:t})}),r=[],i=[];return e.map(n=>{var t=n.supported,e=n.unsupported;null!=t?r.push(t):null!=e&&i.push(e)}),{supportedMutations:r,unsupportedMutations:i}}function Ve(n){return n.reduce((n,t)=>(0!==n.length&&t.actionName===n[n.length-1][0].actionName?n[n.length-1].push(t):n.push([t]),n),[])}function Ke(n,t){try{var e=JSON.parse(t);if(e.length<1)throw new Error;return e}catch(t){throw Q(q.INVALID_ACTION_INDEX,n),new Bn.a("invalid action index")}}var Ye=e(30),Xe=e(9),We=e(115);function je(n){return(0,We.b)(n)}var Ze=e(165);function ze(n){try{return(0,i.a)(Sn,n).readBuffer()}catch(n){throw Q(q.PATCH_PROTOBUF_SERIALIZATION_FAILED),new Bn.a("patch protobuf serialization failed")}}function Je(n,t){return qe.apply(this,arguments)}function qe(){return(qe=d()((function*(n,t){var e=n.index,r=n.operation,i=t.keyId,o=t.keyData;switch(r){case cn.SET:break;case cn.REMOVE:var a=yield w(e);if(!a)throw new Bn.a("no corresponding set mutation");var c=a.keyId,s=yield V(c);if(null==s)throw new Bn.a("no key data for corresponding mutation");i=c,o=s}var u=yield Qe(n,i,o),l=u.indexMac,_=u.indexAndValueCipherText,d=Hn(_);return Object.assign({},n,{keyId:i,keyData:o,indexMac:l,indexAndValueCipherText:_,valueMac:d})}))).apply(this,arguments)}function Qe(n,t,e){return nr.apply(this,arguments)}function nr(){return(nr=d()((function*(n,t,e){try{var r=n.index,i=n.binarySyncAction,o=n.operation,a=n.version,c=(0,Ze.c)(r),s=yield Pn(e),u=s.indexKey,l=s.valueEncryptionKey,_=s.valueMacKey,d=yield self.crypto.getRandomValues(new Uint8Array(Mn)),f=tr(c,i,gn(c.byteLength,i.byteLength),a),y=yield Dn(d,l,f),v=$n(o,t),h=yield bn(v,y,_),p=(0,U.b)([y,h]);return{indexMac:yield Rn(u,c),indexAndValueCipherText:p}}catch(n){throw Q(q.ENCRYPTION_FAILED),new Bn.a("encryption failure")}}))).apply(this,arguments)}function tr(n,t,e,r){return(function(n){try{return(0,i.a)(c.a,n).readBuffer()}catch(n){throw Q(q.ACTION_DATA_PROTOBUF_SERIALIZATION_FAILED),new Bn.a("action data protobuf serialization failed")}})({index:n,value:(0,W.a)(c.b,t),padding:e,version:r})}function er(n){return new DataView((0,B.b)(n)).getUint16(0)}function rr(n){return new DataView((0,B.b)(n)).getUint32(2)}function ir(n){return rr(n)+1}function or(){for(var n=arguments.length,t=new Array(n),e=0;e<n;e++)t[e]=arguments[e];var r=t.reduce((n,t)=>n+t.byteLength,0),i=new Uint8Array(r),o=0;return t.forEach(n=>{i.set(new Uint8Array(n),o),o+=n.byteLength}),i.buffer}function ar(n,t){for(var e=t,r=new Uint8Array(n),i=n-1;i>=0;i--)r[i]=255&e,e>>>=8;return r}function cr(n){var t=n.timestamp,e=Math.min(90,Math.max(1,(0,f.a)().syncdKeyMaxUseDays()))*s.a;return(0,s.E)()-t>e}function sr(n,t){for(var e,r,i=n.fingerprint,o=t.rawId,a=t.currentIndex,c=t.deviceIndexes,s=new Set(i.deviceIndexes),u=i.currentIndex+1;u<=a;u++)s.add(u);return i.rawId!==o||(e=s,r=new Set(c),!(e.size===r.size&&(function(n,t,e){for(var r=n.entries(),i=r.next();!i.done;){var o=i.value;if(!t.call(void 0,o[1],o[0],n))return!1;i=r.next()}return!0})(e,n=>r.has(n))))}function ur(n,t){var e=(function(n){var t;if(null==n){var e=new Uint8Array(16);self.crypto.getRandomValues(e),t=ir((0,B.d)(e.buffer))}else t=ir(n.keyId);var r=(0,Xe.D)((0,Xe.s)((0,f.c)()));return{keyId:(0,B.d)(new Uint8Array(or(ar(2,r).buffer,ar(4,t).buffer)).buffer),keyEpoch:t}})(t);return{keyId:e.keyId,keyEpoch:e.keyEpoch,keyData:(0,B.c)(self.crypto.getRandomValues(new Uint8Array(32)).buffer),fingerprint:n,timestamp:(0,s.E)()}}var lr=new(e(81).a);function _r(){var n=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return lr.enqueue(()=>dr(n))}function dr(){return fr.apply(this,arguments)}function fr(){return(fr=d()((function*(){var n=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=yield yr(),e=yield(0,f.b)().getDeviceFingerprint(),r=!1,i=!1;if(null!=t){if(r=cr(t),i=sr(t,e),!n||!r&&!i)return{keyId:t.keyId,keyData:t.keyData}}else if(!n||(0,f.a)().isCompanion())throw Error("syncd: No sync key available");var o=ur(e,t);return __LOG__(2)`syncd: stored key rotation key id ${(0,U.e)(o.keyId)}`,yield $(o),yield(0,f.b)().sendSyncdKeyRotation([o]),r&&(__LOG__(2)`syncd: key rotation due to key expiry`,jn(Kn.APP_STATE_SYNC_KEY_EXPIRY)),i&&(__LOG__(2)`syncd: key rotation due to device removal`,jn(Kn.DEVICE_DEREGISTERATION)),null==t&&(__LOG__(2)`syncd: key rotation due to no key present`,jn(Kn.NO_KEYS)),dr(n)}))).apply(this,arguments)}function yr(){return vr.apply(this,arguments)}function vr(){return(vr=d()((function*(){var n=yield R();if(0===n.length)return null;var t=n.map(n=>rr(n.keyId)),e=Math.max(...t),r=n.filter(n=>rr(n.keyId)===e),i=r.map(n=>er(n.keyId)),o=Math.min(...i);return r[i.indexOf(o)]}))).apply(this,arguments)}function hr(n){var t=Math.min(2e3,Math.max((0,f.a)().syncdInlineMutationsMaxCount(),100));return n.length>t}function pr(n){var t=1e3*Math.min(100,Math.max((0,f.a)().syncdPatchProtobufMaxSize(),10));return n.byteLength>t}function Sr(n,t){return n.map(n=>{var e=(0,W.a)(c.a,n.binarySyncData).value,r=(0,i.a)(c.b,e).readBuffer();return{collection:n.collection,index:n.index,binarySyncAction:r,operation:t,version:n.version,timestamp:n.timestamp,action:n.action}})}function Or(n){return Ir.apply(this,arguments)}function Ir(){return(Ir=d()((function*(n){var t=yield Er(n),e=t.collectionNodes,r=t.collectionWithEncryptedMutations,i=t.localCollectionVersions,a=t.collectionsToSkip;return{syncIqNode:Ar((0,o.w)("sync",null,e)),collectionWithEncryptedMutations:r,localCollectionVersions:i,collectionsToSkip:a}}))).apply(this,arguments)}function Ar(n){return(0,o.w)("iq",{to:o.l,xmlns:"w:sync:app:state",type:"set",id:(0,o.u)()},n)}function Er(n){return Tr.apply(this,arguments)}function Tr(){return(Tr=d()((function*(n){__LOG__(2)`syncd: start _buildCollectionNodes`;var t=[],e=(function(){var n=d()((function*(n,e){var r,i,o=yield S(n).then(n=>null==n?void 0:n.version);if(null!=e&&e.length>0)if(null==o)__LOG__(2)`syncd: skipping ${n} in sync iq patch because initial full sync
is incomplete`,t.push(n);else{var a=yield mr(n,e);r=a.patchNode,i=a.encryptedMutations}return{collection:n,version:o,patchNode:r,encryptedMutations:i}}));return function(t,e){return n.apply(this,arguments)}})(),r=new Map,i=new Map,a=[];n.forEach((n,t)=>a.push(e(t,n)));var c=(yield Promise.all(a)).map(n=>{var t=n.collection,e=n.version,a=n.patchNode,c=n.encryptedMutations;return c&&i.set(t,c),r.set(t,e),(0,o.w)("collection",{name:(0,o.b)(t),version:(0,o.f)(null!=e?e:b.f),return_snapshot:void 0===e?"true":"false"},a)});return __LOG__(2)`syncd: end _buildCollectionNodes`,{collectionNodes:c,collectionWithEncryptedMutations:i,localCollectionVersions:r,collectionsToSkip:t}}))).apply(this,arguments)}function mr(n,t){return Mr.apply(this,arguments)}function Mr(){return(Mr=d()((function*(n,t){var e,r=yield _r(!Nr(t)),i=(yield $r(n,t,r)).map(n=>Je(n,r)),a=yield Promise.all(i),c=a.map(n=>({indexMac:n.indexMac,valueMac:n.valueMac,operation:n.operation})),s=yield ut(n,c),u=yield ct(n,s,a,r.keyData),l=u.snapshotMac,_=u.patchMac,y=a.map(n=>Rr(n.keyId,n.operation,n.indexMac,n.indexAndValueCipherText)),v=Pr(y),h=(function(){var n=d()((function*(){var n=yield(0,f.b)().uploadSyncExternalPatch(v);return Cr(yield Lr(n,v),r.keyId,l,_)}));return function(){return n.apply(this,arguments)}})();return(hr(y)||pr(e=Gr(y,r.keyId,l,_)))&&(e=yield h()),{patchNode:(0,o.w)("patch",null,e),encryptedMutations:a}}))).apply(this,arguments)}function Nr(n){return(0,f.a)().logoutInProgress()&&n.some(n=>JSON.parse(n.index)[0]===b.a.Sentinel)}function Lr(n,t){return wr.apply(this,arguments)}function wr(){return(wr=d()((function*(n,t){var e=n.mediaKey,r=n.directPath,i=n.encFilehash,o=n.handle,a=yield je(t);return{mediaKey:e,directPath:r,handle:o,fileSizeBytes:t.byteLength,fileSha256:(0,H.b)(a),fileEncSha256:i}}))).apply(this,arguments)}function Cr(n,t,e,r){var i=(0,f.a)().syncdPatchDeviceIndexIncluded()?(0,Xe.s)((0,f.c)()):void 0;return ze({keyId:{id:(0,B.b)(t)},externalMutations:n,snapshotMac:e,patchMac:r,deviceIndex:i})}function Gr(n,t,e,r){var i=(0,f.a)().syncdPatchDeviceIndexIncluded()?(0,Xe.s)((0,f.c)()):void 0;return ze({keyId:{id:(0,B.b)(t)},mutations:n,snapshotMac:e,patchMac:r,deviceIndex:i})}function Pr(n){return(function(n){try{return(0,i.a)(hn,n).readBuffer()}catch(n){throw Q(q.MUTATIONS_PROTOBUF_SERIALIZATION_FAILED),new Bn.a("mutations protobuf serialization failed")}})({mutations:n})}function Rr(n,t,e,r){return{operation:t,record:{keyId:{id:(0,B.b)(n)},index:{blob:e},value:{blob:r}}}}function $r(n,t,e){return gr.apply(this,arguments)}function gr(){return(gr=d()((function*(n,t,e){var r=yield C([n]),i=t,o=Dr(r,t,e.keyId),a=br(r,i=i.concat(o),e.keyId);return pe(a.length),i.concat(a)}))).apply(this,arguments)}function Dr(n,t,e){var r,i,o=n.filter(n=>!t.map(n=>n.index).includes(n.index)&&!(0,U.f)(n.keyId,e));r=n=>rr(n.keyId),(i=o.map((n,t)=>({index:t,sortValue:r(n),value:n}))).sort((n,t)=>{var e=n.sortValue,r=t.sortValue;return e>r?1:e<r?-1:n.index-t.index}),o=i.map(n=>n.value);var a=Math.min(5,Math.max(1,(0,f.a)().syncdAdditionalMutations()));return Sr(o=o.slice(0,a),cn.SET)}function br(n,t,e){var r=t.map(n=>n.index);return Sr(n.filter(n=>r.includes(n.index)).filter(n=>!(0,U.f)(n.keyId,e)),cn.REMOVE)}function kr(n){return(t=n.reverse(),e=new Set,t.filter(n=>{var t=n.index;return!e.has(t)&&(e.add(t),!0)})).reverse();var t,e}function Ur(n){return xr.apply(this,arguments)}function xr(){return(xr=d()((function*(n){var t=new Map,e=new Map;yield Promise.all(n.map((function(){var n=d()((function*(n){var r=yield L(n),i=r.map(n=>n.id).filter(Boolean);e.set(n,i);var o=kr(r);t.set(n,o)}));return function(t){return n.apply(this,arguments)}})()));var r=yield Or(t);return{syncIqNode:r.syncIqNode,collectionWithPendingMutationsIds:e,collectionWithEncryptedMutations:r.collectionWithEncryptedMutations,localCollectionVersions:r.localCollectionVersions,collectionsToSkip:r.collectionsToSkip}}))).apply(this,arguments)}var Hr=new(e(51).a)("syncResponseParser",n=>{__LOG__(2)`syncd: start parsing syncd collections`;var t=[];return n.child("sync").mapChildrenWithTag("collection",n=>{var e=Object.assign({},null),r=b.b.cast(n.attrString("name"));if(!r)throw new Bn.a("invalid collection name");e.name=r,e.state=(function(n,t){if(!n.hasAttr("type")||"error"!==n.attrString("type"))return n.hasAttr("has_more_patches")?(__LOG__(2)`syncd: collection ${t} got server code has_more_patches`,b.c.SuccessHasMore):(__LOG__(2)`syncd: collection ${t} did not get server error`,b.c.Success);var e=n.child("error"),r=e.attrString("code"),i=e.attrString("text");switch(__LOG__(2)`syncd: collection ${t} got server error: ${r}`,r){case"409":return n.hasAttr("has_more_patches")?b.c.ConflictHasMore:b.c.Conflict;case"400":return Q(q.XMPP_BAD_REQUEST_FOR_COLLECTION),__LOG__(4)`syncd: fatal error: collection ${String(t)} throws ${i}`,SEND_LOGS("syncd: fatal error 400: collection "+String(t)),b.c.ErrorFatal;case"404":return Q(q.XMPP_NOT_FOUND_FOR_COLLECTION),__LOG__(4)`syncd: fatal error 404: collection ${String(t)} throws ${i}`,SEND_LOGS("syncd: fatal error: collection "+String(t)),b.c.ErrorFatal;default:return __LOG__(3)`syncd: retryable error: collection ${String(t)} throws ${i}`,SEND_LOGS("syncd: retryable error: collection "+String(t)),b.c.ErrorRetry}})(n,e.name),n.hasAttr("version")&&(e.version=parseInt(n.attrString("version"),10)),n.hasChild("patches")&&(e.patches=n.child("patches").mapChildrenWithTag("patch",n=>(function(n,t){try{return(0,W.a)(Sn,t)}catch(t){throw Q(q.PATCH_PROTOBUF_DESERIALIZATION_FAILED,n),new Bn.a("patch protobuf deserialization failed")}})(r,n.contentBytes()))),n.hasChild("snapshot")&&(e.snapshot=(function(n,t){try{return(0,W.a)(yn,t)}catch(t){throw Q(q.EXTERNAL_BLOB_REFERENCE_PROTOBUF_DESERIALIZATION_FAILED,n),new Bn.a("external blob reference protobuf deserialization failed")}})(r,n.child("snapshot").contentBytes())),t.push(e),null==e.version&&null==e.patches&&null==e.snapshot&&__LOG__(2)`syncd: collection ${r} has no version, patches or snapshot`,__LOG__(2)`syncd: successfully parsed collection ${r}`}),t});function Br(n){return Fr.apply(this,arguments)}function Fr(){return(Fr=d()((function*(n){for(var t=[],e=[...n],r=0;(r<5||e.length>0&&r<500)&&0!==e.length;){var i=yield Vr(e),o=i.doneCollections;e=i.refetchCollections,t=t.concat(o),r++}return e.length>0&&(__LOG__(4)`syncd: reached max iterations for collections: ${e}`,SEND_LOGS("syncd: max iteration"),t=t.concat(e.map(n=>({state:b.c.ErrorRetry,name:n})))),t}))).apply(this,arguments)}function Vr(n){return Kr.apply(this,arguments)}function Kr(){return(Kr=d()((function*(n){if(0===n.length)return{doneCollections:[],refetchCollections:[]};try{var t=yield Yr(n),e=t.collectionDetails,r=t.localCollectionVersions,i=t.collectionsToUpload;i.length>0&&__LOG__(2)`syncd: deferred local mutation upload for ${i}`,__LOG__(2)`syncd: local collection versions:`,r.forEach((n,t)=>{__LOG__(2)`\n\t${t} v${null!=n?n:"(undefined)}"}`});var o=[],a=[];e.forEach(n=>{switch(n.state){case b.c.ErrorRetry:case b.c.ErrorFatal:case b.c.Blocked:return void a.push(n);default:o.push(n)}n.state!==b.c.Conflict&&n.state!==b.c.ConflictHasMore||Se()}),__LOG__(2)`syncd: start apply collections: ${o.map(n=>n.name)}`;var c=new zn,s=yield Promise.all(o.map(n=>Ie(n,r.get(n.name),c)));c.end(),__LOG__(2)`syncd: end apply collections: ${o.map(n=>n.name)}`;var u=[];return yield Promise.all(s.map((function(){var n=d()((function*(n){n.state===b.c.Conflict?(yield L(n.name)).length>0?u.push(n.name):(n.state=b.c.Success,a.push(n)):n.state===b.c.ConflictHasMore||n.state===b.c.SuccessHasMore||n.state===b.c.Success&&i.some(t=>t===n.name)?u.push(n.name):a.push(n)}));return function(t){return n.apply(this,arguments)}})())),{doneCollections:a,refetchCollections:u}}catch(t){return t instanceof Bn.a?(__LOG__(4)`syncd: fatal error: syncd global throws ${t.message}`,SEND_LOGS("syncd: fatal error: syncd global throws "+t.message),{doneCollections:n.map(n=>({state:b.c.ErrorFatal,name:n})),refetchCollections:[]}):(__LOG__(3)`syncd: retryable error: syncd global throws ${t.message}`,SEND_LOGS("syncd: retryable error: syncd global throws "+t.message),{doneCollections:n.map(n=>({state:b.c.ErrorRetry,name:n,serverBackoff:t.errorBackoff})),refetchCollections:[]})}}))).apply(this,arguments)}function Yr(n){return Xr.apply(this,arguments)}function Xr(){return(Xr=d()((function*(n){var t=yield Ur(n),e=t.syncIqNode,r=t.collectionWithPendingMutationsIds,i=t.collectionWithEncryptedMutations,o=t.localCollectionVersions,a=t.collectionsToSkip;z(j.REQUEST_BUILT),__LOG__(2)`syncd: sending sync request for collections: ${n.map(n=>{var t,e,i;return`\n\t${n} v${null!=(t=o.get(n))?t:"(undefined)"} ${(null!=(e=null==(i=r.get(n))?void 0:i.length)?e:0)>0&&null!=o.get(n)?" with local changes":""}`})}`;var c=yield(0,Ye.b)(e,Hr);if(__LOG__(2)`syncd: completed network operation for collections: ${n}`,z(j.RESPONSE_RECEIVED),c.success){z(j.RESPONSE_PARSED_VALID);var s=c.result;return __LOG__(2)`syncd: received sync response for collections: ${s.map(n=>{var t="\n"+n.name;return null!=n.version&&(t+="\n\tupdated to version "+n.version),null!=n.snapshot&&(t+="\n\tcontains snapshot"),null!=n.patches&&(t+=`\n\tcontains ${n.patches.length} patches`),t})}`,s.forEach(n=>{var t=r.get(n.name);t&&(n.syncedPendingMutationsId=t);var e=i.get(n.name);e&&(n.syncedEncryptedMutations=e)}),{collectionDetails:s,localCollectionVersions:o,collectionsToUpload:a}}throw Wr(c.errorCode,c.errorText,c.errorBackoff)}))).apply(this,arguments)}function Wr(n,t,e){switch(n){case 400:return Q(q.XMPP_BAD_REQUEST_GLOBAL_ERROR),new Bn.a(t);case 404:return Q(q.XMPP_NOT_FOUND_GLOBAL_ERROR),new Bn.a(t);case 405:return Q(q.XMPP_BAD_METHOD_GLOBAL_ERROR),new Bn.a(t);case 406:return Q(q.XMPP_NOT_ACCEPTABLE_GLOBAL_ERROR),new Bn.a(t);default:return new Bn.c(t,e)}}var jr,Zr=new Set,zr=new Set,Jr=!1,qr=0,Qr=0;function ni(){return(ni=d()((function*(n,t){var e=null!=t?yield ti(n,t):n;return __LOG__(2)`syncd: marking for sync: ${e}`,e.forEach(n=>{var t=k.getCollectionState(n);__LOG__(2)`syncd: ${n} state before sync: ${t}`,t===b.d.UpToDate?k.moveCollectionsToDirty([n]):t===b.d.Dirty&&(zr=new Set([...Array.from(zr),n]))}),yield k.persistToDb(),ri()}))).apply(this,arguments)}function ti(n,t){return ei.apply(this,arguments)}function ei(){return(ei=d()((function*(n,t){__LOG__(2)`syncd: start filter collections: ${n}`;var e=yield I(n),r=new Map(n.map((n,t)=>{var r;return[n,null==(r=e[t])?void 0:r.version]}));return n.filter(n=>{var e=r.get(n);if(null==e)return __LOG__(2)`syncd: local version for ${n} missing; will mark for sync.`,!0;var i=t.get(n);return null==i?(__LOG__(2)`syncd: server version for ${n} missing; will mark for sync.`,!0):e<i?(__LOG__(2)`syncd: local version (${e}) for ${n} less than server version (${i}); will mark for sync.`,!0):(__LOG__(2)`syncd: local version (${e})for ${n} >= server version (${i}); will not mark for sync.`,!1)})}))).apply(this,arguments)}function ri(){return ii.apply(this,arguments)}function ii(){return(ii=d()((function*(){if(x())return Promise.resolve();var n=k.getCollectionsInStateDirty();__LOG__(2)`syncd: dirty collections: ${n}`;var t=new Set(n.filter(n=>!Zr.has(n)));if(0===t.size)return __LOG__(2)`syncd: no collections to sync`,Promise.resolve();var e=[];try{Zr=new Set([...Array.from(Zr),...Array.from(t)]),__LOG__(2)`syncd: initiate server sync`,e=yield Br(Array.from(t)),__LOG__(2)`syncd: server sync successful`;var r=e.filter(n=>n.state===b.c.ErrorRetry);r.length>0&&(Qr=r[0].serverBackoff||0,qr=0),ai(e)}catch(n){__LOG__(2)`syncd: exception during sync(): ${n}`,k.moveCollectionsToFiniteRetry(Array.from(t))}finally{__LOG__(2)`syncd: cleanup after sync()`,k.persistToDb(),Zr=new Set(Array.from(Zr).filter(n=>!t.has(n))),oi(),yield(0,f.b)().handleSyncCompleted(e)}}))).apply(this,arguments)}function oi(){__LOG__(2)`syncd: state machine tick`,k.getCollectionsInStateDirty().length>0&&(zr=new Set(Array.from(zr).filter(n=>Zr.has(n))),ri());var n=k.getCollectionsInStateRetry();if(n.length>0){if(Jr)return void __LOG__(2)`syncd: retry is in flight`;null!=jr&&clearTimeout(jr),zr=new Set(Array.from(zr).filter(t=>!n.includes(t))),(function(){if(!x()){var n,t,e,r=new Set(k.getCollectionsInStateRetry());0!==r.size&&(jr=setTimeout(d()((function*(){try{Jr=!0,qr+=1,__LOG__(2)`syncd: initiate server sync retry`;var n=yield Br(Array.from(r));__LOG__(2)`syncd: server sync retry successful`,ai(n)}catch(n){__LOG__(2)`syncd: exception during handleRetry(): ${n}`,k.moveCollectionsToFiniteRetry(Array.from(r))}finally{__LOG__(2)`syncd: cleanup after handleRetry()`,(t=k.getExpiredCollections()).length>0&&(k.moveCollectionsToFatal(t),__LOG__(4)`syncd: fatal error: expired collections`,SEND_LOGS("syncd: fatal error: expired collections"),Q(q.TOO_MANY_INTERNAL_SERVER_ERRORS_IN_7D)),k.persistToDb(),Jr=!1,oi()}var t})),(n=qr,t=Qr,e=1e3*Math.pow(2,n),Math.min(Math.max(e,t),36e5))))}})()}k.getCollectionsInStateFatal().length>0&&(0,f.b)().handleSyncdFatal({collections:k.getCollectionsInStateFatal()})}function ai(n){return n.forEach(n=>n.state!==b.c.Success||zr.has(n.name)?n.state===b.c.ErrorRetry?(z(j.ENTERED_RETRY_MODE),k.moveCollectionsToFiniteRetry([n.name])):n.state===b.c.ErrorFatal?k.moveCollectionsToFatal([n.name]):n.state!==b.c.Blocked||zr.has(n.name)?void 0:k.moveCollectionsToBlocked([n.name]):k.moveCollectionsToUpToDate([n.name]))}var ci=e(337);function si(n,t,e){switch(t){case"historySync":return(0,r.a)(n,e);case"pushname_sync":return _=(0,s.D)(),d=(function(n,t){var e={timestamp:t,pushNameSetting:{name:n}};return{collection:"critical_block",index:JSON.stringify([a]),binarySyncAction:(0,i.a)(c.b,e).readBuffer(),version:1,operation:cn.SET,timestamp:t,action:a}})(u.C.get(),_),o=[d],(0,l.a)(o).then(()=>{var n=o.map(n=>(0,ci.a)(n.collection));k.loadStatesFromDb().then(()=>{(function(n,t){ni.apply(this,arguments)})(n)})});default:throw new Error("Invalid companion device sync stage")}var o,_,d}},580:function(n,t,e){e.d(t,"a",(function(){return B}));var r=e(8),i=e.n(r),o=e(26),a=e.n(o),c=e(355),s=e(6),u=e(10),l=e(3),_=e(5),d=e(2),f=e(15),y=e(366),v=e(38),h=e(84);function p(n,t){var e={id:n.externalId,fromMe:n.author===d.b,remoteJid:t.jid};e.fromMe||"GROUP"!==t.type||(e.participant=n.author);var r={key:e,starred:!!n.starred,messageTimestamp:n.ts,labels:[],messageStubParameters:[],reactions:[],status:O(n.ack),userReceipt:[],pollUpdates:[]};switch(n.type){case d.f.TEXT:r.message={conversation:n.text};break;case d.f.GROUP_NOTIFICATION:r.messageStubType=(function(n){switch(n){case"create":return y.b.GROUP_CREATE;case"announcement":return y.b.GROUP_CHANGE_ANNOUNCE;default:return y.b.UNKNOWN}})(n.subtype)}return r}function S(n){var t=O(n.ack),e=n.author===d.b,r={id:n.externalId,fromMe:e},i={};switch(n.type){case v.c.TEXT:i.conversation=n.text}var o={key:r,message:i,status:t,messageTimestamp:n.ts,labels:[],messageStubParameters:[],reactions:[],userReceipt:[],pollUpdates:[]};return e||(t===y.a.READ&&(o.ignore=!0),o.participant=n.author),n.author===v.b&&null!=n.campaignId&&(o.statusPsa={campaignId:(0,h.a)(n.campaignId),campaignExpirationTimestamp:null!=n.campaignDuration?(0,l.k)(n.campaignDuration,n.ts):void 0}),o}function O(n){switch(n){case f.a.SENT:return y.a.SERVER_ACK;case f.a.READ:return y.a.READ;case f.a.PLAYED:return y.a.PLAYED;case f.a.FAILED:case f.a.CONTENT_UNUPLOADABLE:case f.a.CONTENT_GONE:return y.a.ERROR;default:return y.a.DELIVERY_ACK}}var I,A,E,T,m=e(389),M=5e3;function N(){return(0,u.f)("getInitialBootstrap",n=>n.transact("r",["chats","groups","groupParticipantsInfo","msgs"],()=>(function(n){return n.getChats().then(t=>{var e=[];return t.forEach(n=>{n.msgInfo.newest&&e.push(n.msgInfo.newest)}),n.stores.msgs.where("id").anyOf(e).toArray().then(n=>{var e={};return n.forEach(n=>{e[n.chat]=n}),t.map(n=>({chat:n,lastMsg:e[n.id]}))})})})(n).then(n=>{var t=(function(n){return n.map(n=>{var t=n.chat,e=P(n.lastMsg,t);return{id:t.jid,name:t.groupInfo?t.groupInfo.title:void 0,messages:e?[e]:[],unreadCount:t.msgInfo.unreadMsgCount,readOnly:G(t),endOfHistoryTransferType:c.a.COMPLETE_BUT_MORE_MESSAGES_REMAIN_ON_PRIMARY,conversationTimestamp:t.lastNotified||void 0,archived:t.archived,newJid:s.t.get(),oldJid:s.t.get(),notSpam:!0,participant:t.groupInfo?t.groupInfo.participants.map(n=>({userJid:n})):[]}})})(n);return{syncType:c.b.INITIAL_BOOTSTRAP,conversations:t,chunkOrder:0,progress:100,statusV3Messages:[],pushnames:[],recentStickers:[],pastParticipants:[]}})))}function L(){return(0,u.f)("getInitialStatusV3",n=>(0,_.i)((function(n){var t=(0,l.w)(l.b);return n.stores.status.where("ts").above(t).reverse().toArray().then(n=>n.map(S))})(n).then(n=>({syncType:c.b.INITIAL_STATUS_V3,statusV3Messages:n,pushnames:[],conversations:[],recentStickers:[],pastParticipants:[]}))))}function w(){return(0,u.f)("getInitialStatusV3",n=>(0,_.i)((function(n){return n.stores.contacts.toArray().then(n=>{var t=[];return n.forEach(n=>{n.pushname&&t.push({id:n.jid,pushname:n.pushname})}),t})})(n).then(n=>({syncType:c.b.PUSH_NAME,chunkOrder:0,pushnames:n,statusV3Messages:[],conversations:[],recentStickers:[],pastParticipants:[]}))))}function C(){return(0,u.f)("getChunkedRecentMessages",n=>(function(n){return R.apply(this,arguments)})(n).then(n=>{var t=n.conversations,e=n.chunkOrder,r=n.progress;return{syncType:c.b.RECENT,conversations:t,chunkOrder:e,progress:r,statusV3Messages:[],pushnames:[],recentStickers:[],pastParticipants:[]}}))}function G(n){return!("GROUP"!==n.type||n.groupInfo.isInGroup&&(!n.groupInfo.announcement||n.groupInfo.isAdmin))}function P(n,t){return{message:p(n,t),msgOrderId:n.rowId}}function R(){return(R=a()((function*(n){var t=(0,l.w)(90*l.b),e=(0,m.a)(),r=e.chunkOrder,o=e.progress;if(null==r||null==o||null==T){var a=yield $(n);A=a.chatsMap,I=a.chatMsgMap,E=a.orderedChatIds,T=a.chatCount,r=0,o=0}for(var s=0,u=[],d=function*(){var e=E[T-1],r=A[e],o=i()(I[e],2),a=o[0],l=o[1],d=yield(0,_.i)(n.stores.msgs.where("id").between(l,a,!0,!1).filter(n=>n.ts>t).limit(M-s).reverse().toArray()),f=d.length;if(0===f)D();else{f<M-s?D():I[e][0]=d[f-1].id,s+=f;var y={id:r.jid,messages:d.map(n=>P(n,r)),endOfHistoryTransferType:c.a.COMPLETE_BUT_MORE_MESSAGES_REMAIN_ON_PRIMARY,participant:[]};u.push(y)}};s<M&&T>0;)yield*d();return r++,o=Math.floor((E.length-T)/E.length*100),{conversations:u,chunkOrder:r,progress:o}}))).apply(this,arguments)}function $(n){return g.apply(this,arguments)}function g(){return(g=a()((function*(n){var t=yield(0,_.i)(n.stores.chats.toArray()),e=yield(0,_.i)(n.getChats()),r={},i={},o=[];t.forEach(n=>{n.newest&&n.oldest&&(r[n.id]=[n.newest,n.oldest])}),e.forEach(n=>{o.push(n.id),i[n.id]=n}),o.sort((n,t)=>i[n].sortBy-i[t].sortBy);var a=o.length;return{chatsMap:i,chatMsgMap:r,orderedChatIds:o,chatCount:a}}))).apply(this,arguments)}function D(){var n=E[E.length-1];delete A[n],delete I[n],T--}var b=e(101),k=e(277),U=e(34),x=e(56),H=e(446);function B(n,t){return(function(n,t){if(null==t)return Promise.reject("Missing sync type");var e,r;switch(__LOG__(2)`historySync::HistorySyncPhase ${r=t,Object.keys(c.b).find(n=>c.b[n]===r)||"UNKOWN PHASE"}`,t){case 0:c.b.INITIAL_BOOTSTRAP,e=N;break;case 1:c.b.INITIAL_STATUS_V3,e=L;break;case 4:c.b.PUSH_NAME,e=w;break;case 3:c.b.RECENT,e=C;break;default:return Promise.reject("Sync type not yet implmented")}return Promise.all([e(),(0,k.a)({})]).then((function(){var e=a()((function*(e){var r,o,a=i()(e,2),s=a[0],u=a[1];t===c.b.RECENT&&(null!=s.chunkOrder&&(o=s.chunkOrder),r={chunkOrder:o,progress:s.progress});var l=(0,b.a)(c.c,s).readBuffer();u.push(l,!0);var _=u.result(),d=new Blob([_]),f=_.length,y=yield self.crypto.subtle.digest("SHA-256",_);return(0,H.b)(d,U.d.MD_HISTORY).then(e=>{var i=e.fileEncSha256,a=e.mediaKey,c=e.directPath,s={historySyncNotification:{fileSha256:y,fileLength:f,mediaKey:a,fileEncSha256:i,directPath:c,syncType:t,chunkOrder:o},type:x.d.HISTORY_SYNC_NOTIFICATION};return(0,m.b)(n,s,r)})}));return function(n){return e.apply(this,arguments)}})())})(n,t).catch(n=>(__LOG__(4)`historySync:: Error in historySync`,Promise.reject(n)))}},594:function(n,t){function e(n,t){for(var e=n.length,r=new Array(e),i={},o=e;o--;)i[o]||a(n[o],o,[]);return r;function a(o,c,s){if(s.indexOf(o)>=0)throw new Error("Cyclic dependency: "+JSON.stringify(o));if(!~n.indexOf(o))throw new Error("Found unknown node. Make sure to provided all involved nodes. Unknown node: "+JSON.stringify(o));if(!i[c]){i[c]=!0;var u=t.filter((function(n){return n[0]===o}));if(c=u.length){var l=s.concat(o);do{var _=u[--c][1];a(_,n.indexOf(_),l)}while(c)}r[--e]=o}}}n.exports=t=function(n){return e((function(n){for(var t=[],e=0,r=n.length;e<r;e++){var i=n[e];t.indexOf(i[0])<0&&t.push(i[0]),t.indexOf(i[1])<0&&t.push(i[1])}return t})(n),n)},t.array=e}}]);