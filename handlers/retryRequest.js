"use strict";(self.webpackJsonp=self.webpackJsonp||[]).push([[71],{620:function(e,t,r){r.r(t);var n=r(26),i=r.n(n),s=r(8),d=r.n(s),u=r(114),a=r(399),y=r(7),l=r(9),_=r(517),o=r(542),c=r(308),v=r(297),f=r(41),p=r(296),R=r(4),g=r(30),m=r(215),h=r(134),G=r(62),L=r(42),O=r(251),I=new u.b("incomingRetryReceipt",e=>{e.assertTag("receipt"),e.assertAttr("type","retry"),e.hasAttr("to")&&(0,a.a)(e,"to");var t=e.child("registration").contentUint(4),r=null;if(e.hasChild("keys")){var n=e.child("keys"),i=n.child("key"),s=n.child("skey"),d=n.hasChild("device-identity")?(0,h.d)(n.child("device-identity").contentBytes()):null,u=n.child("type").contentUint(1),y=n.child("identity").contentBytes(32);r={identity:y,info:{regId:t,identity:M(u,y),oneTimeKey:{id:i.child("id").contentUint(3),publicKey:M(u,i.child("value").contentBytes(32))},signedKey:{id:s.child("id").contentUint(3),publicKey:M(u,s.child("value").contentBytes(32)),signature:s.child("signature").contentBytes(64)}},signedDeviceIdentity:d}}var l=e.child("retry");return{stanzaId:e.attrString("id"),externalId:l.attrString("id"),from:e.attrFromPhoneJid(),ts:e.attrTime("t"),retryCount:l.hasAttr("count")?l.attrInt("count"):0,offline:e.hasAttr("offline"),regId:t,keys:r}});function q(e,t){var r=(0,G.f)(t);return null==(null==r?void 0:r[e])?"encrypt":null!=r[e][L.a.RECEIVED]?"encryptIfIdentityIdMatches":"encrypt"}function k(){return(k=i()((function*(e,t,r,n){var i,s=e.author;__LOG__(2)`sendRequestedRetryMsg`;var d,u=t.dbMsg,a=(0,y.h)(s),l=null==(i=r.identityIds)?void 0:i.get(s);d="encrypt"===(null==l?"encrypt":(0,y.r)(s)?q(a,r):"encryptIfIdentityIdMatches")||null==l?yield(0,p.e)(s,t,n):yield(0,p.f)(s,t,n,l);var _=(0,O.a)(u.externalId);if(null!=d){var o=d.encNode,c=(0,R.w)("message",{id:(0,R.b)(u.externalId),to:(0,R.m)(e),participant:(0,R.j)(e),type:(0,v.f)(u),edit:(0,v.a)(u)},(0,v.b)(u),(0,v.c)(u),(0,v.d)(u),o);__LOG__(2)`sendRequestedRetryMsg sending ${_}`,yield(0,g.g)(c,{id:u.externalId,class:"message",from:(0,R.t)(e),participant:(0,R.s)(e)}),__LOG__(2)`sendRequestedRetryMsg success ${_}`}else __LOG__(2)`sendRequestedRetryMsg encryption failed due to identityId mismatch: ${_}`}))).apply(this,arguments)}function M(e,t){var r=new Uint8Array(1+t.length);return r[0]=e,r.set(t,1),r}t.default=(0,u.c)("handleRetryRequest",I,e=>{var t=e.from,r=e.externalId,n=(0,R.w)("ack",{id:(0,R.b)(e.stanzaId),to:(0,R.m)(t),participant:(0,R.j)(t),class:"receipt",type:"retry"});if(e.retryCount>=5)return __LOG__(2)`handleRetryRequest refusing retry attempt #${e.retryCount}`,n;var i=(0,o.a)(t,r),s=i.requesterJid;return(0,o.b)(i,"retry").then(r=>{if(r.error)return __LOG__(2)`handleRetryRequest msg retry not authorized`,void("error-unknown-device"===r.error&&WAM.log("regular",2178,void 0,[1,0,(0,y.r)(s)?1:2,2,1,e.offline]));var n,i=(0,f.D)(s).then(t=>{if(e.keys){var r={jid:s,identity:e.keys.identity,info:e.keys.info};if((0,y.r)(s))return(0,f.f)(r).then(()=>!0);var n=(0,y.e)((0,y.h)(s));return(0,m.ensureE2eSession)(n).then(()=>(0,f.u)(n)).then(t=>{var n;if(!t)return __LOG__(3)`Primary identity is missing even after ensureE2eSession`,SEND_LOGS("no-primary-identity-after-ensureE2eSession"),!1;var i=null==(n=e.keys)?void 0:n.signedDeviceIdentity;return i?(0,h.g)(s,i,r.identity,t).then(e=>e?(0,f.g)(r,{rawId:e.rawId,keyIndex:e.keyIndex}).then(()=>!0):(__LOG__(3)`establishE2eSessionForCompanionDevice failed to verify received ADV object`,!1)):(__LOG__(3)`no device-identity provided for companion device msg retry`,SEND_LOGS("no-device-identity-companion-msg-retry"),!1)})}return!t||t===e.regId||(__LOG__(2)`handleRetryRequest delete session`,(0,f.k)(s).then(()=>!0))});if("user"!==r.type){r.type;var u="status"===r.type?l.h:r.jid;n=(0,c.d)(u,s)}return Promise.all([i,n]).then(n=>{if(d()(n,1)[0])return(0,_.a)(r.msgId).then(r=>{if(null!=r){var n=r.msgInfo,i=r.receipt;if(null!=n){if(null!=i)return(function(e,t,r,n){return k.apply(this,arguments)})(t,n,i,e.retryCount);__LOG__(2)`handleRetryRequest receipt gone`}else __LOG__(2)`handleRetryRequest message gone`}else __LOG__(2)`handleRetryRequest result missing`});__LOG__(2)`handleRetryRequest reject retry request due to a problem with keys node`})}).then(()=>n)})}}]);