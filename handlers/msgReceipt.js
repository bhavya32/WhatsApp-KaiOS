"use strict";(self.webpackJsonp=self.webpackJsonp||[]).push([[68],{728:function(e,r,t){t.r(r),t.d(r,"fromJid",(function(){return k}));var n=t(26),i=t.n(n),a=t(114),c=t(399),o=t(9),s=t(22),p=t(513),u=t(542),d=t(6),l=t(39),_=t(16),g=t(191),f=t(37),v=t.n(f),y=t(4),m=t(7),h=t(529),O=t(42),S=t(251);function I(e){if(!e.hasChild("biz"))return"NO_BIZ";var r=e.child("biz");return(0,g.getBspInfo)(r)||"NO_BSP"}t(576),t(580),t(389),t(355);var x={read:O.a.READ,played:O.a.PLAYED,"server-error":O.a.CONTENT_GONE,inactive:O.a.INACTIVE_RECEIVED,none:O.a.RECEIVED},G=new a.b("incomingMsgReceiptParser",e=>{e.assertTag("receipt"),e.hasAttr("to")&&(0,c.a)(e,"to");var r=e.maybeAttrString("type");if("server-error"===r){var t=e.attrFromPhoneJid(),n=e.maybeChild("encrypt"),i=e.attrString("id"),a=e.attrTime("t");return n?{type:"encrypted-reupload",stanzaId:i,externalId:i,from:t,ts:a,ackString:r,ciphertext:n.child("enc_p").contentBytes(),iv:n.child("enc_iv").contentBytes()}:{type:"reupload",stanzaId:i,externalId:i,from:t,ts:a,ackString:r}}var o=e.maybeChild("participants");if(o){var s=o.mapChildrenWithTag("user",e=>({participant:e.attrPhoneDeviceJid("jid"),ts:e.attrTime("t")}));return{type:"aggregate",stanzaId:e.attrString("id"),externalId:o.attrString("key"),fromJid:e.attrJidWithType(),ackString:r,receipts:s}}var p,u=e.attrFromPhoneJid(),d=e.attrString("id"),l="error"===r?e.child("error").attrString("type"):null;return(p=e.hasChild("list")?e.child("list").mapChildrenWithTag("item",e=>e.attrString("id")):[]).push(d),{type:"simple",stanzaId:d,externalIds:p,from:u,ts:e.attrTime("t"),ackString:r,bizInfo:I(e),errorType:l}});function L(e){var r=e.stanzaId,t=e.ackString,n=e.from;return(0,y.w)("ack",{to:(0,y.m)(n),id:(0,y.b)(r),class:"receipt",type:(0,y.i)(t),participant:(0,y.j)(n)})}function R(e,r){var t=x[r||"none"]||O.a.RECEIVED;return(0,O.i)(t)&&(function(e){return!e&&"none"===d.k.get().readReceipts})(e)?O.a.RECEIVED:t}function E(){return(E=i()((function*(e){var r=L(e),t=e.from,n=e.stanzaId,i=(0,u.a)(t,n),a=yield(0,u.b)(i,"reupload");if(a.error)return __LOG__(2)`handleEncryptedReuploadReceipt: Msg no longer exist`,r;var c=yield(0,s.Q)(a.msgId);if(!c)return __LOG__(2)`handleEncryptedReuploadReceipt: Msg no longer exist`,r;var o=c.dbMsg,p=c.dbMedia.mediaEntries[o.id];if(!p)return __LOG__(3)`handleEncryptedReuploadReceipt: Media entry no longer exist`,SEND_LOGS("no-media-entry"),r;if("reupload"===e.type)return(0,l.b)().waitUntilPersisted(_.e.reuploadMedia(i)).then(()=>r);var d=e.iv,g=e.ciphertext,f=yield(0,h.b)(p.cryptoKey,n,d,g);return f.stanzaId!==n?(__LOG__(4)`handleEncryptedReuploadReceipt: Incorrect server-error receipt: ${f.stanzaId?(0,S.a)(f.stanzaId):"missing"}-${(0,S.a)(n)}`,SEND_LOGS("server-error-receipt-mismatch"),r):(0,l.b)().waitUntilPersisted(_.e.reuploadMedia(i)).then(()=>r)}))).apply(this,arguments)}function k(e){switch(e.type){case"device":return e.chat;case"group":return e.groupJid;case"status":return o.h;case"broadcast":return __LOG__(4)`Unexpected receipt received for broadcastlist`,void SEND_LOGS("unexpected-broadcast-receipt");default:return(0,v.a)(e.type)}}r.default=(0,a.c)("handleMsgReceipt",G,e=>{var r;return __LOG__(2)`handleMsgReceipt processing ${e.type} receipt, ack ${e.ackString}`,"simple"===e.type?r=(function(e){var r,t=e.from,n=e.externalIds,i=e.ts,a=e.ackString,c=e.bizInfo,o=e.errorType,s=L(e),u=k(t);return u?(r=null!=o?{type:"receipt-error",error:o}:R("group"===t.type,a),(0,p.d)(n,u,[{participant:t.author,ts:i}],r,c).then(()=>s)):Promise.resolve(s)})(e):"aggregate"===e.type?r=(function(e){var r=e.fromJid,t=e.ackString,n=(function(e){var r=e.stanzaId,t=e.ackString,n=e.fromJid;return(0,y.w)("ack",{to:(0,y.g)((0,m.g)(n)),id:(0,y.b)(r),class:"receipt",type:(0,y.i)(t)})})(e),i=R("group"===r.jidType,t);switch(r.jidType){case"group":return(0,p.d)([e.externalId],r.groupJid,e.receipts,i).then(()=>n);case"status":return(0,p.d)([e.externalId],o.h,e.receipts,i).then(()=>n);default:return __LOG__(4)`Expected aggregate receipt to come for group JID or status, got ${r.jidType} jid: ${(0,m.g)(r)}`,SEND_LOGS("non-group-aggregate-receipt"),n}})(e):"hist_sync"===e.type?r=Promise.resolve(L(e)):(e.type,r=(function(e){return E.apply(this,arguments)})(e)),r})}}]);