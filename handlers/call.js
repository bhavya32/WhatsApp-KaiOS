"use strict";(self.webpackJsonp=self.webpackJsonp||[]).push([[55],{621:function(e,r,a){a.r(r),a.d(r,"default",(function(){return x}));var l=a(114),n=a(75),t=a(4),c=a(116),i=a(275),o=a(365),s=a(41),_=a(55),f=a(56),u=a(320),d=a(22),p=a(67),v=a(7),m=a(6),h=a(30),O=a(81),y=a(39),C=a(16),G=a(3),L=a(12),k=a(445),g=(a(134),a(216)),b=a(251);function w(){return m.o.get()&&(0,g.a)(m.I.get())}var P=new l.b("callParser",e=>{e.assertTag("call");var r=e.mapChildren(o.b);if(1!==r.length)throw new Error("expected exactly one child for call");return{externalId:e.attrString("id"),peerJid:e.attrPhoneDeviceJid("from"),payload:r[0],peerPlatform:e.hasAttr("platform")?e.attrString("platform"):null,peerAppVersion:e.hasAttr("version")?e.attrString("version"):null,epochMsec:e.hasAttr("t")?1e3*e.attrInt("t"):0,elapsedMsec:e.hasAttr("e")?1e3*e.attrInt("e"):0,isOffline:e.hasAttr("offline")}}),$=new l.b("callReceiptParser",e=>{e.assertTag("receipt");var r=e.mapChildren(o.b);if(1!==r.length)throw new Error("expected exactly one child for call receipt");var a=r[0].tag;if("offer"===a||"accept"===a||"reject"===a)return{externalId:e.attrString("id"),type:e.hasAttr("type")?e.attrString("type"):null,peerJid:e.attrPhoneDeviceJid("from"),payload:r[0]};throw new Error("unexpected receipt child tag "+a)});function E(e){var r=(0,v.o)(e);return"phoneUser"===r.jidType?r.userJid:null}function I(e,r,a,l){(0,h.a)((0,t.w)("ack",{id:(0,t.b)(e),to:(0,t.g)(r),from:(0,t.g)(m.t.get()),class:"call",type:(0,t.b)(a)},l))}function z(e,r,a){var l=a.tag;if("offer"===l||"accept"===l||"reject"===l){var n=a.attrs,i=n.find(e=>"call-id"===e.key),o=n.find(e=>"call-creator"===e.key),s=null;o&&null!=o.value&&(s=E(o.value));var _={};return _["call-creator"]=null!=s?(0,t.g)(s):"offer"===l?(0,t.g)(r):(0,t.g)(m.t.get()),null!=i&&null!=i.value?_["call-id"]=(0,t.b)(i.value):__LOG__(2)`handleCall ${l}, callId is missing`,(0,h.a)((0,t.w)("receipt",{to:(0,t.g)(r),id:(0,t.b)(e)},new t.o(l,_))),Promise.resolve()}if("terminate"===l&&w()){var f=a.attrs,u=f.find(e=>"call-id"===e.key),d=f.find(e=>"call-creator"===e.key),p=null;d&&null!=d.value&&(p=E(d.value));var v=null!=u?u.value:null;return(0,c.d)().then(a=>{var n=null;null!=a&&"evicted"!==a&&a.callId===v&&(a.audioDuration>0||a.videoDuration>0)&&(n=(0,t.w)("terminate",{"call-id":(0,t.i)(v),"call-creator":(0,t.i)(p),audio_duration:a.audioDuration>0?(0,t.f)(a.audioDuration):t.c,video_duration:a.videoDuration>0?(0,t.f)(a.videoDuration):t.c})),I(e,r,l,n)})}return I(e,r,l,null),Promise.resolve()}var D=new O.a;function x(e){var r=e.tag;if("call"===r)return(function(e){var r=P.parse(e);if(__LOG__(2)`handleCallStanza start`,r.error)return __LOG__(4)`handleCallStanza: failed to parse ${r.error}`,Promise.reject("handleCallStanza: failed to parse stanza");if(w())return D.enqueue(()=>{__LOG__(2)`handleCallStanza::acknowledge`;var e=r.success,a=e.externalId,l=e.peerJid,t=e.payload;return z(a,l,t).then(()=>"offer"===t.tag?((0,L.d)()||(0,L.b)(),(function(e,r){var a=r.payload.attrs.find(e=>"call-id"===e.key),l=null!=a?a.value:null,t=r.epochMsec;return null==l||null==t?(__LOG__(4)`Cannot extract required attributes from call offer`,Promise.resolve()):(function(e,r,a){var l=a.externalId,t=a.payload;if("offer"!==t.tag)throw new Error("maybeDecryptOfferEnc should only be called for offer");var i=t.children.find(e=>"enc"===e.tag);if(null==i)return __LOG__(2)`maybeDecryptOfferEnc call offer does not contain a valid <enc />`,Promise.resolve({status:"success",parsedCall:a});var o=i.attrs.find(e=>"type"===e.key),d=!o||"pkmsg"!==o.value&&"msg"!==o.value?null:o.value;if(null==d)return __LOG__(4)`maybeDecryptOfferEnc call offer does not contain valid enc type`,Promise.resolve({status:"error",parsedCall:a});var p=0,v=i.attrs.find(e=>"count"===e.key);if(null!=v&&(p=parseInt(v.value,10),Number.isNaN(p)))return __LOG__(4)`maybeDecryptOfferEnc call offer has an invalid count ${v.value}`,Promise.resolve({status:"error",parsedCall:a});__LOG__(2)`maybeDecryptOfferEnc call offer containing a valid <enc />, decrypting`;var m={onSuccess(e){var r,a=(0,u.a)(e),l=(0,n.a)(f.h,a),t=new Uint8Array(null==(r=l.call)?void 0:r.callKey);return i.content=t,"success"},onDecryptFailure(a){var n=(0,b.a)(l);switch(a){case _.b.ERR_DUPLICATE_MESSAGE:return __LOG__(2)`Call ${n} is duplicate`,"ignore";case _.b.ERR_NO_SESSION:__LOG__(2)`Call ${n} has no session`;break;case _.b.ERR_INVALID_KEY:__LOG__(2)`Call ${n} has invalid key`;break;case _.b.ERR_INVALID_KEY_ID:__LOG__(2)`Call ${n} has invalid key id`;break;case _.b.ERR_INVALID_SIGNED_PRE_KEY:__LOG__(2)`Call ${n} has invalid signed pre key`;break;case _.b.ERR_SIGNED_PRE_KEY_ID_MISMATCH:__LOG__(2)`Call ${n} has mismatched signed pre key id`;break;case _.b.ERR_SIGNED_PRE_KEY_DESERIALIZATION:__LOG__(2)`Cannot deserialize local signed pre key while processing call ${n}`;break;case _.b.ERR_INVALID_ONE_TIME_KEY:__LOG__(2)`Call ${n} has invalid one time key`;break;case _.b.ERR_ONE_TIME_KEY_ID_MISMATCH:__LOG__(2)`Call ${n} has mismatched one time key id`;break;case _.b.ERR_ONE_TIME_KEY_DESERIALIZATION:__LOG__(2)`Cannot deserialize local one time key while processing call ${n}`;break;case _.b.ERR_INVALID_MESSAGE:__LOG__(2)`Call ${n} has invalid message`;break;default:__LOG__(2)`onDecryptFailure TODO: unhandled error code ${a} for call ${n}`}return(0,s.F)().then(a=>{(0,c.m)(r,e,"enc",p+1,a)}),"ignore"}};return(0,s.i)(e,d,i.content,m).then(e=>({status:e,parsedCall:a}))})(e,l,r).then(r=>{var a=r.status,n=r.parsedCall;"success"===a?(__LOG__(2)`handleIncomingCallOffer::maybeDecryptOfferEnc success`,(0,i.a)().then(r=>{var a=(function(){var e=(0,k.a)();if(null==e)return!1;switch(e){case"pick":case"camera-pick":case"dial":return!0;default:return!1}})();return"idle"!==r||a?(a?__LOG__(2)`handleIncomingCallOffer mozActivity in progress detected, rejecting the call offer`:__LOG__(2)`handleIncomingCallOffer POTS call detected, rejecting the call offer`,(function(e,r,a,l){return(0,c.m)(e,r,"busy",0,0).then(()=>{var n=l.peerAppVersion,t=l.peerPlatform,i=l.payload.children.some(e=>"video"===e.tag),o=(0,v.h)(r);(0,y.b)().fireAndForget(C.e.createMissedCallLog({callId:e,peer:o,isFromMe:!1},(0,G.i)(a/1e3))),(0,c.j)({callId:e,callPeerPlatform:t,callPeerAppVersion:n,videoEnabled:i})})})(l,e,t,n)):(__LOG__(2)`handleIncomingCallOffer no POTS call detected, passing the call offer to the voip stack`,(function(e,r,a,l){var n=(0,v.h)(e);return(0,d.lb)({callId:r,peer:n,isFromMe:!1},(0,G.i)(l/1e3)),(0,p.b)(n).then(e=>{var r=null==e||null==e.phonebookPhone,l=a.isOffline?(0,L.d)()?0:1:5;return(0,c.f)({peerJid:a.peerJid,payload:a.payload,peerPlatform:a.peerPlatform,peerAppVersion:a.peerAppVersion,epochMsec:a.epochMsec,elapsedMsec:a.elapsedMsec,isOffline:a.isOffline},{isNotContact:r,callWakeupSource:l}).then(()=>{})})})(e,l,n,t))})):__LOG__(2)`handleIncomingCallOffer::maybeDecryptOfferEnc status ${a}`})})(l,e)):(0,c.h)({peerJid:e.peerJid,payload:e.payload,peerPlatform:e.peerPlatform,peerAppVersion:e.peerAppVersion,epochMsec:e.epochMsec,elapsedMsec:e.elapsedMsec,isOffline:e.isOffline}).then(()=>{}))});__LOG__(2)`handleCallStanza::acknowledge when VoIP is unavailable`;var a=r.success;return z(a.externalId,a.peerJid,a.payload),Promise.resolve()})(e);if("receipt"===r)return(function(e){var r=$.parse(e);if(__LOG__(2)`handleCallReceipt: start`,r.error)return __LOG__(4)`handleCallReceipt: failed to parse ${r.error}`,Promise.reject("handleCallReceipt: failed to parse stanza");if(w())return D.enqueue(()=>{var e=r.success,a=e.externalId,l=e.type,n=e.peerJid,t=e.payload;return S(a,n,l),(0,c.g)({peerJid:n,payload:t}).then(()=>{})});var a=r.success,l=a.externalId,n=a.type;return S(l,a.peerJid,n),Promise.resolve()})(e);throw new Error("unexpected call stanza tag "+r)}function S(e,r,a){(0,h.a)((0,t.w)("ack",{id:(0,t.b)(e),to:(0,t.g)(r),from:(0,t.g)(m.t.get()),class:"receipt",type:(0,t.i)(a)}))}}}]);