"use strict";(self.webpackJsonp=self.webpackJsonp||[]).push([[54],{623:function(e,i,r){r.r(i);var s=r(114),n=r(22),t=r(67),a=r(4),o=r(39),c=r(16),l=r(523),u=r(191),h=r(177),v=new s.b("incomingBusinessNotification",e=>{e.assertTag("notification");var i=e.mapChildren(e=>{var i=e.tag();switch(i){case"verified_name":return e.hasAttr("hash")?{type:"changeForHash",hash:e.attrString("hash")}:{type:"change",jid:e.attrPhoneUserJid("jid"),serial:e.attrLongInt("serial"),verifiedLevel:e.attrEnum("verified_level",u.VLEVEL_TYPES),blob:e.hasContent()?e.contentBytes():void 0,bsp:(0,u.getBspInfo)(e)};case"remove":return e.hasAttr("hash")?{type:"removeForHash",hash:e.attrString("hash")}:{type:"remove",jid:e.attrPhoneUserJid("jid")};default:return __LOG__(4)`Unrecognized business action ${i}`,null}}).filter(Boolean);return{externalId:e.attrString("id"),from:e.attrFromPhoneJid(),actions:i}});i.default=(0,s.c)("handleBusinessNotification",v,e=>Promise.all(e.actions.map(e=>(function(e,i){if(!i)return Promise.resolve(!1);var r=null;if("change"===i.type||"remove"===i.type)r=Promise.resolve([i.jid]);else{i.type;var s=i.hash;r=(0,l.a)(s)}return r.then(e=>{if(e.length<1)return!0;switch(i.type){case"remove":return Promise.all(e.map(e=>(0,n.zc)(e))).then(()=>!1);case"change":return Promise.all(e.map(e=>(0,t.b)(e).then(r=>{var s=null==r?void 0:r.verifiedInfo;if(!s||s.serial!==i.serial)return i.blob?(0,u.verifyUserCert)(e,i.verifiedLevel,i.blob,i.bsp):(0,o.b)().waitUntilPersisted(c.e.validateBusinessCertificate(e));if((0,h.d)(r,i.serial,i.verifiedLevel,i.bsp)){if(i.bsp&&s.bsp&&i.bsp.ts<s.bsp.ts)return void __LOG__(2)`Received business notification with old bsp ts`;var t=s.isApi?Object.assign({},s,{level:i.verifiedLevel,bsp:i.bsp}):Object.assign({},s,{level:i.verifiedLevel});return(0,n.Oc)(e,t)}}))).then(()=>!1);case"removeForHash":case"changeForHash":return Promise.all(e.map(e=>(0,o.b)().waitUntilPersisted(c.e.validateBusinessCertificate(e)))).then(()=>!1);default:return __LOG__(4)`Unimplemented action ${i}`,!1}})})(0,e))).then(i=>(0,a.w)("ack",{to:(0,a.m)(e.from),id:(0,a.b)(e.externalId),class:"notification",type:"business"},i.some(Boolean)?(0,a.w)("user",{side_list:"out"}):null)))}}]);